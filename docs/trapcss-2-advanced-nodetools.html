<!doctype html>
<html class="no-js b-Op" lang="en">
  <head>
    <meta charset="utf-8">
    <title>TrapCSS 2: Advanced NodeTools</title>
    <meta content="https://art-deco.github.io/nodetools/trapcss-2-advanced-nodetools.html" property="og:url">
    <meta content="TrapCSS 2: Advanced NodeTools" property="og:title">
    <meta content="website" property="og:type">
    <meta content="https://art-deco.github.io/nodetools/pages/trapcss2/img/trapcss2.jpg" property="og:image">
    <meta
      content="A continuation of NodeTools tutorial that describes how to create Node.JS binary, compile it and library with Closure Compiler and generate Wiki pages." name="description">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link sizes="57x57" rel="apple-touch-icon" href="/nodetools/img/fav-57.png">
    <link sizes="76x76" rel="apple-touch-icon" href="/nodetools/img/fav-76.png">
    <link sizes="120x120" rel="apple-touch-icon" href="/nodetools/img/fav-120.png">
    <link sizes="152x152" rel="apple-touch-icon" href="/nodetools/img/fav-152.png">
    <link sizes="167x167" rel="apple-touch-icon" href="/nodetools/img/fav-167.png">
    <link sizes="180x180" rel="apple-touch-icon" href="/nodetools/img/fav-180.png">
    <link sizes="192x192" rel="icon" href="/nodetools/img/fav-192.png">
    <link sizes="128x128" rel="icon" href="/nodetools/img/fav-128.png">
    <link sizes="32x32" rel="icon" href="/nodetools/img/fav-32.png">
    <link
      href="https://fonts.googleapis.com/css?display=swap&amp;family=Ruda%3A400%2C700%7CMr%20De%20Haviland" rel="preload" as="fetch" crossOrigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin>
    <link href="https://fonts.googleapis.com/css?family=Source%20Code%20Pro%3A400%2C700" rel="preload"
      as="style">
    <script>
      (function(b){var a=document.createElement("link");a.href=b;a.rel="stylesheet";a.crossOrigin="crossorigin";document.head.appendChild(a)})('https://fonts.googleapis.com/css?family=Source%20Code%20Pro%3A400%2C700')
    </script>
    <style id="cpt">
      
        h1 { font-family: 'Mr De Haviland' }
    
      @font-face {
        font-family: 'Mr De Haviland';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: local('Mr De Haviland Regular'), local('MrDeHaviland-Regular'), url('data:application/font-woff2;base64,d09GMgABAAAAAAqsAA4AAAAAEPwAAApZAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGhYbgXwcKgZgAIEUEQgKlGyRHAsqAAE2AiQDUAQgBYROByAbCw4jUpN+SKaO1IU/f/79fPCd2pNTtFt2kTMCdqodMEt3LN2xYcTJiDMA1qpD+EP0AN38v3TdtYsaWpOTryY1ye1BYl+AiNfjm03yAfhEVVJRnUujYgc57/j7lW6U7oJFCS/Ymv2oebMRQVXXCXqABxIWHXwkB0pHfOtwUqxcVNjWmZ68FwRAFkzCAFFYuLoIYKIR3WGMHD3RQc7dNzx8Lwsi5Rmhqei465YH70XGjl2kUmAMIQOw/qXHZWEwRmI8puJa3Iw78TRexttYgjUgyGIJAxG9fQZMWMhGDnKR5/PINLwNgki44zHcgccbmIRs5CMX6SDIDL/8+HrlSEE2CpATfo88FKEQ+TAW8oJuA1nhVygg1Z6FemSjiiO5kBvlYhSiBNrN8HdY4U9Qr0IuqqLt2oyotnTSdHMDP5C3kQoYuw0B7tc3HeQTdMff9wRRYEAL9044PWBGbKSDoaitL4jc9f9oVovcRXbWJqER+MDohLXvMgt5BGxEgiTlS9+ASuQhgizUojv6YxhGYDIc3IBbcDfux0N4lOKUB/IZ8psM9+LBV4RfhOfDE+Gh8GCYDLeEiTAeLg4XhQvD+QRmNaWgSsIQuUJpy6OyBl3EjaS88YE2i0lmkgpsBnIbJMicEkP/caMyM3vlZqal9Bgx1Mqoye3cWJWZGS0ze5QVZPTOaJ9em55RcxdTgnCtLXmGqf3qtEomVFR1dMEsuV330fIyM5tPmsLp6ZqCcHppii4p0bpDB024UGBSDwmkTgh/TtySUAnhz4lbEo4o9nmJpmfb+DlLxtZrPURby8GUUkqV6gFBID2WdFSlxS+fU9/Wiv0qetNHhJtC7Vb7VXRjbHlrmymS7PKk9XTN0BOj2mJm3dybJJhSgQhqTVcUtCnaQinCIa0teJS4+01M6g4dPGYrU3BNqe3e7Aq++pB+pRNM6h6BDBb/VUZu/b7jBPS7IXI5s9+/7VqSzjk57gS7DFa6/X5HotHnJau/EGvc8GaVziW8LSnzsVPSg0239FTqYWZJeko3IHksODs2KHXXG3HJEsfNGymOlpoGlmS2SolBX8WY877jLoPRH31UHJS0UEE8YZ5b89w+ywNbgyjVCS9xVRzsw3bTXVNaPGafTpQkiybve4P3K5ZsobOytiTBkh+yklDC1dlg71+VJEVH65snjYVdDitqZVRimSmK/Tg3wTgLTGSA9isjeFMxYrKk0ddl3mx6odvmfO8K+7Qm8Q7akmzDftuTWgfRcKJK61eT3SnlwE17ops4giZMM3HaFHyET/gly08ZasmWQLLWQDI7GV3bax/hq0SSFa12ZlEqDtlGtf/tpljB90nPVN0Ek6dSOz1Rdcymq35EdRc3OtEVxXpEUBIsB1szk6r3Px1FXcFLds3YFt31B24FS+4H8wJ4zV2r+Yrm85T1Ws3FbrrbFLwk3sGPowuxga7r2t7KopVMCa77+DsXH2eb7+LFrR1Wc1PsZrRR/beyS8IJtLY8lhS+SJ7eraKuIJoQ/yGr2h3zapd2t1y9ZMiUzsvH1g29GBtx/L6xfbdM7P/B1BFpdkp6Onl1qBW7OufekcWNlj1thntbaZ/n0/LyqiaPOto6Y8DfPu3Lbu3Ve9CwbkPXbnu4R90VN7TrfYuJpR8e8+RuIBaSOEzbWU/uBmIhicMEfFHugBSk51j6pt5AC1LEobnGqp09S5TWqXF2n+tuHoEtAousQWzSD+yPx59pVRMr8ZJFiHfyKyXE9jXMSSRYRZjVNQ3/zNj2+pGSjjBMUYPmtHUJVb4feAWt1es05SlSvdaSMXQzKvCv2ZsusOzZ9f5H9wHHayGEmqefKdMv3pKVuKNv4sz66RplS5ale8+2MZGKCPP6ozoIjJcWp6C1Ul+/iNm9des1MXmhwwpHZdNw5Fr70skxGxKBRh7Jw+7tdGIQx9hcuSC85099s67pypN5F+8wGUJi2iLTBNmScHt02sH89p4gxdb5VX/bQH6IKQatDYsYjPVNLO/JXqtPyi9O6iBrCjQFYdnlIouVWIN4fb0O3LjjI5G15iaJ6pam57gla8KLNCztCRNNb6cXRzAyl7VB4dfpkiTxKmpeQ7O1xSvQ6qua1Hw8Po+qpQcY9o5Wjky1mcrhtGZfCWvkxEFMcnt9h7tYk1Kqdkks+phG3qjvz1ELmCzvmgqyjV2YANzZZtrFhEzu7t7AEOajeU5uZqHEr+dkFRq9EY8FMSL03tyz6oDG9h0NQLw9GmcbPloSOTbvXzq8QbleRsu+PQ443AESvWkIlebZUeRN8y8pwU6H8Z/IJA+7t9OJQRxjc+UCgYu20uqu4GtX9ag8RLRWYFToLA7AIA60Wh6k9gsb34OKeJTRQAaEC58zHqaQRbVlbp7e/EfAlvwag4BIIWCRBWx/FRlMsqWLA2YOmSFV29pLQdB0yOMkvEQIgfSCxsrNvKi84gU3li6m0oUJsVc4LpWVgLJIJ3CbkqYWM0j3jmBBFmcqI6jQwKJ6gj9IJXoO3zxkFiUHYBAH2m8qR4FtQWHmyT93H5cxhf6Tj6xYc9TNRXzHw+7tdGIQx9hc7E8C4tY/qf0k3TbD4RjcAMT7v4vTEqiCN9VeADFKlqC5D24nE9AcMhxg93Y6MYhjbK7cjcfdoMNc78+FQFFiO4SdzUV3EGHgke2lH7L1LMctebWG5nlSrLcE2hH3BgmJWFFnBuF1A6rUi/W+3HshPW6+36Qxf3kwaMLOc0DHMrM030c+2mIBhaIz8Mg40Dq3Amb9Y7T48sWBO9KnZWYsG7dTweBkvZeNFJStjdk8Y2wKCZ+vOb4JK0mB8Vf/b0ue0JJxSWKDQSMAWsKIkGQs7koEanBl8bxifqeypHeEYLfA7u10YhDH2Fy5QMC+EnQRGo6o4bax9i0LcW0BdHV/k/GQpO+fOIrEpueR+YOyBZsl1vmd6ZaU0Gx5SsC5THjHYR/lBg/BBYE9e/Y7WLokB+F0aI2m21zzz7cYxsptwxpCH7kVuGU5GU6n61tvzbEzHOvr3MKBZZh3zYXiKesQQGD+tbjeIaf879Z2+iuA67+8TgFc/+V1yrxtVhrb9YWANRoAAvpER2zDhoV5+/9FY7sTpHfnsOzwAZq9ms9DojVdnZQb7Mc0GzVLrqgJYqNSJUl94on6Im7qMc/UY86pDzJa/eeO+is+5l2+q39cUm+5q767c5kdWLlJM0yT1oxxj+KGDQCXe9whIfgjB1YNR55YdTr5ZDWIl0qrBb4yw2pJtGx6riPpcoIypjKN+cxgPGMZxyyCiWYkMc7j4ckkk0kwJUxiNBMYjjAKt5tKMM0MZzaTXv39mcxmFLMYzzSmMpPii8ckMpKpTCaGeByYy3hmMY5gWhkNZLRTWmA0ozhUcpxCob2R4UxmNJZDaWAGYPkJVEN9DuOZRGUODxjrOJbkSsOZEQlBQy7M2sZywbg4N3Hm7RPsjGhqJuOjWA0mhUQLymRGT6udJTAZtP0sppFLEknMZGTGwTTNJDFj9fhJJDKVGYwliSYqqf+LoHurqZOkMgU=') format('woff2');
      }
      
    </style>
    <script>
      (function(){var b=/url\('([\s\S]+?)'\)/.exec(document.head.querySelector("#cpt").textContent);if(b){var a=document.createElement("link");a.rel="preload";a.as="font";a.href=b[1];document.head.appendChild(a)}})()
    </script>
    <script>(function(h,r){var a=Object.keys(h),c=!0;"CSS"in window&&"supports"in CSS?(a=a.reduce(function(k,b){var l=h[b];b=b.split("|");for(var m=!1,d={},f=0;f<b.length;d={a:d.a},f++)if(d.a=b[f],l.map(function(n){return function(e){e=e.split("|");for(var p=!1,g=0;g<e.length;g++){var q=e[g];if(CSS.supports(n.a,q)){p=!0;break}else k.push(n.a+": "+q)}return p}}(d)).filter(Boolean).length==l.length){m=!0;break}m||(c=!1);return k},[]),a.length?c&&console.log("\ud83d\udcbf Browser does not support CSS properties: %s",
a.join("\n "),"but supports alternatives."):console.log("\ud83d\udcbd Browser supports all modern CSS properties.")):(c=!1,console.log("\ud83d\udce0 Browser does not support CSS checks."));c||(a=document.createElement("link"),a.rel="stylesheet",a.href=r,document.head.appendChild(a))})({"align-self":["center"],"flex-grow|-ms-flex-positive":["1"],"flex|-ms-flex":["0 0 25%"],"display":["flex|-ms-flexbox"],"box-sizing":["border-box"],"order|-ms-flex-order":["1"],"transition":["none"],"flex-direction|-ms-flex-direction":["column"],"border-radius":["2px"],"box-shadow":["none"],"flex-basis|-ms-flex-preferred-size":["0"],"justify-content":["center"],"flex-wrap|-ms-flex-wrap":["wrap"],"flex-shrink|-ms-flex-negative":["0"],"position":["sticky|-webkit-sticky"],"align-items":["center"],"hyphens|-webkit-hyphens|-moz-hyphens|-ms-hyphens":["auto"]}, '/nodetools/css/combined-prefixes.css')</script>
    <script>
      (function(q,k){function x(a){for(var f=/url\((.+?)\).*?;\s+unicode-range: (.+?);/g,b={},d=[],h;h=f.exec(a);){var r=h[2];d.push({url:h[1],a:r});b[r]=1}b=Object.keys(b).reduce(function(c,e){var g=e.split(/,\s/).map(function(l){return l.replace("U+","\\u").replace("-","-\\u")}).join("").toLowerCase();c[e]=new RegExp("["+g+"]");return c},{});var t=document.body?document.body.textContent:"",y=t?Object.keys(b).reduce(function(c,e){b[e].test(t)&&(c[e]=!0);return c},{}):Object.keys(b).reduce(function(c,
      e){e in k&&(c[e]=!0);return c},{});m=d.filter(function(c){return c.a in y}).map(function(c){return c.url});if(!m.length)return u();var v=document.createDocumentFragment();m.forEach(function(c,e){var g=document.createElement("link");g.href=c;g.rel="preload";g.as="font";var l=e+1;;g.onload=function(){return u(l)};g.setAttribute("crossorigin",!0);v.appendChild(g)});document.head.appendChild(v)}k=void 0===k?{}:k;var n=document.createElement("link");if(function(a,
      f){if(!a||!a.supports)return!1;try{return a.supports(f)}catch(b){return!1}}(n.relList,"preload")){var z=function(a,f,b){b=void 0===b?"":b;;var d=new XMLHttpRequest;d.onreadystatechange=function(){4==d.readyState&&(200==d.status?(f(d.responseText)):console.error("Error loading webfont: server responded with code %s at %s",d.status,a))};d.open("GET",a);try{d.send(null)}catch(h){console.error(h)}};
      ;var p;(function(a,f){z(a.href,function(b){p=b;x(p)},"-"+(void 0===f?"link":f))})({href:q},"js");var m=[],w=0,u=function(a){w++;w>=m.length&&(a=document.createElement("style"),a.innerHTML=p,document.head.appendChild(a))}}else n.rel="stylesheet",n.href=q,document.head.appendChild(n)})('https://fonts.googleapis.com/css?display=swap&family=Ruda%3A400%2C700%7CMr%20De%20Haviland', {"U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD":true})
    </script>
    <link rel="stylesheet" href="/nodetools/css/combined.css">
    <link rel="preload" as="style" href="/nodetools/highlight.js/styles/default.css">
    <style>
      .no-js [data-io], .no-js [data-loading], .no-js .ImageHolder { display: none!important }
      .ItWillRunYarn {
          display: none;
        }
        .yarn .ItWillRunYarn {
          display: inline;
        }
        .yarn .ItWillRunNpm {
          display: none;
        }
      .List {
                          font-size:small;
                        }
                        .List > a {
                          display: block!important;
                        }
    </style>
    <noscript>
      <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?display=swap&amp;family=Mr%20De%20Haviland&amp;text=TrapCSS2%3A%20Advanced%20NodeTools">
      <link rel="stylesheet" href="/nodetools/css/combined-prefixes.css">
      <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?display=swap&amp;family=Ruda%3A400%2C700%7CMr%20De%20Haviland">
      <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Source%20Code%20Pro%3A400%2C700">
    </noscript>
    <script defer src="/nodetools/js/polyfill/intersection-observer.js"></script>
    <script defer src="/nodetools/js/images.js"></script>
    <script crossorigin data-src="/nodetools/preact/dist/preact.min.js"></script>
    <script crossorigin data-src="/nodetools/comps/common.js"></script>
    <script crossorigin data-src="/nodetools/comps/trapcss2.js"></script>
    <script>
      document.documentElement.classList.remove("no-js")
    </script>
  </head>
  <body class="b-Mk b-Ol b-Op">
    
    <main class="b-Xl" role="main">
      <div class="b-z">
        <div class="b-B">
          <div class="left-column b-hb">
            <div class="b-kC">
            
                <a title="NodeTools Node.JS Stack" href="/nodetools/">
                  <img class="ImageHolder b-t b-vk" sizes="(max-width: 575.8px) 100vw,(max-width: 767.8px) 510px,(max-width: 991.8px) 150px,(max-width: 1199.8px) 210px,255px" alt="NodeTools logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='400'/%3E">
                  <noscript>
                    <picture>
                      <source srcset="/nodetools/img/splash-576.webp 576w,/nodetools/img/splash-319.webp 319w,/nodetools/img/splash-600.webp 600w"
                        sizes="(max-width: 575.8px) 100vw,(max-width: 767.8px) 510px,(max-width: 991.8px) 150px,(max-width: 1199.8px) 210px,255px" type="image/webp">
                      <img class="b-t b-vk" onLoad="webploaded(this)" alt="NodeTools logo" src="/nodetools/img/splash-576.jpg" srcset="/nodetools/img/splash-576.jpg 576w,/nodetools/img/splash-319.jpg 319w,/nodetools/img/splash-600.jpg 600w" sizes="(max-width: 575.8px) 100vw,(max-width: 767.8px) 510px,(max-width: 991.8px) 150px,(max-width: 1199.8px) 210px,255px">
                    </picture>
                  </noscript></a>
              </div>
              <div class="b-kC">
                <a title="The NodeTools Stack Website." class="GitHubBadge" id="cacd9"
                  href="https://github.com/art-deco/nodetools">
                  <span class="a">GitHub</span><span class="b" data-stargazers>⭐️ 1</span></a>
                
                
                
              </div>
              <h3 id="pages">Pages</h3>
              <ul id="PagesMenu">
                <li class><a data-file="index" href="/nodetools/">NodeTools: Node.JS Stack</a></li>
                <li class>
                  <a data-file="quick-start" href="/nodetools/quick-start-to-nodetools.html">Quick Start To NodeTools</a>
                </li>
                <li class>
                  <a data-file="trapcss" href="/nodetools/trapcss-nodetools-tutorial.html">TrapCSS: NodeTools Tutorial</a>
                </li>
                <li class="Active">
                  <a data-file="trapcss2" href="/nodetools/trapcss-2-advanced-nodetools.html">
                    TrapCSS 2: Advanced NodeTools</a>
                </li>
                <li class>
                  <a data-file="web" href="/nodetools/web-development-with-nodetools.html">
                    Web Development With NodeTools</a>
                </li>
                <li class>
                  <a data-file="babel" href="/nodetools/babel-when-open-source-is-not-free-sofware.html">
                    Babel: When Open Source Is Not Free Sofware</a>
                </li>
                <li class>
                  <a data-file="discussion" href="/nodetools/discussion-for-nodetools.html">Discussion for NodeTools</a>
                </li>
              </ul>
              <h3 id="stack">Stack</h3>
              <div class="List b-xq b-kC">
                <a
                  title="Create Packages From GitHub Templates. My New Package is an installer of new packages via GitHub templates: create a template and add an automated script to CLI questions, update files, access GitHub API and spawn commands during generation." class="NPMBadge" href="https://www.npmjs.com/package/mnp">
                  <span class="a"><em>MNP</em></span><span class="b">1.1.7</span></a>
                <a
                  title="Organises TypeDefs By Placing Them Into Types.Xml File To Be Embedded Into Source Code Compatible With VSCode And Google Closure Compiler, Generates Externs And Allows To Place Documentation In README Markdown." class="NPMBadge" href="https://www.npmjs.com/package/typal">
                  <span class="a"><em>Typal</em></span><span class="b">1.26.2</span></a>
                <a
                  title="Proper Node.JS Package Compiler (And Front-End Code Bundler) With Closure Compiler. Can create a single executable JS file and merge and optimise all dependencies." class="NPMBadge" href="https://www.npmjs.com/package/depack">
                  <span class="a"><em>Depack</em></span><span class="b">1.1.1</span></a>
                <a
                  title="A Regex-Based Transpiler Of Source Code To Allow Writing Import And Export Statements And JSX With 0 Dependencies." class="NPMBadge" href="https://www.npmjs.com/package/alamode">
                  <span class="a"><em>ÀLaMode</em></span><span class="b">3.5.0</span></a>
                <a
                  title="The 2020 Most Modern Testing Framework For Node.JS With Test Contexts (Reusable BeforeEach / AfterEach Via Separate Files); Masks (Inputs/Outputs In Non-Js Files) And Fork Testing; Interactive Snapshots." class="NPMBadge" href="https://www.npmjs.com/package/zoroaster">
                  <span class="a"><em>Zoroaster</em></span><span class="b">4.3.0</span></a>
                <a
                  title="Documentation Compiler To Generate The Table Of Contents, Embed Examples With Their Output, Make Markdown Tables, Maintain Typedefs For JavaScript And README, Watch Changes To Push, Use Macros And Prettify API Titles." class="NPMBadge" href="https://www.npmjs.com/package/documentary">
                  <span class="a"><em>Documentary</em></span><span class="b">1.37.0</span></a>
              </div>
              <h3 id="web-software">Web Software</h3>
              <div class="List b-xq b-kC">
                <a
                  title="2-Dependency Koa Web Server Compiled With Closure Compiler And Bundled With Essential Middleware: Static, Compress, Session, Cors, File Upload, Router And JSX Front End." class="NPMBadge" href="https://www.npmjs.com/package/@idio/idio">
                  <span class="a"><em>Idio</em></span><span class="b">1.2.3</span></a>
                <a
                  title="Static Web Site Compiler That Uses Closure Compiler For JS Bundling And Closure Stylesheets For CSS optimisations. Supports JSX Syntax To Write Static Elements And Dynamic Preact Components." class="NPMBadge" href="https://www.npmjs.com/package/splendid">
                  <span class="a"><em>Splendid</em></span><span class="b">1.17.1</span></a>
              </div>
              <h3 id="misc">Misc</h3>
              <ul>
                <li><a href="https://gitter.im/node_tools/community">Join In Gitter Chat</a></li>
                <li><a href="https://opencollective.com/nodetools">Fund Via Open Collective</a></li>
                <li><a href="https://twitter.com/nodetools">Follow On Twitter</a></li>
              </ul>
              <div class="SideBarMenu sidebarshowing b-jr b-zp">
                <div class="a">
                  
                                  <h3 id="on-this-page">On This Page</h3>
                                  <ul class="OnThisPage">
                                    <li data-heading="trapcss-2"><a href="#trapcss-2">TrapCSS 2</a></li>
                                    <li data-heading="welcome-closure">
                                      <a href="#welcome-closure">Welcome Closure</a>
                                      <ul><li data-heading="installation"><a href="#installation">Installation</a></li><li data-heading="advantages"><a href="#advantages">Advantages</a></li><li data-heading="web-bundling"><a href="#web-bundling">Web Bundling</a></li></ul>
                                    </li>
                                    <li data-heading="compiling-libraries">
                                      <a href="#compiling-libraries">Compiling Libraries</a>
                                      <ul><li data-heading="templates"><a href="#templates">Templates</a></li><li data-heading="running-compiler"><a href="#running-compiler">Running Compiler</a></li></ul>
                                    </li>
                                    <li data-heading="binary-executable">
                                      <a href="#binary-executable">Binary Executable</a>
                                      <ul><li data-heading="cli-arguments"><a href="#cli-arguments">CLI Arguments</a></li><li data-heading="implementation"><a href="#implementation">Implementation</a></li><li data-heading="fork-testing"><a href="#fork-testing">Fork Testing</a></li><li data-heading="bin-compile"><a href="#bin-compile">Bin Compile</a></li><li data-heading="cli-documentation"><a href="#cli-documentation">CLI Documentation</a></li></ul>
                                    </li>
                                    <li data-heading="wiki">
                                      <a href="#wiki">Wiki</a>
                                      <ul>
                                        <li data-heading="features"><a href="#features">Features</a></li>
                                        <li data-heading="performance"><a href="#performance">Performance</a></li>
                                        <li data-heading="javascript-execution"><a href="#javascript-execution">JavaScript Execution</a></li>
                                        <li data-heading="accumulating-whitelist">
                                          <a href="#accumulating-whitelist">Accumulating Whitelist</a>
                                        </li>
                                        <li data-heading="special--escaped-sequences">
                                          <a href="#special--escaped-sequences">Special / Escaped Sequences</a>
                                        </li>
                                        <li data-heading="caveats--acknowledgements">
                                          <a href="#caveats--acknowledgements">Caveats & Acknowledgements</a>
                                        </li>
                                      </ul>
                                    </li>
                                    <li data-heading="license"><a href="#license">License</a></li>
                                    <li data-heading="stdlib"><a href="#stdlib">StdLib</a></li>
                                    <li data-heading="comments"><a href="#comments">Comments</a></li>
                                  </ul>
                                  <h3 id="share-nodetools">Share NodeTools</h3>
                                  <span class="b-xq b-Hk" id="ce0df"><span class="b-Hk" style="height:32px" data-loading>Loading sharing buttons...</span><noscript>Please enable JavaScript to Share</noscript></span>
                                  
                                  <div class="b-xq" data-loading id="updates-div">Loading web-push...</div>
                                  <details id="NewsletterDetails" data-loading>
                                    <summary>
                                      <h3 id="newsletter">Newsletter</h3>
                                    </summary>
                                    <div id="emails-div">Loading widget...</div>
                                  </details>
                                  <div class="b-jq" data-loading>
                                    <h3 class="b-Gk" id="package-manager">Package Manager</h3>
                                    <form class="b-Gk" id="ca13e">
                                      <select><option value="yarn">yarn</option><option selected value="npm">npm</option></select>
                                    </form>
                                  </div>
                                
                </div>
                <a data-loading id="HideMenu" style="color:grey!important;" href="#">hide menu</a>
                <a data-loading id="ShowMenu" style="color:grey!important;" href="#">show menu</a>
              </div>
          </div>
          
          <div class="right-column b-xq b-nb" id="Content">
            
            
            <div data-section id="trapcss-2">
            <h1>TrapCSS2: Advanced NodeTools</h1>
            
            <p>In the previous part, we looked at the first steps in creating a new package with <em>NodeTools</em> stack. During the initialisation process with <span class="tm">mnp</span>, we were asked some questions like if we wanted to compile the package, if a binary should be added and whether <em>GitHub</em> wiki should be created. We answered yes to all three questions, so let's get on with the second part of the tutorial.</p>
            
            <p>
              <img class="ImageHolder b-vk b-t" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px" alt="trapcss2: advanced nodetools tutorial (car splash)" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1000' height='668'/%3E">
              <noscript>
                <picture>
                  <source
                    srcset="/nodetools/pages/trapcss2/img/trapcss2-768.webp 768w,/nodetools/pages/trapcss2/img/trapcss2-576.webp 576w,/nodetools/pages/trapcss2/img/trapcss2-319.webp 319w,/nodetools/pages/trapcss2/img/trapcss2-1000.webp 1000w" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px"
                    type="image/webp">
                  <img class="b-vk b-t" onLoad="webploaded(this)" alt="trapcss2: advanced nodetools tutorial (car splash)" src="/nodetools/pages/trapcss2/img/trapcss2-768.jpg" srcset="/nodetools/pages/trapcss2/img/trapcss2-768.jpg 768w,/nodetools/pages/trapcss2/img/trapcss2-576.jpg 576w,/nodetools/pages/trapcss2/img/trapcss2-319.jpg 319w,/nodetools/pages/trapcss2/img/trapcss2-1000.jpg 1000w" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px">
                </picture>
              </noscript>
            </p>
            
            <p>At the end, we'll also look how to incorporate <em>TrapCSS</em> into another package with <em>StdLib</em> strategy: we'll compile a file called <strong>stdlib.js</strong> for a static website generator <em>Splendid</em> that will statically link to <span class="tm">trapcss</span>, meaning that they will be distributed together. This will allow to reduce the total number of dependencies in the target package and make it more appealing to users.</p>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='15'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/0.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="welcome-closure">
            <h2>Welcome Closure</h2>
            
            <p>Prior to <em>NodeTools</em>, the industry standard was to simply transpile source code with <em>Babel</em>, or not use modules at all and avoid transpilation step altogether. The first option is not good because <em>Babel</em> is a package with 250+ dependencies that jam our <span class="tm2">node_modules</span>, and also because for years it's been disparaging professional software engineering values that are in core of <em>NodeTools</em>, such as respect for <em>JSDoc</em>, as can be read in the <a href="/nodetools/babel-when-open-source-is-not-free-sofware.html">
               Babel: When Open Source Is Not Free Sofware</a> article. The second option is not applicable either as I believe in embracing innovation and keeping up with the newest technological advances to be able to be productive and remain competent and competitive.</p>
            
            <p>Because <span class="tm">NearForm</span>, the <a href="https://www.nearform.com/community/">largest contributor</a> to Node.JS with labour resource of over 100 people, extorted back-end engineers into using <em>Babel</em> by not implementing ECMA modules since 2015, the actual state of art of modern package making is pretty sad. Those working on <em>Babel</em> took the advantage of that forced downloads count to call their buggy product a compiler, which is not true. It's popular only because people had no choice rather because it's exceptional in any way. A compiler is a sophisticated piece of software so there must be something special about a program to be called this name (rather than a transpiler). <em>Closure Compiler</em> is software that will check types and perform advanced passes like peep-hole optimisation and function call folding, therefore it really deserves this title.</p>
            
            <p>Up until <em>NodeTools</em>, there were 4 ways to create <strong>Node.JS</strong> packages:</p>
            
            <ol>
              <li><strong>old-school</strong>, by keeping <span class="tm">module.exports</span> and not taking advantage of modules' syntax which is one of the best features of JavaScript;</li>
              <li><strong>alternative</strong>, that included an additional bundle up step, with such software as rollup and webpack;</li>
              <li><strong>TypeScript</strong>, which is a corporate paradigm that has swept the world due to the lack of professional tools that could compete with it to provide good routines for working with types;</li>
              <li><strong>Babel</strong>, the mass-mentality industry pattern that has no respect for its users, whose authors self-proclaimed themselves leaders of the sector while failing miserably to meet essential requirements for a transpiler.</li>
            </ol>
            
            <p><em>NodeTools</em> is a new, <strong>indie</strong> replacement to all these methods that allows to leave them behind and focus on JS coding. We provide the most light-weight, pure <em>JavaScript</em> solution that would allow to develop professional packages and keep independent from 3rd party software that dictates how you should work and what <em>your</em> code should look like. The developer and her freedom is our top priority. For example, there's literally no config for compiling you packages, and all annotations are based on the open JSDoc standard. You can still choose the language output (such as ECMA2015-2019) and control other options like pretty printing via CLI arguments. <em>NodeTools</em> is the only methodology that starts to use <em>Closure Compiler</em> for packages, and it takes Node.JS software development to the next level.</p>
            
            <div data-section id="installation">
            <h3>Installation</h3>
            
            <p><em>Closure Compiler</em> is developed by Google. It's used for mission-critical internal projects, that are not based on TypeScript. It's a Java program of the size of 10MB that can be installed once on the system, and using advanced optimisations, can put the source code, as well as all liked dependencies into a single executable file. In other words, it provides static linking for libraries into our generated code. Type checking now becomes the final stage of the development process that provides insight into small inaccuracies in our types, instead of forcing us to think in terms of types, like in <em>TypeScript</em>.</p>
            
            <p>To use the compiler, you'll need Java on your machine. If you're working on Windows, you can just install it from the official website and it'll be working fine. On a Mac, I had to add the following line to my <span class="tm2">~/.bash_profile</span>.</p>
            
            <pre id="c414d"><code class="bash hljs">export JAVA_HOME=/Library/Internet\ Plug-Ins\JavaAppletPlugin.plugin/Contents/Home</code></pre>
            
            <p>If you're using <strong>zsh</strong>, also add <span class="tm2">source ~/.bash_profile</span> to your <strong>~/.zshrc</strong>. Then we're going to install <span class="tm">google-closure-compiler-java</span> into the home folder:</p>
            
            <pre id="c414d1"><code class="bash hljs">cd ~
yarn|npm init # we want to save deps in package.json
yarn add google-closure-compiler-java</code></pre>
            
            <p>
            Your distribution will be installed in the <strong>~/node_modules</strong> directory.
            On top of the compiler itself, the actual package that executes the process, is called <em>Depack</em>. It's made possible to compile Node.JS package for the first time, since it wasn't possible before as when trying to compile back-end software with Closure, it would throw errors since it couldn't recognise internal Node API, such as <span class="tm">fs</span>, <span class="tm">stream</span>, <em>etc</em>. <em>Depack</em> fixes this by creating mock folders in your <span class="tm">node_modules</span>,
            such as <strong>node_modules/fs/index.js</strong>,
            <strong>node_modules/fs/package.json</strong> that simply destructure the global API annotated via externs to enable type checking. We've implemented the externs for Node 8 API, which should also work with later versions.
            </p>
            
            <pre id="ccdbf"><code class="javascript hljs">// node_modules/child_process/index.js
/* a mock of child process built-in */

export default child_process
export const {
  ChildProcess,
  exec,
  execFile,
  execFileSync,
  execSync,
  fork,
  spawn,
  spawnSync,
} = child_process</code></pre>
            
            <pre id="ccdbf1"><code class="javascript hljs">// node_modules/child_process/package.json
{
  "name": "child_process",
  "main": "index.js"
}</code></pre>
            
            <p>You can use nightly versions of the compiler, if you want, by looking up the last version with <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span>info</span> <span>google-closure-compiler-java</span></span></span> and setting the exact version, e.g., <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-cmd">i</span><span class="yarn-cmd">add</span> <span>google-closure-compiler-java@20200201.0.0-nightly</span></span></span>. This can help if there are occasional bugs in the compiler, e.g., the January 2020 version has broken destructuring, so you need to use the nightly build like the one I've just mentioned. There's a list of bugs in the compiler in the <a href="https://github.com/dpck/depack/wiki/Bugs"><em>Depack</em> wiki</a>.</p>
            
            <p><em>Closure</em> is written in Java. You can fork <a href="https://github.com/google/closure-compiler">their project</a> and study how it works. There's a lot of useful information on the <a href="https://github.com/google/closure-compiler/wiki">Wiki</a>, especially in the types section. It might seem complex at first, but I managed to fix certain issues with PRs by only studying the source code for a few days. A compiler is based on AST passes, where you can manipulate nodes. There's also a JSDoc parser, and an inner project for JS source map consumption/generation. When you make a change, you build the compiler locally. Then you can set the <span class="tm">GOOGLE_CLOSURE_COMPILER</span> env variable with the path to your target JAR, which will then be used by <em>NodeTools</em>.</p>
            
            
            </div>
            
            <div data-section id="advantages">
            <h3>Advantages</h3>
            
            <p>Some might say that we're still tied up to the compiler, but it's much better than Babel and TypeScript, because:</p>
            
            <ul>
              <li>You don't need to install 250 dependencies just for your modules' syntax via <em>Babel</em>.</li>
              <li>The bin size is 10mb instead of 50mb of <span class="tm">TypeScript</span>.</li>
              <li>You can statically link packages like in proper software engineering.</li>
              <li>Compiler will produce type hints for you that are useful to polish your programs, but don't lock you into a completely different language which TS is.</li>
              <li>It's meant for pure JavaScript development which is great.</li>
              <li>Its advanced optimisation obfuscates code so that you can send it to your clients with a bit more security for your intellectual property.</li>
              <li>You can compile complex back-end applications into a single JS file, for example, we created <a href="https://github.com/idiocc/idio">Idio</a> which is a Koa server with essential middleware that only has 2 dependencies (<span class="tm">mime-db</span> and <span class="tm">text-decoding</span> which are databases for processing encoded data). Without compilation, <span class="tm2">Idio</span> would have to download around 130 external dependencies.</li>
              <li>It's maintained by <em>Google</em> themselves by top-level software engineers who know compiler theory, so you can rely on compilation results.</li>
              <li>You don't have to compile, and simple transpilation is also possible without <em>Closure</em>.</li>
              <li>You can keep the source code of your larger packages non-compiled, but instead compile only its dependencies into a file called <em>StdLib</em>.</li>
            </ul>
            
            <p>Additionally, another reason to learn about compiler and externs, is because the highest paid Software Engineering positions are for <span class="tm2">Clojure</span> language, around $140k per year <a
              href="https://insights.stackoverflow.com/survey/2019#technology-_-what-languages-are-associated-with-the-highest-salaries-worldwide">
              in the US</a>. When you're working on <em>Clojure</em> projects, you'll be writing your front-end in <em>ClojureScript</em>, that produces JavaScript compatible with <em>Closure Compiler</em>, so you'll need to understand how externs work. If you learn it via <em>NodeTools</em> today, you'll be prepared to become one of the highest-paid developers in the world if you decide to specialise in <em>Clojure</em> at some point.</p>
            
            
            </div>
            
            <div data-section id="web-bundling">
            <h3>Web Bundling</h3>
            
            <p><em>NodeTools</em> is a holistic package development methodology. The compiler works together with all other tools, such as Typal, that allows to maintain a single source of truth for your types and generate externs for the compiler, Documentary that can embed and interlink such type information in documentation of packages including wikis, and <em>Zoroaster</em> that provides API to test forks as well as letting you test your target compiled code, instead of only source code, which is an absolute must when taking advantage of the advanced compilation mode.</p>
            
            <p>The primary realm of our stack is Node.JS package development, however with <em>Depack</em> you can also develop and compile <a href="https://github.com/art-deco/akashic.page">web-bundles</a>, as there's also support for JSX syntax in <em>ÀLaMode</em>. It's based on regexes, but we've managed to create many nice widgets for the web with it. We'll be advertising the web stack features later on. We hope that the tools that we provide in only 10 <span class="tm">node_modules</span> folders, will really allow to have a breath of fresh air in this stale-air environment where people adapt to paradigms, instead of using such powerful language as JavaScript to their maximum advantage.</p>
            
            <p>You can read about compiling front-end JavaScript code in the <a href="/nodetools/web-development-with-nodetools.html">Web Development With NodeTools</a> article.</p>
            
            
            </div>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='13'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/1.svg"></noscript></a>
            </p>
            </div>
            
            
            <div data-section id="compiling-libraries">
            <h2>Compiling Libraries</h2>
            
            <p>Let's get down to business. Advanced compilation means that our comments are going to be stripped off the source code, so that all type information is lost. It's possible to preserve all comments, however this is a new feature of the compiler, and will keep ALL comments which might be undesirable. We'll be compiling our API, so the strategy is the following:</p>
            
            <ol>
              <li>to compile the source code into a file that exports API methods,</li>
              <li>to import those API methods from another file that wraps them in JSDoc.</li>
            </ol>
            
            <p>
              <img class="b-t" alt="source compile and entry JS files" data-io>
              <noscript>
                <img class="b-t" alt="source compile and entry JS files" src="/nodetools/pages/trapcss2/1-compile/img/source-compile-entry.gif">
              </noscript>
            </p>
            
            
            <div data-section id="templates">
            <h3>Templates</h3>
            
            <p>The entry point for the compiler is <strong>src/depack.js</strong>, which imports the method from the source code and exports it via CommonJS standard. It also imports externs so that <em>Closure</em> will understand our types:</p>
            
            <pre id="ccdbf23"><code class="javascript hljs">import '../types/externs'
import trapcss from './'

/*!
 * trapcss: Removes unused selectors from CSS files to achieve
 * maximum optimisation. Can be used as an API function or with CLI.
 *
 * Copyright (C) 2020  Art Deco Code Limited
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.
 */

// export default {
module.exports = {
  '_trapcss': trapcss,
}
</code></pre>
            
            <p>This file also includes the APGL license that was selected when the package was bootstrapped. It uses the <span class="tm2">/*!</span> notation to preserve the comment. If you chose MIT license, you'll also have a similar, but shorter notice. For other licenses, you'd have to add a comment manually. Also, for <em>AGPL</em>, we don't include the copyright on top of each file as I believe it's redundant, but feel free to do it your way.</p>
            
            <p>The entry to <em>Depack</em> imports our API, and assigns it to the <span class="tm">modules.export</span> object. This will allow to access those methods (currently, just 1) from the <strong>compile</strong> dir. However, because we ran the <em>ÀLaMode</em> transpiler on the <strong>src</strong> folder, the <span class="tm">module.exports =</span> got renamed into <span class="tm">export default</span>, therefore just manually change it back now.</p>
            
            <p>We'll need to create a second file, called <span class="tm2">template</span> in <strong>compile/template.js</strong>:</p>
            
            <pre id="ccdbf24"><code class="javascript hljs">const { _trapcss } = require('./trapcss')

/**
 * @methodType {_trapcss.trapcss}
 */
function trapcss(config) {
  return _trapcss(config)
}

module.exports = trapcss

/* typal types/index.xml namespace */
</code></pre>
            
            <p>The template file is not meant for execution, but provides a blueprint for generation of our <span class="tm">main</span> file (called main because of the main field in <strong>package.json</strong>). It has the <span class="tm">@methodType {_trapcss.trapcss}</span> annotation, that declares the type of the function, so that its JSDoc can be expanded. It also contains the <span class="tm">typal</span> marker at the bottom, so that we can embed our <em>Config</em> and <em>Return</em> types into the main file as well. To generate the real JavaScript file, we'll need to run the <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>d</span></span></span> command, that will run <span class="tm">template</span> and <span class="tm">d1</span> scripts in series. The template command is the following: <span class="tm2">typal compile/template.js -T compile/index.js -t types/api.xml</span>:</p>
            
            <ul>
              <li><strong>compile/template.js</strong>, is the path to the template file.</li>
              <li><strong>-T compile/index.js</strong>, the path to the main file to be generated.</li>
              <li><strong>-t types/api.xml</strong>, is the path to types that should be used. It could also point to the dir itself, however because we also included arguments.xml for our binary, that doesn't allow us to simply pass <span class="tm">types</span>.</li>
            </ul>
            
            <p>The <span class="tm">d1</span> command expands the typal marker in the <strong>index.js</strong> produced from the template &mdash; <span class="tm2">typal compile/index.js types/index.js -u -t types/index.xml</span>:</p>
            
            <ul>
              <li><strong>compile/index.js types/index.js</strong>, paths to files with <span class="tm2">typal</span> markers that needs embedding typedefs.</li>
              <li><strong>-u</strong>, tells <em>Typal</em> to use namespaces rather than simple type names.</li>
              <li><strong>-t types/index.xml</strong>, the location of types, can be skipped.</li>
            </ul>
            
            <p>After the two commands are run, we'll have a production-ready entry file. Let's have a look at what is being produced as the <span class="tm">main</span>:</p>
            
            <pre id="ccdbf25"><code class="javascript hljs">const { _trapcss } = require('./trapcss')

/**
 * Parses the supplied HTML and CSS and removes
unused selectors. Also removes empty CSS rules.
 * @param {_trapcss.Config} config Options for the program.
 * @param {string} config.html The input HTML.
 * @param {string} config.css The CSS to drop selectors from.
 * @param {boolean} [config.keepAlternate=false] Whether to keep the `@alternate` comment for
 * Closure Stylesheets. Default `false`.
 * @param {(sel: string) =&gt; boolean} [config.shouldDrop] Whether _TrapCSS_ should remove this selector.
 * The `shouldDrop` hook is called for every CSS selector
 * that could not be matched in the html. Return `false`
 * to retain the selector or `true` to drop it.
 * @return {_trapcss.Return}
 */
function trapcss(config) {
  return _trapcss(config)
}

module.exports = trapcss

/* typal types/index.xml namespace */
/**
 * @typedef {_trapcss.Config} Config `＠record` Options for the program.
 * @typedef {Object} _trapcss.Config `＠record` Options for the program.
 * @prop {string} html The input HTML.
 * @prop {string} css The CSS to drop selectors from.
 * @prop {boolean} [keepAlternate=false] Whether to keep the `@alternate` comment for
 * Closure Stylesheets. Default `false`.
 * @prop {(sel: string) =&gt; boolean} [shouldDrop] Whether _TrapCSS_ should remove this selector.
 * The `shouldDrop` hook is called for every CSS selector
 * that could not be matched in the html. Return `false`
 * to retain the selector or `true` to drop it.
 * @typedef {_trapcss.Return} Return `＠record` Return Type.
 * @typedef {Object} _trapcss.Return `＠record` Return Type.
 * @prop {string} css The dropped CSS.
 * @prop {!Set&lt;string&gt;} sels The used selectors.
 */
</code></pre>
            
            <p>The entry file to our package contains an annotated function that wraps a method from the API. Since we decorated it with JSDoc, we'll be able to receive autocompletion hints on the config type when consuming the library from other packages. Our config is declared as a type at the bottom, but the <span class="tm">config</span> property of the function is also expanded into individual <span class="tm2">@param</span>s. This is to increase the visibility of the parameters, which will now appear on the function's description:</p>
            
            <p>
              <img class="b-vk b-t" alt="visibility of the config type for the method" data-io>
              <noscript>
                <img class="b-vk b-t" alt="visibility of the config type for the method" src="/nodetools/pages/trapcss2/1-compile/img/vis.png">
              </noscript>
            </p>
            
            <p>This allows people to read the full description of the argument, without having to go through each individual property when expanding the config. Without this feature, the description doesn't give the full picture:</p>
            
            <p>
              <img class="b-vk b-t" alt="limited visibility of the config type" data-io>
              <noscript>
                <img class="b-vk b-t" alt="limited visibility of the config type" src="/nodetools/pages/trapcss2/1-compile/img/vis2.png">
              </noscript>
            </p>
            
            <p>All typedefs should be embedded into the main file, which acts as a repository for types. This will make sure that types are always available. Do you remember how we imported the config type from <strong>types/index.js</strong> in the previous part?</p>
            
            <pre id="ccdbf2"><code class="javascript hljs">/**
 * @typedef {import('..').Config} _trapcss.Config
 * @typedef {import('..').Return} _trapcss.Return
 */</code></pre>
            
            <p>This is because the main file is treated as the go-to place for types. Using templates allows to treat source code independent from the API specification, and plug in the implementation into JSDoc-annotated shells for code. It's kind of similar to TypeScript that provides <span class="tm">.d.ts</span> types, however in pure JavaScript. If you're exporting a class, you can also use the <span class="tm">@constructor</span> tag in the template, to generate a class shell.</p>
            
            <pre id="ccdbf3"><code class="javascript hljs">const { _Cl } = require('./depack')

/** @constructor {_ns.MyClass} */
class MyClass extends _Cl {}</code></pre>
            
            <p>The body of the class will then be generated, however there's no annotations for properties, only member methods. For example, <span class="tm2">@goa/router</span> <a href="https://github.com/idiocc/goa-router/blob/master/compile/index.js">uses</a> this method. <a
              href="https://github.com/idiocc/koa/blob/b6a2ebed556006675a35c1dcf7ee28aacdc3271c/compile/index.js#L7">
              Another way</a> to template classes, is to include a typedef of a class in a file, and then use <span class="tm">typeof</span> operator when proxying the type:</p>
            
            <pre id="ccdbf4"><code class="javascript hljs">const { _Goa, _Context } = require('./koa')

/**
 * An application constructor.
 * @type {new (options?: ApplicationOptions) =&gt; Application)}
 */
const $Goa = _Goa

/**
 * The default context constructor.
 * @type {new () =&gt; Context}
 */
const $Context = _Context

module.exports = $Goa
module.exports.Context = $Context</code></pre>
            
            <p>This also works pretty well, however you won't be able to access JSDoc for static methods.</p>
            
            <hr />
            
            <p>In short, we need to use templates to enrich our compiled code with JSDoc annotations, by providing simple shells that are documented with JSDoc comments. All typedefs are also included in the main JS file to be accessed by methods. They are also imported from the source code, either directly or via such files as <strong>types/index.js</strong> that hold methods' typedefs for development purposes, as the main file is the source of truth for types.</p>
            
            </div>
            
            <div data-section id="running-compiler">
            <h3>Running Compiler</h3>
            
            <p>The next step is to execute the compiler. The package that we installed contained a <strong>jar</strong> file, which needs to be passed to Java along with arguments. The arguments must also contain the list of all JS files in the program. That's why <em>Depack</em> also contains a regex-based static analysis tool that scans all files for <span class="tm">import</span> statements, and builds a full list of all files. The algorithm can also detect <span class="tm">require</span> calls, however if at some point you want to use dynamic linking (so that a dependency is required at runtime, rather than compiled into your program), you can use the following construct:</p>
            
            <pre id="ccdbf5"><code class="javascript hljs">const pckg = require(/* depack */ 'dynamic-linking')</code></pre>
            
            <p>In this case, the regex won't pick up the require call. In addition, no require calls from the entry file that we're compiling end up in the arguments. Initially, this was a bug, but I decided to keep it as is, so that in binaries, we can simply do something like that:</p>
            
            <pre id="ccdbf6"><code class="javascript hljs">if (_version) {
  console.log('v%s', require('../../package.json')['version'])
}</code></pre>
            
            <p>Importing JSON files with <span class="tm">import</span> also doesn't work in Closure (at least at the time of writing), so you'll need to require them, or read as text and use JSON.parse method to extract JS objects from them.</p>
            
            <p>Since we've prepared and tested our source code already, we can just execute the compiler with <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>lib</span></span></span> command &mdash; <span class="tm2">depack src/depack.js -o compile/trapcss.js -a -c -p --source_map_include_content</span>:</p>
            
            <ul>
              <li><strong>src/depack.js</strong>, the entry point to compile.</li>
              <li><strong>-o compile/trapcss.js</strong>, the output location.</li>
              <li><strong>-a</strong>, enable advanced optimisation.</li>
              <li><strong>-c</strong>, indicates to <em>Depack</em> that we're <strong>c</strong>ompiling a Node.JS package which enables Node externs.</li>
              <li><strong>--source&lowbar;map&lowbar;include&lowbar;content</strong>, to include content in source maps. The content is pretty useful, however VSCode won't be able to print the values of variables when you hover over then during <a href="https://github.com/Microsoft/vscode/issues/12066">debugging</a> in which case you might want to pass <span class="tm">&quot;sourceMaps&quot;: false</span> in your launch config when debugging compiled libs.</li>
            </ul>
            
            <p>Other options could include <span class="tm">-p</span>, for pretty output, or <span class="tm">-O ES5</span>, to compile into really old code that could probably be able to run on Node 4 (given the API is supported). The default language output is ES2018. Source maps could be disabled with <span class="tm">-S</span>. Any other <a href="https://github.com/google/closure-compiler/wiki/Flags-and-Options">options</a> to the compiler can also be just passed after the main command. And that's it, there's no config or anything.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="compilation process" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='889' height='652'/%3E" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="compilation process" src="/nodetools/pages/trapcss2/1-compile/img/compile.gif">
              </noscript>
            </p>
            
            <p>Because of type checking, we also received a number of warnings. In part I, we kept the <span class="tm">keepText</span> argument, even though it wasn't used in the source code. The compiler was able to pick up the fact that the config type does not include such property, and that the <span class="tm2">parseHTML</span> method doesn't accept the second argument either. It's really great to use compiler to polish our code so that there are no inaccuracies like that left and our source is 100% professional. It is not possible with <em>Babel</em>, perhaps only with <em>TypeScript</em>.</p>
            
            <p>When we come to remove the <span class="tm">keepText</span> to fix the warning, let's also add the original MIT copyright on the package. The copyright owner didn't include any comment that would have to be preserved, therefore we're under no obligation to include it in our code (only in documentation), but let's do it anyway as good practice. I use the following template for MIT:</p>
            
            <pre id="ccdbf7"><code class="javascript hljs">/*!
 * dropcss by Leon Sorokin
 * https://github.com/leeoniya/dropcss
 * Copyright(c) 2020
 * MIT Licensed
 */</code></pre>
            
            <p>The compiled code is saved into <strong>compile/trapcss.js</strong> file. Let's just have a quick look.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="compiled code" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='972' height='619'/%3E" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="compiled code" src="/nodetools/pages/trapcss2/1-compile/img/compiled.gif">
              </noscript>
            </p>
            
            <p>There's the <span class="tm">use strict</span> directive, both licenses and the assignment to the <span class="tm2">module.exports</span> property. On top, there's also a shebang which is not relevant to compiled libraries, but is needed when we'll be compiling binaries, however <em>Depack</em> just keeps it anyway since it doesn't have any negative effect. If you need to disable <span class="tm">use strict</span>, you can pass the <span class="tm">-s</span> flag to <em>Depack</em>.</p>
            
            
            
            <p>The template has already been prepared so now we actually have our package ready to be published, but we'd like to test the compiled module prior to publishing. Since we should be careful with advanced optimisation that can rename property names, we can now run all our tests but override the import of the source code to import of the compiled code. This is achieved with <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>test-compile</span></span></span> command &mdash; <span class="ItWillRunYarn"><span class="tm2">yarn test -e test-compile</span></span><span class="ItWillRunNpm"><span class="tm2">npm test -- -- -e test-compile</span></span>. It simply calls the test script, but passes the <span class="tm">test-compile</span> variable as testing environment. The environments are configured in the <span class="tm">.alamoderc</span> file:</p>
            
            <pre id="cb9de"><code class="json hljs">{
  "env": {
    "test-compile": {
      "import": {
        "replacement": {
          "from": "^((../)+)src$",
          "to": "$1compile"
        }
      }
    }
  }
}</code></pre>
            
            <p>Now every time we require <span class="tm">../../src</span> from test, the transpiler will update it to <span class="tm">../../compile</span> on the fly (the <span class="tm2">$</span> is needed in cases when we import methods from other files in the lib for unit testing, which would break testing as paths like <strong>compile/html.js</strong> don't exist). We can also set it to just <span class="tm">../..</span> since it will resolve to our <strong>package.json</strong> and read the <span class="tm2">main</span> field from there. To ensure that the remapping actually happens, we can add a simple <span class="tm">throw new Error(1)</span> in the <strong>compile/index.js</strong> file and try to run this command.</p>
            
            <pre id="c414d2"><code class="bash hljs">Testing compile bin
Error: 1
Could not require test/spec
    at Object.&lt;anonymous&gt; (/Users/zavr/adc/trapcss/compile/index.js:2:7)
    at Module.p._compile (/Users/zavr/adc/trapcss/node_modules/alamode/compile/depack.js:49:18)
    at Object.h.(anonymous function).y._extensions.(anonymous function) [as .js] (/Users/zavr/adc/trapcss/node_modules/alamode/compile/depack.js:51:7)
error Command failed with exit code 1.</code></pre>
            
            <p>There was an error, so the imports renaming was correct. Let's remove the error and run test again.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="compiled code tests passing" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='604' height='466'/%3E" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="compiled code tests passing" src="/nodetools/pages/trapcss2/1-compile/img/tests.gif">
              </noscript>
            </p>
            
            <p>All tests pass which is good news! We can also create a test file called <span class="tm">t.js</span> in the project dir, and import the library to test for the presence of autocompletions:</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="test for autocompletions" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='359'/%3E" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="test for autocompletions" src="/nodetools/pages/trapcss2/1-compile/img/auto.gif">
              </noscript>
            </p>
            
            <p>After manual testing, we find that everything is correct. In <em>NodeTools 2</em>, we'll include a tool to write autocompletion tests since it's not feasible to keep rerunning such tests by hand. But for now, you can use this strategy.</p>
            
            
            
            </div>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='13'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/2.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="binary-executable">
            <h2>Binary Executable</h2>
            
            <p>Many packages come with a binary &mdash; a Node script that can be run from the CLI. There are many usages of such scripts, including on CI, or to perform any routine operation from the command line. Binaries need to be defined in <strong>package.json</strong>:</p>
            
            <pre id="cb9de1"><code class="json hljs">"bin": {
  "trapcss": "compile/bin/trapcss.js",
  "trapcss-dev": "src/bin/index.js"
}</code></pre>
            
            <p>The main bin is pointing to the compiled version, whereas we also add the <span class="tm">dev</span> version, for when we link the package using <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span>link</span></span></span>. This will make its source code executable system-wide without having to recompile it every time for changes. The <strong>index.js</strong> file is the entry point to the development version:</p>
            
            <pre id="ccdbf8"><code class="javascript hljs">#!/usr/bin/env node
require('alamode')()
require('./trapcss')</code></pre>
            
            <p>It simply instantiates the <em>ÀLaMode</em> hook that will transpile modules on the file. It is not used when the binary is built/compiled. We also have a <span class="tm">dev</span> script <span class="tm2">&quot;dev&quot;: &quot;node src/bin&quot;</span> so that we can run <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>dev</span></span></span> from the project folder when testing.</p>
            
            
            
            <div data-section id="cli-arguments">
            <h3>CLI Arguments</h3>
            
            <p>The key requirement for such scripts is to read arguments from the <span class="tm">process.argv</span> array, to parse input flags and options to the program. There are packages that allow to do that, but in <em>NodeTools</em>, we take a different approach. We'll keep our arguments definitions in the <strong>types/arguments.xml</strong> file:</p>
            
            <pre id="c16f72"><code class="xml hljs">&lt;arguments&gt;
  &lt;arg command multiple name="input"&gt;
    The HTML files to read.
  &lt;/arg&gt;
  &lt;arg name="css" short="c"&gt;
    The CSS file to drop selectors from.
  &lt;/arg&gt;
  &lt;arg name="output" short="o"&gt;
    The destination where to save output.
    If not passed, prints to stdout.
  &lt;/arg&gt;
  &lt;arg boolean name="help" short="h"&gt;
    Print the help information and exit.
  &lt;/arg&gt;
  &lt;arg boolean name="version" short="v"&gt;
    Show the version's number and exit.
  &lt;/arg&gt;
&lt;/arguments&gt;</code></pre>
            
            <p>Using XML schema, we can maintain the argument specification, and then create a special file called <strong>get-args.js</strong>, using the <span class="tm">argufy</span> package. The script is defined as the <em>args</em> job in <strong>package.json</strong> &mdash; <span class="tm2">argufy -o src/bin/get-args.js</span>. The default location of arguments is <strong>types/arguments.xml</strong>, so we don't need to specify any input. The output, on the other hand, is to be written to <strong>src/bin/get-args.js</strong>. From the specification that we drew, this is the output that is produced:</p>
            
            <pre id="ccdbf26"><code class="javascript hljs">import argufy from 'argufy'

export const argsConfig = {
  'input': {
    description: 'The HTML files to read.',
    command: true,
    multiple: true,
  },
  'css': {
    description: 'The CSS file to drop selectors from.',
    short: 'c',
  },
  'output': {
    description: 'The destination where to save output.\nIf not passed, prints to stdout.',
    short: 'o',
  },
  'help': {
    description: 'Print the help information and exit.',
    boolean: true,
    short: 'h',
  },
  'version': {
    description: 'Show the version\'s number and exit.',
    boolean: true,
    short: 'v',
  },
}

const args = argufy(argsConfig)

/**
 * The HTML files to read.
 */
export const _input = /** @type {!Array&lt;string&gt;} */ (args['input'])

/**
 * The CSS file to drop selectors from.
 */
export const _css = /** @type {string} */ (args['css'])

/**
 * The destination where to save output.
    If not passed, prints to stdout.
 */
export const _output = /** @type {string} */ (args['output'])

/**
 * Print the help information and exit.
 */
export const _help = /** @type {boolean} */ (args['help'])

/**
 * Show the version's number and exit.
 */
export const _version = /** @type {boolean} */ (args['version'])

/**
 * The additional arguments passed to the program.
 */
export const _argv = /** @type {!Array&lt;string&gt;} */ (args._argv)</code></pre>
            
            <p>The program generated the config, that will be passed to <span class="tm">argufy</span> at runtime, to create the <span class="tm2">args</span> object. Then, each of arguments is actually casted into its correct type, annotated with description and declared as a named export. This will allow to statically import those arguments from the binary. Such approach enables type checking using <em>Closure Compiler</em>, as arguments are constructed statically. <span class="tm">argufy</span> doesn't have any dependencies, but if we compile the binary, it will also be merged into it meaning there's absolutely no overhead into using it. Because <em>input</em> is specified as <strong>multiple command</strong>, it will be an array of strings, so that we can pass multiple paths to HTML files.</p>
            
            <ul>
              <li>Read more about <a href="https://github.com/artdecocode/argufy">argufy</a>;</li>
              <li>Multiple arguments.xml files can be kept, for different <a
              href="https://github.com/artdecocode/logarithm/tree/14ce888bec311c4febdf591e98eaedb00efdee47/types/args">
              semantic functionality</a>;</li>
              <li>Short aliases can be reused between commands, check out <a
              href="https://github.com/artdecocode/logarithm/blob/14ce888bec311c4febdf591e98eaedb00efdee47/src/bin/logarithm.js#L110">
              logarithm</a>;</li>
              <li>At the moment, an argument cannot be both flag (boolean) and standard argument, e.g., <span class="tm">trapcss -c</span> AND <span class="tm">trapcss -c path.css</span> are not possible at the same time. I'll be adding this later on.</li>
            </ul>
            
            </div>
            
            <div data-section id="implementation">
            <h3>Implementation</h3>
            
            <p>The template has already come with some binary source code, for example for printing version number and usage information. The usage string is constructed with the <span class="tm">usually</span> package, that accepts a description, example, line and usage itself. The usage is made using the <span class="tm2">reduceUsage</span> method from <span class="tm">argufy</span>, based on the arguments config that was also exported from the <strong>get-args.js</strong> file. It will create a 2-column table with full and short arguments' names and their descriptions.</p>
            
            <pre id="ccdbf27"><code class="javascript hljs">import usually from 'usually'
import { reduceUsage } from 'argufy'
import { readFileSync, writeFileSync } from 'fs'
import { c } from 'erte'
import { _input, _output, argsConfig, _css, _version, _help } from './get-args'
import trapcss from '../'

/*!
 * TrapCSS: Remove unused CSS selectors based on HTML files.
 *
 * Copyright (C) 2020 Art Deco Code Limited
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.
 */

if (_help) {
  const usage = usually({
    description: 'Remove unused CSS',
    example: 'trapcss index.html example.html -c style.css -o style-dropped.css',
    line: 'trapcss input.html[,n.html,...] -c style.css [-o output] [-hv]',
    usage: reduceUsage(argsConfig),
  })
  console.log(usage)
  process.exit(0)
} else if (_version) {
  console.log(require('../../package.json').version)
  process.exit(0)
}

if (!_css) {
  console.error('Please pass CSS path')
  process.exit(1)
}
const css = /** @type {string} */ (readFileSync(_css, 'utf8'))

// whitelist
let whitelist = new Set()

_input.forEach((input) =&gt; {
  const html = /** @type {string} */ (readFileSync(input, 'utf8'))
  const { sels } = trapcss({
    css,
    html,
  })
  sels.forEach(sel =&gt; whitelist.add(sel))
})

const cleaned = trapcss({
  html: '',
  css,
  shouldDrop: sel =&gt; !whitelist.has(sel),
})

if (_output) {
  writeFileSync(_output, cleaned.css)
  console.error('Output written to %s', c(_output, 'yellow'))
} else {
  console.log(cleaned.css)
}</code></pre>
            
            <p>We can see what the usage looks like by calling the <strong>dev</strong> script: <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>dev</span> <span class="npm-cmd">--</span> <span>-h</span></span></span>:</p>
            
            <pre id="c414d3"><code class="bash hljs">Remove unused CSS

  trapcss input.html[,n.html,...] -c style.css [-o output] [-hv]

        input           The HTML files to read.
        --css, -c       The CSS file to drop selectors from.
        --output, -o    The destination where to save output.
                        If not passed, prints to stdout.
        --help, -h      Print the help information and exit.
        --version, -v   Show the version's number and exit.

  Example:

    trapcss index.html example.html -c style.css -o style-dropped.css</code></pre>
            
            <p>This presentation might be different from how you want it to look like, so feel free to implement your own usage function from the args config, or submit a <a href="https://github.com/artdecocode/usually">PR</a> to the <span class="tm">usually</span> package with new options for styling.</p>
            
            <p>Moreover, we required <strong>package.json</strong> at runtime, which means that it won't be built into the compiled code, and will remain as <span class="tm">require</span> call. Requires from the entry file don't make it to the dependency list during static analysis, but if we wanted to make dynamic import anywhere else, it'd have to be broken up:</p>
            
            <pre id="ccdbf9"><code class="javascript hljs">const pckg = require(/* dpck */ 'dynamic-import')</code></pre>
            
            <p><em>version</em> is a recognised option by the compiler, so we don't have to use quoted props, for other fields, we'd have to refer to them like <span class="tm">require('../../package')['main']</span> to avoid renaming.</p>
            
            <p>Next, we check if the CSS was supplied via the arguments. If it wasn't we print an error message and exit with status code 1, which means that the program wasn't executed successfully and is a unix convention. Otherwise, we'll read the CSS file, using standard <strong>readFileSync</strong>. Typically, in Node, we're trained to use promises for non-blocking IO, however because we're not running a server, and simply executing a script, it's absolutely appropriate to use sync operations in this case (unless we're reading/writing many files in parallel). We used casting, because if the second argument (encoding) is not passed to <span class="tm2">readFileSync</span>, it will return a buffer, but the compiler does not support overloading, so we have to explicitly cast the return type. This is done by wrapping the value in brackets:</p>
            
            <pre id="ccdbf10"><code class="javascript hljs">/** @type {string} */ (readFileSync(input, 'utf8'))</code></pre>
            
            <p><em>DropCSS</em> provides a strategy for reading multiple input files. We create a <span class="tm">whitelist</span> set, and then for each HTML file, execute the <span class="tm2">trapcss</span> method against it and CSS, and add selectors to the set. In the end, we simply pass an empty string as HTML, but use <span class="tm">shouldDrop: sel =&gt; !whitelist.has(sel)</span> property of the config that will utilise the accumulated whitelist.</p>
            
            <p>Finally, if the <span class="tm">-o</span> argument was passed, we can save the result to a file. If not, we print the output to stdout to the user. We used the <span class="tm2">c</span> method from <span class="tm">erte</span> to print the output location in yellow. It also contains the <span class="tm2">b</span> method to color the background of strings, and the two can be combined. The template came with <span class="tm">indicatrix</span> package also that would print a loading indicator (triple ellipse) however we didn't have any async operations so it could be removed.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="running trapcss from CLI" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='654' height='508'/%3E" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="running trapcss from CLI" src="/nodetools/pages/trapcss2/2-bin/img/t.gif">
              </noscript>
            </p>
            
            </div>
            
            <div data-section id="fork-testing">
            <h3>Fork Testing</h3>
            
            <p>We already used some mask testing in <a href="/nodetools/trap"></a>, but one of the best applications of masks is to test forks. A fork is a separate Node process spawned from a script itself. They are completely independent processes with separate PIDs, but the fork will by default exit with its parent. Since our binary is a Node program, to test it properly, we need to spawn it via the <span class="tm">child_process</span> module. <em>Zoroaster</em> provides an abstraction over fork testing, if you pass <span class="tm2">fork</span> property to the mask constructor.</p>
            
            <pre id="ccdbf28"><code class="javascript hljs">import TempContext from 'temp-context'
import Context from '../context'
import makeTestSuite from '@zoroaster/mask'

export default makeTestSuite('test/result/bin/default', {
  context: TempContext,
  fork: {
    /**
     * @param {string[]} args
     * @param {TempContext} t
     */
    async getArgs(_, { write }) {
      const html = await write('index.html', this.input)
      const [, css] = /&lt;style&gt;([\s\S]+?)&lt;\/style&gt;/.exec(this.css)
      const style = await write('style.css', css)
      return [html, '-c', style]
    },
    module: Context.BIN,
    preprocess: {
      stdout: Context.wrap,
    },
  },
})</code></pre>
            
            <p>By default, the input from mask result is split by whitespace to provide arguments to fork, but we can provide the <span class="tm">getArgs</span> method to expand, or override the arguments list. We'll use a testing context called <em>TempContext</em> to write the input of the mask into a temp file (<span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-cmd">i</span><span class="yarn-cmd">add</span> <span>temp-context</span></span></span>). For each test, a blank <span class="tm2">test/temp</span> dir will be created, and removed at the end. The <strong>write</strong> method returns the path to the new file, so that we can pass it to the program. We then extract the CSS from within the <span class="tm2">style</span> tag in the mask result (need to wrap it in the style tag for syntax highlighting), and also write it to the temp dir. The new arguments, therefore are: [path-to.html -c path-to.css].</p>
            
            <p>As a preprocessor for output, we also want to wrap the <span class="tm">stdout</span> in style tag also, for syntax highlighting. The tag itself has no meaning to tests themselves, it only allows US as developers to work comfortably with mask results. <em>NodeTools</em> is all about usability, and we can even do some cools stuff as folding individual specs in the result file, since they are under <span class="tm">##</span> heading of a markdown file.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="folding mask results from IDE" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='467'/%3E" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="folding mask results from IDE" src="/nodetools/pages/trapcss2/2-bin/img/wrap.gif">
              </noscript>
            </p>
            
            <p>Additionally, we had to get the path to the fork from the context's static <span class="tm">BIN</span> property, that accounts for the testing environment:</p>
            
            <pre id="ccdbf11"><code class="javascript hljs">// test/context/index.js
let BIN = 'src/BIN'
if (process.env.ALAMODE_ENV == 'test-compile') {
  console.log('Testing compile bin...')
  BIN = 'compile/bin/trapcss'
}</code></pre>
            
            <p>This will be useful later after we've compiled the binary with <em>Closure</em>.</p>
            
            <pre id="c19538"><code class="markdown hljs">## keeps span
&lt;html&gt;
  &lt;body&gt;
    &lt;span&gt;test&lt;/span&gt;
  &lt;/body&gt;
&lt;/html&gt;

/* css */
&lt;style&gt;
  span {
    color: green;
  }
&lt;/style&gt;
/**/

/* stdout */
&lt;style&gt;
  span{color: green;}
&lt;/style&gt;
/**/

## removes div
&lt;html&gt;
  &lt;body&gt;
    &lt;span&gt;test&lt;/span&gt;
  &lt;/body&gt;
&lt;/html&gt;

/* css */
&lt;style&gt;
  span {
    color: yellow;
  }
  div {
    color: green;
  }
&lt;/style&gt;
/**/

/* stdout */
&lt;style&gt;
  span{color: yellow;}
&lt;/style&gt;
/**/</code></pre>
            
            <p>We only do a couple of tests to make sure that the binary doesn't throw any errors and processes arguments correctly. Most of the unit tests were done on the API, therefore it'd be redundant to test the same functionality twice. However, we could potentially construct a mask that would use input from mask results to the API to adapt them to pass to the CLI, but I won't do it here. Since mask results are just text files, they can be reused according to your imagination.</p>
            
            <pre id="ccdbf29"><code class="javascript hljs">import TempContext from 'temp-context'
import Context from '../context'
import makeTestSuite from '@zoroaster/mask'

export const output = makeTestSuite('test/result/bin/output', {
  context: TempContext,
  fork: {
    /**
     * @param {string[]} args
     * @param {TempContext} t
     */
    async getArgs(args, { resolve }) {
      return [...args, '-o', resolve('style-trap.css')]
    },
    module: Context.BIN,
  },
  /**
   * @param {TempContext} t
   */
  async getResults({ read }) {
    const s = await read('style-trap.css')
    return Context.wrap(s)
  },
})
</code></pre>
            
            <p>The second test is almost the same as the first one, except that we add the output argument to the list of arguments from the input, instead of completely overriding the arguments array. The path to the output is generated with the <span class="tm">resolve</span> method from the temp context, which we passed in the <strong>context</strong> property. The question is then how to test the output of the program? To do that, we need to implement the <span class="tm2">getResults</span> method that will also receive the context, so that we can call the <span class="tm2">read</span> method from testing API. As previously, we want to wrap the output for syntax highlighting.</p>
            
            <pre id="c19539"><code class="markdown hljs">## writes the output file
test/fixture/surveillance.html -c test/fixture/bootstrap.min.css

/* stderr */
Output written to test/temp/style-trap.css
/**/

/* expected */
&lt;style&gt;
  *,::after,::before{box-sizing:border-box}html{...}
&lt;/style&gt;
/**/
</code></pre>
            
            <p>The mask result provides 2 properties: <span class="tm">stderr</span> and <span class="tm">expected</span>. We're not testing for <span class="tm">stdout</span> since there's no output on this stream, and we implemented the <span class="tm2">getResults</span> method to read the expected result from a file in the temp folder.</p>
            
            <p>As previously, we could leave the mask result values blank, and run tests in interactive mode <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span>test</span> <span class="npm-cmd">--</span> <span>-i</span></span></span>, for the testing framework to populate them for us.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="updating mask forks in interactive mode" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='568'/%3E" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="updating mask forks in interactive mode" src="/nodetools/pages/trapcss2/2-bin/img/i.gif">
              </noscript>
            </p>
            
            <p>For the final test, we'll make the simplest mask possible, by only passing the path to the binary:</p>
            
            <pre id="ccdbf12"><code class="javascript hljs">export const stress = makeTestSuite('test/result/bin/stress', {
  fork: Context.BIN,
})</code></pre>
            
            <p>When there's no additional configuration, only <strong>stdout</strong>, <strong>stderr</strong> and <strong>code</strong> properties are asserted on.</p>
            
            <pre id="c195310"><code class="markdown hljs">## cleans the css
test/fixture/surveillance.html -c test/fixture/bootstrap.min.css

/* stdout */
*,::after,::before{box-sizing:border-box}html{...}
/**/

## gives error when CSS is not passed
test/fixture/surveillance.html

/* stderr */
Please pass CSS path
/**/

/* code */
1
/**/</code></pre>
            
            <p>In the first test, like before, we passed paths to HTML and CSS, but we didn't need to use the temp context since the output is printed to stdout. In the second test we added the <span class="tm">code</span> property to test that the fork will exit with code <em>1</em> when a path to the CSS file is not passed, and that <strong>stderr</strong> contains the error message.</p>
            
            <p>As you can see, testing forks is very simple with <em>Zoroaster</em> that provides means to setup tests to run parallel processes, and assert on outputs. The tests themselves are not run in parallel, but there's no point to it anyway, as running them in parallel will slow down the CPU and consume more memory, so that there's no difference between running 5 tests in parallel that take 1 second each, or 5 tests in series that take 0.2 seconds each, so don't listen to anyone who advertises parallel testing as an advantage, unless it's IO time that is being parallelised, and not CPU time.</p>
            
            <p>Even if a program required interaction from <strong>stdin</strong>, such as entering answers, we could still test it by either providing the <span class="tm">[stderr]Inputs</span> property of the mask, or via the <span class="tm">inputs</span> <a
              href="https://raw.githubusercontent.com/artdecocode/expensive/885e62298c05b75eedb2dbb298e8544823d1a0c2/test/result/fork/register.md">
              property</a> in the mask result.</p>
            
            <p>Fork testing is more expensive as it requires time to spawn forks, therefore it's preferable to do as many unit tests as possible, and design binary in such a way as it would be possible to require commands called from binary in tests, instead of spawning forks. That's why the template comes with the <span class="tm">init</span> command, but it could be removed now since our binary is fairly straight-forward.</p>
            
            </div>
            
            <div data-section id="bin-compile">
            <h3>Bin Compile</h3>
            
            <p>We now want to compile the binary. <em>NodeTools</em> is perfect for this task, as the program produced will have no dependencies at all. The <strong>package.json</strong> file already comes with a command to run <em>Depack</em> on the binary <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>compile</span></span></span> (the <strong>lib</strong> script is to compile library instead, which we've already done). The script evaluates to <span class="tm2">depack src/bin/trapcss -o compile/bin/trapcss.js -a -c -S --externs types/externs.js</span>:</p>
            
            <ul>
              <li><strong>src/bin/trapcss</strong>, the file to compile, from which all dependencies will be statically analyzed.</li>
              <li><strong>-o compile/bin/trapcss.js</strong>, the path to the output file.</li>
              <li><strong>-a</strong>, advanced compilation.</li>
              <li><strong>-c</strong>, compilation flag (needed to enable Node externs).</li>
              <li><strong>-S</strong>, no source maps, as we're not expecting that our bin will be debugged, unlike library, which might be jumped in.</li>
              <li><strong>--externs types/externs.js</strong>, in the library, we imported externs from <strong>src/depack.js</strong> file, however we can also pass it via the argument to CLI. Previously, <strong>src/depack.js</strong> that imported externs wasn't ever run and only passed to <em>Closure</em> as entry, but if we used an import in bin, the externs file would be evaluated which is unnecessary.</li>
            </ul>
            
            <p>
              <img class="b-bk b-vk b-t" alt="compilation process" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='748' height='483'/%3E" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="compilation process" src="/nodetools/pages/trapcss2/2-bin/img/bc.gif">
              </noscript>
            </p>
            
            <p><em>Depack</em> will discover all built-in Node modules, add apply externs for those. Global and Buffer externs are always added (even if <em>Buffer</em> isn't used). You might see a message <em>"Skipping package usually that imports itself in node&lowbar;modules/usually/src/index.js"</em>, because <span class="tm">usually</span> has an example usage where in its JSDoc it gives a snippet with an import:</p>
            
            <pre id="ccdbf13"><code class="javascript hljs">/**
 * Generate a usage string.
 * @param {!_usually.Config} config The configuration object.
 * @example
```
import usually from 'usually'

const res = usually({
  description: 'A test command-line application',
})
```
 */
export default function usually(config = { usage: {} }) {</code></pre>
            
            <p>Static analysis is based on regexes, so if you ever encounter any problems with it, e.g., false positive imports detection where your imports are just placed in a string, for example, you should break up the import so it becomes undetectable:</p>
            
            <pre id="ccdbf14"><code class="javascript hljs">// false positive
const myString = `// auto-generated code
import package from 'package'
`
// becomes
const myString = `// auto-generated code
i` + `mport package from 'package'
`</code></pre>
            
            <p>I know it's not perfect, but I'd rather keep simple regexes for the analysis of ECMA modules, instead of increasing complexity by building of ASTs <em>etc</em>. The whole purpose of <em>NodeTools</em> is to be really simple yet effective.</p>
            
            <p>The result of compilation is saved into the <span class="tm">compile/bin/trapcss.js</span>, and the file is assigned executable rights so that it can be called from shell, as it has got the shebang with the <span class="tm2">node</span> env.</p>
            
            <pre id="ccdbf15"><code class="javascript hljs">#!/usr/bin/env node
'use strict';
const fs = require('fs');             function q(){var a={description:"Remove unused CSS",example:"trapcss index.html example.html -c style.css -o style-dropped.css",line:"trapcss input.html[,n.html,...] -c style.css [-o output] [-hv]",usage:v()};const {usage:b={},description:c,line:d,example:f}=a;a=Object.keys(b);const g=Object.values(b),[e]=a.reduce(([h=0,m=0],p)=&gt;{const t=b[p].split("\n").reduce((r,n)=&gt;n.length&gt;r?n.length:r,0);t&gt;m&amp;&amp;(m=t);p.length&gt;h&amp;&amp;(h=p.length);return[h,m]},[]),k=(h,m)=&gt;{m=" ".repeat(m-h.length);return`${h}${m}`};
a=a.reduce((h,m,p)=&gt;{p=g[p].split("\n");m=k(m,e);const [t,...r]=p;m=`${m}\t${t}`;const n=k("",e);p=r.map(u=&gt;`${n}\t${u}`);return[...h,m,...p]},[]).map(h=&gt;`\t${h}`);const l=[c,`  ${d||""}`].filter(h=&gt;h?h.trim():h).join("\n\n");a=`${l?`${l}\n`:""}
${a.join("\n")}
`;return f?`${a}
  Example:

    ${f}
`:a};const w=(a,b,c,d=!1,f=!1)=&gt;{const g=c?new RegExp(`^-(${c}|-${b})$`):new RegExp(`^--${b}$`);b=a.findIndex(e=&gt;g.test(e));if(-1==b)return{argv:a};if(d)return{value:!0,index:b,length:1};d=a[b+1];if(!d||"string"==typeof d&amp;&amp;d.startsWith("--"))return{argv:a};f&amp;&amp;(d=parseInt(d,10));return{value:d,index:b,length:2}},x=a=&gt;{const b=[];for(let c=0;c&lt;a.length;c++){const d=a[c];if(d.startsWith("-"))break;b.push(d)}return b},v=()=&gt;{var a=z;return Object.keys(a).reduce((b,c)=&gt;{const d=a[c];if("string"==typeof d)return b[`-${d}`]=
"",b;c=d.command?c:`--${c}`;d.short&amp;&amp;(c=`${c}, -${d.short}`);let f=d.description;d.default&amp;&amp;(f=`${f}\nDefault: ${d.default}.`);b[c]=f;return b},{})};const A=fs.readFileSync,B=fs.writeFileSync;/*
 diff package https://github.com/kpdecker/jsdiff
 BSD License
 Copyright (c) 2009-2015, Kevin Decker &lt;kpdecker@gmail.com&gt;
*/
const aa={black:30,/* ... */}</code></pre>
            
            <p>You might see the copyright for the <span class="tm">diff</span> package, as there's a script in <em>Erte</em> (string coloring) to diff strings. Although it was dropped by <em>Closure</em>'s tree shaking, the comment is left over anyway as <em>Closure</em> preserves all important comments. <em>Depack</em> will implement its own tree shaking, as much as possible, in future versions, to limit the number of JS files passed to the compiler.</p>
            
            <p>To test the package, I call</p>
            
            <pre id="c724c"><code class="shell hljs">node compile/bin/trapcss.js test/fixture/surveillance.html \
     -c test/fixture/bootstrap.min.css</code></pre>
            
            <p>and check if the output is printed to <strong>stdout</strong> which it is.</p>
            
            <p>We also have to test the produced binary. Our <span class="tm2">test-compile</span> script will set the appropriate environment, and since the path to the <span class="tm">BIN</span> for mask-testing comes from the context, it will equal to <strong>compile/bin/trapcss</strong>, so that the compiled module, and not our source code, that will be forked. You'll be able to verify it as <em>Zoroaster</em> will print the confirmation as the first line in the output:</p>
            
            <pre id="c724c1"><code class="shell hljs">Testing compile bin</code></pre>
            
            <p>After tests pass, we know that our compiled bin is fully functional.</p>
            
            </div>
            
            <div data-section id="cli-documentation">
            <h3>CLI Documentation</h3>
            
            <p>I want to let my users know how to use <em>TrapCSS</em> from the <strong>CLI</strong>. Without <em>NodeTools</em>, I'd have to manually execute the binary, and copy-paste the help output into the README file. But we want to automate this process, to</p>
            
            <ol>
              <li>Save time taken to manually copy-paste data between terminal and documentation;</li>
              <li>Prevent documentation from becoming out-of-date when changes are made;</li>
              <li>Detect any errors if there were problems with the binary;</li>
              <li>Turn documentation into specification as our program will now always confirm to the published contract.</li>
            </ol>
            
            <p>The template already included <strong>documentary/2-CLI/index.md</strong> file, but we want to build upon it a little bit, by giving a more precise example. We'll need to create <strong>example/cli/index.html</strong> and <strong>example/cli/style.css</strong> files with some input data:</p>
            
            <pre id="c16f7"><code class="xml hljs">&lt;!-- example/cli/index.html --&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;TrapCSS ftw&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
      &lt;p&gt;Hello World!&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
            
            <pre id="c1d47"><code class="css hljs">/* example/cli/style.css */
html {
  background: yellow;
  /* @alternate */
  background: green;
}
.card {
  padding: 8px;
}
p:hover a:first-child {
  color: red;
}</code></pre>
            
            <p>The updated CLI section of the documentation is pretty simple and includes a 2-column table that lists the examples, and the output. The table with arguments will also be included automatically by the <span class="tm2">argufy</span> component that comes with <em>Documentary</em>:</p>
            
            <pre id="c195311"><code class="markdown hljs">## CLI

The package can also be used from the CLI.

&lt;argufy&gt;types/arguments.xml&lt;/argufy&gt;

For example, having these two files, we can use `trapcss` from the command line:

&lt;table&gt;
&lt;tr&gt;
  &lt;th&gt;HTML file&lt;/th&gt;
  &lt;th&gt;CSS file&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
  &lt;td&gt;

  %EXAMPLE: example/cli/index.html%
  &lt;/td&gt;
  &lt;td&gt;

  %EXAMPLE: example/cli/style.css%
  &lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;

```console
trapcss:~$ trapcss example/cli/index.html -c example/cli/style.css
```

%FORK-css src/bin/trapcss example/cli/index.html -c example/cli/style.css%

The help can be accessed with the `-h` command:

%FORK src/bin/trapcss -h%

%~%</code></pre>
            
            
            <p>We then give a console line of how to run our binary, and include the <span class="tm2">%FORK-css%</span> marker, which means that the language of the output block will be CSS for syntax-highlighting on <em>GitHub</em>.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="CLI documentation section" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='474' height='608'/%3E" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="CLI documentation section" src="/nodetools/pages/trapcss2/2-bin/img/bin-doc.png">
              </noscript>
            </p>
            
            <p>The README section is now compiled in the most automated way possible, leaving us time to work on implementation, testing and new feature design. Remember that we can run <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>doc</span> <span class="npm-cmd">--</span> <span>-p "doc cli"</span></span></span> to keep <em>Documentary</em> running in watch mode, and automatically push any changes upstream.</p>
            
            </div>
            
            
            
            <p>Now that we have a 0-dependency binary for <em>TrapCSS</em>, let's add add some more documentation.</p>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='9'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/3.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="wiki">
            <h2>Wiki</h2>
            
            <p>Putting documentation on <em>GitHub</em> wikis is a great way to organise help to our package. README files can be used to provide initial information about package usage, whereas Wikis can be used to described advanced use cases and intricacies of working with our software. Moreover, unlike website, especially if based on custom domains, Wikis will always remain attached to the package on <em>GitHub</em>. Unfortunately, Wikis have not been that popular, since it wasn't easy to maintain them. <em>Documentary</em> fixes this as it supports automatic compilation of docs into <em>Wikis</em>.</p>
            
            <p>When I was creating a new package from the template, I was asked if I wanted to set up a wiki page, to which I said yes, and had to navigate to <em>GitHub</em> to create the first page. This is because <em>GitHub</em> API doesn't provide a method to automate this, however it's not a problem as it only takes a few clicks. Wikis are represented as separate git trees, so for ease of maintenance, <em>MNP</em> initialised a git <strong>submodule</strong> called <strong>wiki.git</strong> in our project, and cloned the tree in there. Now pages from <strong>wiki</strong> will be compiled into <strong>wiki.git</strong> and we'll need to push changes to the submodule separately from the main project.</p>
            
            <p>The template came with <strong>wiki/Developing</strong> page, but it can be removed. I'm going to place original documentation from <em>DropCSS</em> into separate pages. The pages could be either directories, or simple MD files. Additionally, special files include <span class="tm">_Sidebar.md</span> and <span class="tm">_Footer.md</span>, for example our footer uses a component from <strong>.documentary/index.jsx</strong>:</p>
            
            <pre id="ccdbf16"><code class="javascript hljs">&lt;footer /&gt;</code></pre>
            
            We already described how to use the package in README, so let's add the features page.
            
            <div data-section id="features">
            <h3>Features</h3>
            
            <p>This page contains description of supported features. I've simply copied the table from the source. A cool thing we can do, though, is to create an example file right in the <em>Features</em> directory itself, as it won't be read by <em>Documentary</em> that scans for <span class="tm">md</span>, <span class="tm">markdown</span> and <span class="tm">htm[l]</span> files only. We can then simply pass the relative path to the example:</p>
            
            <pre id="c1953"><code class="markdown hljs">- Deep resolution of composite CSS variables, e.g:
  %EXAMPLE: ./example.css%</code></pre>
            
            <p>Mind the indentation that is used with the example marker &mdash; it's needed so that <em>GitHub</em> recognises it as part of the list item.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="features wiki page" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='515' height='551'/%3E" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="features wiki page" src="/nodetools/pages/trapcss2/3-wiki/img/features.png">
              </noscript>
            </p>
            
            </div>
            
            <div data-section id="performance">
            <h3>Performance</h3>
            
            <p>This page contains some benchmark data for <em>DropCSS</em>. I'll keep it the same.</p>
            
            </div>
            
            <div data-section id="javascript-execution">
            <h3>JavaScript Execution</h3>
            
            <p>This page is about opening a webpage in a headless browser to execute any dynamic JavaScript, which might manipulate DOM, so that the list of selectors is gathered after scripts are executed. I want to use the example, but the original depends on <span class="tm">puppeteer</span> which I think is redundant because if you have Chrome installed on your system, you can already open it. I don't want to download 80MB of a browser just for a simple script to be executed, so we'll simply install <span class="tm">chrome-remote-interface</span> and launch Chrome by hand. There's also <span class="tm">chrome-launcher</span> package however it's got 5 dependencies so until I've made a 0-dep fork, I'm not going to use it.</p>
            
            <pre id="c19531"><code class="markdown hljs">%EXAMPLE: ./execution, ../.. =&gt; trapcss%

%FORK-js ./execution%</code></pre>
            
            <p>The example fork that spawns Chrome is going to be cached, so unless we make changes to the source code and recompile the package, we won't need to wait again for Chrome to start and load pages.</p>
            
            <pre id="ccdbf30"><code class="javascript hljs">import idio from '@idio/idio'
import CDP from 'chrome-remote-interface'
import { spawn } from 'child_process'
import rqt from 'rqt'
import trapcss from '../..'

(async () =&gt; {
  const { app, url } = await idio({
    static: {
      use: true,
      root: 'example/www',
    },
  })
  const chrome = await new Promise((r) =&gt; {
    const p = spawn('/Applications/Google Chrome.app/Contents/MacOS/Google Chrome',
      ['--remote-debugging-port=9222', '--headless'])
    p.stderr.on('data', (d) =&gt; {
      d = `${d}`
      if (/listening/.test(d)) setTimeout(() =&gt; r(p), 1000)
    })
  })
  try {
    const client = await CDP()
    const { Network, Page, Runtime } = client
    await Network.enable()
    await Page.enable()
    await Page.navigate({ url })
    await Page.loadEventFired()
    const { result: { value: html } } = await Runtime.evaluate({
      expression: 'document.documentElement.outerHTML',
    })
    const { result: { value: links } } = await Runtime.evaluate({
      expression: `[...document.querySelectorAll("link[rel=stylesheet]")]
        .map((el) =&gt; el.href)`,
      returnByValue: true,
    })
    await client.close()

    await Promise.all(links.map(async href =&gt; {
      const css = await rqt(href)
      let start = +new Date()

      const clean = trapcss({
        css,
        html,
      })

      console.log({
        stylesheet: href,
        cleanCss: clean.css,
        elapsed: +new Date() - start,
      })
    }))
  } catch (err) {
    console.log(err)
  } finally {
    await app.destroy()
    chrome.kill()
  }
})()
</code></pre>
            
            <p>I can also start <em>Documentary</em> in watch mode for Wikis also: <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>wiki</span> <span class="npm-cmd">--</span> <span>-p 'wiki pages'</span></span></span>. Now it will watch for changes in both project and submodule directories, and force-push updates as necessary.</p>
            
            </div>
            
            <div data-section id="accumulating-whitelist">
            <h3>Accumulating Whitelist</h3>
            
            <p>There are some instructions on how to gather HTML selectors from multiple files, if CSS is reused across web pages. I'll copy the instructors and create an example also. When naming Wiki pages like <span class="tm">Accumulating-a-Whitelist</span>, hyphens become whitespace in titles.</p>
            
            <pre id="c19532"><code class="markdown hljs">-= INSTRUCTIONS =-

%EXAMPLE: ./whitelist, ../.. =&gt; trapcss%
%FORK-css ./whitelist%</code></pre>
            
            <p>In watch mode, new examples will automatically be added to git tree also. Notice how I've imported the package from <span class="tm">../..</span> rather than from source. This is because I want to build documentation against the compiled code, so that I can be sure it's working. It's up to you whether you use source and compile target for documentation since ideally you'll be running <span class="tm">test-compile</span> so that they should produce identical results.</p>
            
            </div>
            
            <div data-section id="special--escaped-sequences">
            <h3>Special / Escaped Sequences</h3>
            
            <p>This page describes the problems with special characters in class names. I'll copy the description and give examples of how to overcome this difficulty. We can't have <span class="tm2">/</span> in the page name, so we'll just call it <em>Special AND Escaped Sequences</em>. We'll want to place an example with HTML into the wiki folder, but to prevent <em>Documentary</em> from reading it, we'll make it hidden by adding a dot: <span class="tm">.index.html</span>.</p>
            
            <p>Our example will also be cropped by using <span class="tm2">/* start/end example */</span> marker:</p>
            
            <pre id="ccdbf17"><code class="javascript hljs">import { join } from 'path'
import { readFileSync } from 'fs'
import trapcss from '../..'

const html = readFileSync(join(__dirname, 'index.html'), 'utf8')
const css = readFileSync(join(__dirname, 'index.css'), 'utf8')

/* start example */
// remap
let css2 = css
  .replace(/\\:/gm, '__0')
  .replace(/\\\//gm, '__1')
  .replace(/\\\?/gm, '__2')
  .replace(/\\\(/gm, '__3')
  .replace(/\\\)/gm, '__4')
// more code
/* end example */</code></pre>
            
            <p>This is so that we don't have to include admin set up of reading files in the example itself. Also despite me using import statements, and the file being a module, I can still use <span class="tm">__dirname</span>. This is perfect as there's absolutely no reason for Node to make everyone's life really difficult by removing this feature in .mjs files... We're here to make programs not worship standards.</p>
            
            <p>In the end, there's another way to embed a fork:</p>
            
            <pre id="c16f71"><code class="xml hljs">&lt;fork lang="css"&gt;./&lt;/fork&gt;</code></pre>
            
            <p>This is equivalent to <span class="tm2">%FORK-css ./%</span> and is a preferred method as <em>Documentary</em> is switching to components now.</p>
            
            </div>
            
            <div data-section id="caveats--acknowledgements">
            <h3>Caveats & Acknowledgements</h3>
            
            <p>We'll keep those pages as is, since there are no examples.</p>
            
            <pre id="c19533"><code class="markdown hljs">- Not tested against or designed to handle malformed HTML or CSS
- Excessive escaping or reserved characters in your HTML or CSS can break TrapCSS's parsers</code></pre>
            
            <pre id="c19534"><code class="markdown hljs">- Felix Böhm's [nth-check](https://github.com/fb55/nth-check) - it's not much code, but getting `An+B` expression testing exactly right is frustrating. I got part-way there before discovering this tiny solution.
- Vadim Kiryukhin's [vkbeautify](https://github.com/vkiryukhin/vkBeautify) - the benchmark and test code uses this tiny formatter to make it easier to spot differences in output diffs.</code></pre>
            
            </div>
            
            <p>This should be it for Wiki. Now it's attached to our project and will always be available on <em>GitHub</em>.</p>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='9'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/4.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="license">
            <h2>License</h2>
            
            <p>I'd like to update our footer to include the information about the original license. I've chosen Affero for this project, so the footer at the moment looks like the following:</p>
            
            <pre id="c19535"><code class="markdown hljs">## Copyright &amp; License

GNU Affero General Public License v3.0</code></pre>
            
            <p>Let's include the original license:</p>
            
            <pre id="c19536"><code class="markdown hljs">## Copyright &amp; License

GNU Affero General Public License v3.0

Original work on [_DropCSS_](https://github.com/leeoniya/dropcss) package
by [Leon Sorokin](https://github.com/leeoniya) under MIT license found
in [COPYING](COPYING).</code></pre>
            
            <p>There are 2 standard files for a license, either <span class="tm2">LICENSE</span> or <span class="tm2">COPYING</span>. Since our AGPL is found in the former, we can include the original one in the latter. This is the convention I use for forked packages. I'll also update <strong>package.json</strong> to include the original license in the <span class="tm">files</span> field:</p>
            
            <pre id="cb9de2"><code class="json hljs">"files": [
  "src",
  "compile",
  "types/externs.js",
  "typedefs.json",
  "COPYING"
]</code></pre>
            
            <p>The <span class="tm2">LICENSE</span> is always included by npm / yarn, so we don't need to specify it in there. We also want to publish the source code, so that the package can be compiled into other packages. If you're not publishing source code, remember to still include <strong>src/bin/index.js</strong> since it's defined in the <span class="tm">bin</span> field, and <em>npm</em> will not let you install the package if the file is missing (unlike <em>yarn</em>). <strong>typedefs.json</strong> will contain meta-information for package's types so that they can be linked to from other packages:</p>
            
            <pre id="cb9de3"><code class="json hljs">{
  "_trapcss.trapcss": {
    "link": "https://github.com/artdecocode/trapcss#trapcssconfig-config-return",
    "description": "Parses the supplied HTML and CSS and removes\nunused selectors. Also removes empty CSS rules."
  },
  "_trapcss.Config": {
    "link": "https://github.com/artdecocode/trapcss#type-config",
    "description": "Options for the program."
  },
  "_trapcss.Return": {
    "link": "https://github.com/artdecocode/trapcss#type-return",
    "description": "Return Type."
  }
}</code></pre>
            
            <p>We'll come back to it in a second.</p>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='10'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/5.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="stdlib">
            <h2>StdLib</h2>
            
            <p>We've done good job on implementation of API and CLI, their testing and documentation, and can publish the package now: <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>publish</span></span></span>. But before we do it, let's add a changelog line for the new version. <em>Documentary</em> comes with a <span class="tm">cl</span> binary that will ask for a new version of the package: <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>cl</span></span></span>, and create an appropriate link to compare versions.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="changelog update" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='684' height='462'/%3E" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="changelog update" src="/nodetools/pages/trapcss2/5-stdlib/v1.gif">
              </noscript>
            </p>
            
            <p>After publishing, I'll go ahead and make sure to push git tree with a new tag. The best way to do it is with <span class="tm2">git push --follow-tags</span> command.</p>
            
            <p>As I promised at start, we can incorporate <em>TrapCSS</em> into <em>Splendid</em>, a static website generator via its standard library. <em>StdLib</em> is a new concept that allows to place all dependencies into a single file and also compile them at the same time, so that the package receives access to all methods needs from dependencies, but doesn't have to install them. Such static linking is great to create neat packages without forcing your users to pull myriads of new dependencies they have no clue as to the purpose of. This will increase trust to your package and allow to produce great independent <strong>software products</strong> with full type checking, as compared to half-baked <strong>packages</strong> that can't go anywhere without 3rd party code. It also potentially increases security as it means you're reducing the attack scope by eliminating any dependencies that might become sabotaged in future (if their version is not fixed).</p>
            
            <p><em>Splendid's</em> stdlib looks a bit like the following:</p>
            
            <pre id="ccdbf18"><code class="javascript hljs">import '@externs/preact/types/externs'
import {
  read, write, rm, exists, ensurePath, readDirStructure, readBuffer,
} from '@wrote/wrote'
import clone from '@wrote/clone'
import render from '@depack/render'
import aqt from '@rqt/aqt'
import cleanStack from '@artdeco/clean-stack'
import { ensurePathSync } from '@wrote/ensure-path'
import rexml from 'rexml'
import differently from 'differently'
import argufy, { reduceUsage } from 'argufy'
import Catchment, { collect } from 'catchment'
import controlStyle from '@lemuria/control-style'
import competent, { makeComponentsScript, writeAssets } from 'competent'
import { c, b } from 'erte'
import makePromise from 'makepromise'
import usually from 'usually'
import { confirm } from 'reloquent'
import spawn, { fork } from 'spawncommand'
import {
  SyncReplaceable, Replaceable, makeMarkers, makeCutRule, makePasteRule,
  replace,
} from 'restream'
import Pedantry from 'pedantry'
import compare from '@depack/cache'
import {
  Bundle, getOptions, BundleChunks, getCompilerVersion,
} from '@depack/depack'

module.exports = {
  'getOptions': getOptions,
  'getCompilerVersion': getCompilerVersion,
  'Bundle': Bundle,
  'BundleChunks': BundleChunks,
  // ... and so on
}</code></pre>
            
            <p>I'm deliberately giving the full list of imports so that you can understand the meaning behind STDLIBs. They are literal libraries for your big projects. The fact is that you don't want to fully compile huge projects because it's time consuming and unnecessary actually, since their source code isn't going to be used in other packages. They are standalone pieces of software, so it's ok to just build them. But to eliminate dependencies, we need an stdlib. The trick is then to rename all imports from 3rd party packages that you had in source code, to point to the <strong>stdlib</strong> instead.</p>
            
            <pre id="ccdbf19"><code class="javascript hljs">// was
import { join } from 'path'
import { read, write, ensurePath, exists } from '@wrote/wrote'
import { Bundle, getOptions, BundleChunks } from '@depack/depack'
import { c } from 'erte'
import compare from '@depack/cache'
import { deepStrictEqual } from 'assert'
import { getDates } from '../'
import { resolveInternal } from '../'

// becomes
const { join } = require('path');
const { read, write, ensurePath, exists } = require('../../../stdlib');
const { Bundle, getOptions, BundleChunks } = require('../../../stdlib');
const { c } = require('../../../stdlib');
const { compare } = require('../../../stdlib');
const { deepStrictEqual } = require('assert');
const { getDates } = require('../');
const { resolveInternal } = require('../');</code></pre>
            
            <p>This is achieved when we run ÀLaMode on the source code with <span class="tm2">build</span> environment</p>
            
            <pre id="cb9de4"><code class="json hljs">{
  "b": "yarn-s src jsx",
  "src": "alamode src -o build -s -i bin/.eslintrc,js,components,stdlib.js -j -p -m --env build",
  "jsx": "alamode src/components -o build/components -s -i .eslintrc -j -E --env build",
}</code></pre>
            
            <p><em>Splendid</em> includes some server-side as well as client-side JSX components, so I need 2 scripts, one for SSR, and second for the browser so that <em>Preact</em> is imported as an extern rather than package (<span class="tm">-E</span> flag). Let's just focus on the <span class="tm2">src</span> script:</p>
            
            <ul>
              <li><strong>src</strong>, the input directory for compilation.</li>
              <li><strong>-o build</strong>, where to put transpiled files to.</li>
              <li><strong>-s</strong>, disable source maps (they're not needed at all since the transpiler is really good at preserving the style of code and just renames imports into requires).</li>
              <li><strong>-i bin/.eslintrc,js,components,stdlib.js</strong>, those files will be ignored. We don't need to build the <strong>stdlib.js</strong> file itself as it's only for Closure.</li>
              <li><strong>-j</strong>, enables JSX transpilation.</li>
              <li><strong>-p</strong>, adds Preact pragma for JSX files.</li>
              <li><strong>-m</strong>, transpiles modules into requires (which is disabled by default for JSX).</li>
              <li><strong>--env build</strong>, use the build environment, to rename StdLib.</li>
            </ul>
            
            <p>The environment is defined in the <strong>.alamoderc.json</strong> file:</p>
            
            <pre id="cb9de5"><code class="json hljs">{
  "env": {
    "test-build": {
      "import": {
        "replacement": {
          "from": "^((../)+)src",
          "to": "$1build"
        }
      }
    },
    "build": {
      "import": {
        "stdlib": {
          "path": "stdlib",
          "packages": [
            "argufy", "catchment", "clearr", "erte",
            "forkfeed", "makepromise", "mismatch", "rexml", "@wrote/wrote",
            "@wrote/clone", "@wrote/ensure-path", "pedantry", "@depack/cache",
            "usually", "resolve-dependency", "spawncommand", "restream",
            "@depack/render", "@rqt/aqt", "reloquent", "differently",
            "which-stream", "@wrote/read-dir-structure", "competent",
            "@lemuria/control-style", "@depack/depack", "@artdeco/clean-stack"
          ]
        },
        "alamodeModules": ["alamode", "@wrote/read", "@wrote/write",
          "@wrote/clone", "@lemuria/popup", "@depack/render",
          "@idio/frontend", "@goa/koa", "@idio/websocket", "differently",
          "@artdeco/clean-stack",
          "competent", "@idio/idio", "closure-stylesheets-java",
          "@lemuria/control-style"]
      }
    }
  }
}</code></pre>
            
            <p>It's pretty large as it contains the list of all modules that we want to rename (<span class="tm2">alamodeModules</span> is a separate thing, which disables <em>&lowbar;&lowbar;esModule</em> check when importing default exports). Under <strong>stdlib</strong> property, we specified the <em>path</em> to the library, and all packages that should be renamed. Now it's time to compile stdlib.</p>
            
            <p>I'm going to install <span class="tm">trapcss</span> as a dev dependency (since it will be compiled into stdlib statically) and include it in the appropriate places.</p>
            
            <pre id="ccdbf20"><code class="javascript hljs">// src/elements/bootstrap-css/run_template.jsx
import trapcss from 'trapcss'</code></pre>
            
            
            <p>I can also validate that there are autocompletion hints.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="autocompletion hints" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='657' height='484'/%3E" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="autocompletion hints" src="/nodetools/pages/trapcss2/5-stdlib/hints.gif">
              </noscript>
            </p>
            
            <p>The <span class="tm">src/stdlib</span> file is the entry point that will be compiled. <span class="tm2">module.exports</span> is a known object defined in externs and by assigning properties to it using quotes, we prevent renaming of its properties.</p>
            
            <pre id="ccdbf21"><code class="javascript hljs">// src/stdlib.js
// ... prev imports
import trapcss from 'trapcss'

module.exports = {
  'trapcss': trapcss,

  'getOptions': getOptions,
  // ...
}</code></pre>
            
            <p>Now update the env:</p>
            
            <pre id="cb9de6"><code class="json hljs">{
    "build": {
      "import": {
        "stdlib": {
          "path": "stdlib",
          "packages": [
            "...all-other-packages", "trapcss"
          ]
        }
      }
    }
  }
}</code></pre>
            
            <p>And use the <strong>stdlib</strong> script:</p>
            
            <pre id="cb9de7"><code class="json hljs">{
  "stdlib": "depack src/stdlib -o stdlib/index.js -a -c -p -s --source_map_include_content",
}</code></pre>
            
            <p>It will run <em>Depack</em> with pretty much standard Node.JS compilation configuration, that also includes source code in source maps, so that we can debug it when necessary. It will increase the package size by about 350KB, so it's optional. An alternative for debugging is to clone package locally and link to it from the project which is being debugged.</p>
            
            <p>After <strong>stdlib</strong> is compiled, I can build the project again, and see the changes:</p>
            
            <pre id="ccdbf22"><code class="javascript hljs">// was
let dropcss = require('dropcss'); if (dropcss &amp;&amp; dropcss.__esModule) dropcss = dropcss.default;

// now 🎉
const { trapcss } = require('../../../stdlib');</code></pre>
            
            <p>Using this technique, I've reduced the number of dependencies in my project (by 1 with <em>TrapCSS</em>, but by about 50 considering all other packages). This method is really great for modern package development that <em>NodeTools</em> facilitate.</p>
            
            <p>As the final step, let me explain the purpose of <span class="tm">typedefs.json</span>. Because we want to link between documentation pages, we want to know where each type is described: it could be either in the main readme file, or somewhere in Wiki. This file remembers the exact location of where the type is described.</p>
            
            <p><em>Splendid</em> has got some documentation about dropping types:</p>
            
            <pre id="c19537"><code class="markdown hljs">## Dropping Unused Selectors

After a page is compiled, a list of classes will be gathered, and
_Bootstrap_ CSS will be processed to remove selectors which are not
present on pages.

&lt;include-typedefs&gt;trapcss&lt;/include-typedefs&gt;

_Splendid_ uses &lt;link type="_trapcss.trapcss"&gt;_TrapCSS_&lt;/link&gt;
to achieve this purpose.</code></pre>
            
            <p>By calling the <span class="tm2">include-typedefs</span> component, we added the information of our types to <em>Documentary</em>. After that, we can use the <span class="tm2">link</span> component to insert a link to this type. Obviously, <span class="tm">_trapcss.trapcss</span> is a method and not a type, but if <em>Splendid</em> at any point was extending any type from <em>TrapCSS</em> (e.g., its config), or used a property from its own config to be of <em>TrapCSS</em> config (e.g., <span class="tm">{ trapcss: {/* trap config */ } }</span>), the correct link would appear in the documentation. This makes the process robust since there's no manual work required and prevents outdated linking.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="generated link on Splendid wiki to TrapCSS" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='727' height='235'/%3E" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="generated link on Splendid wiki to TrapCSS" src="/nodetools/pages/trapcss2/5-stdlib/sel.png">
              </noscript>
            </p>
            
            <p>I think that's about it for advanced topics, so please feel free to leave comments and ask questions. Part III will be about creating a website for the project with <em>Splendid</em>, but in due time.</p>
            
            
            
            <p>
              <span id="cd192"><span class="b-Hk" style="height:32px" data-loading>Loading sharing buttons...</span><noscript>Please enable JavaScript to Share</noscript></span>
            </p>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='10'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/6.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="comments">
            <h2>Comments</h2>
            
            <div id="c8b27">Loading comments...</div>
            
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="b-ns">
      &copy; <a href="https://www.artd.eco">Art Deco™</a>, 2020
    </footer>
    <script>(function(){function b(){if(0<c.length){var a=c.shift();a.src=a.getAttribute("data-src");a.removeAttribute("data-src");a.onload=b;a.onerror=function(){console.warn("Could not load script %s",a.src)}}}var c=Array.prototype.slice.call(document.querySelectorAll("script[data-src]"));b()})()</script>
  </body>
</html>