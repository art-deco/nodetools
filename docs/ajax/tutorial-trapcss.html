{
  "title": "Tutorial: TrapCSS",
  "content": "\n\n<div data-section id=\"trapcss\">\n<h1 id=\"trapcss-nodetools-use-case\">TrapCSS: NodeTools Use Case</h1>\n\n<p>There are CSS frameworks such as <em>Bootstrap</em> that allow to create great layouts quickly, however their size might be quite large. This point is worth considering because CSS is loaded in a blocking fashion: the browser will have to wait before all CSS is loaded to render a web site, which slows page render, and affects usability and even search engine ranking negatively. In many cases, a lot of CSS can be \"dropped\" from frameworks' compiled code, and by leaving only those selectors that are present on a page, or multiple pages. This technique corresponds to the \"Defer unused CSS\" Lighthouse <a href=\"https://developers.google.com/web/tools/lighthouse/audits/unused-css\">warning</a>.</p>\n\n<p>\n  <img class=\"ImageHolder rounded img-fluid\" sizes=\"(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px\" alt=\"trap css nodetools tutorial\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1000' height='674'/%3E\">\n  <noscript>\n    <picture>\n      <source\n        srcset=\"/nodetools/pages/trapcss/img/splash-768.webp 768w,/nodetools/pages/trapcss/img/splash-576.webp 576w,/nodetools/pages/trapcss/img/splash-319.webp 319w,/nodetools/pages/trapcss/img/splash-1000.webp 1000w\" sizes=\"(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px\"\n        type=\"image/webp\">\n      <img class=\"rounded img-fluid\" onLoad=\"webploaded(this)\" alt=\"trap css nodetools tutorial\" src=\"/nodetools/pages/trapcss/img/splash-768.jpg\" srcset=\"/nodetools/pages/trapcss/img/splash-768.jpg 768w,/nodetools/pages/trapcss/img/splash-576.jpg 576w,/nodetools/pages/trapcss/img/splash-319.jpg 319w,/nodetools/pages/trapcss/img/splash-1000.jpg 1000w\" sizes=\"(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px\">\n    </picture>\n  </noscript>\n</p>\n\n<p>One of the packages that is able to do it quickly is called <a href=\"https://github.com/leeoniya/dropcss\">DropCSS</a>, developed by <a href=\"https://github.com/leeoniya\">Leon Sorokin</a>. It's notable for its speed, simplicity and the amount of bytes that can shaved off the CSS. However, for our use case it was not perfect: it strips comments and does not allow to keep arbitrary annotations, such as <span class=\"tm\">/* alternate */</span> which is needed for <a href=\"https://github.com/artdecocode/closure-stylesheets-java\">Closure Stylesheets</a>. Closure Stylesheets is an optimiser of CSS that can minify and put styles together. Art Deco uses it for Splendid, a static website generator. By collecting selectors across all pages on a generated website, we're able to drop unused Bootstrap rules, and then merge Bootstrap with other styles so that a single, small CSS file is served to visitors quickly.</p>\n\n<p>But Bootstrap contains rules that repeat the CSS properties, e.g.,:</p>\n\n<pre id=\"c1d47\"><code class=\"css hljs\">abbr[title],\nabbr[data-original-title] {\n  text-decoration: underline;\n  -webkit-text-decoration: underline dotted;\n  /* @alternate */\n  text-decoration: underline dotted;\n  /* ^ repeated use, need alternate */\n}</code></pre>\n\n<p>We needed to annotate Bootstrap with the <span class=\"tm\">/* alternate */</span> marker so that the CSS compiler doesn't throw an error. A simple proposed solution to prevent stripping such comments was suggested in form of a <a href=\"https://github.com/leeoniya/dropcss/pull/41\">PR</a> to <em>DropCSS</em> package owner, however was rejected as being too narrow of a use case. Therefore, we decided to fork his project and use its source code to create a professional Node.JS package that would also provide JSDoc annotations, could be tested with context testing, and is ready to be compiled into other packages, such as <em>Splendid</em> itself, so that it's linked statically instead of dynamically as permitted by the original MIT license.</p>\n\n<p>This tutorial walks through the process of upgrading a package to use <em>NodeTools</em> stack with explanation of advantages of using the tools from the stack in creating modern packages. You might want to read the <a href=\"/nodetools/quickGuide\">quick guide</a> first for some details about the standard routine.</p>\n\n<p class=\"SectionBreak\">\n  <a title=\"Back To Top\" href=\"#top\">\n    <img alt=\"section break\"\n      src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='15'/%3E\" data-io>\n    <noscript><img alt=\"section break\" src=\"/nodetools/section-breaks/0.svg\"></noscript></a>\n</p>\n</div>\n\n<div data-section id=\"mnp\">\n<h2 id=\"mnp\">MNP</h2>\n\n<p>The very first step is to spawn a new package using <span class=\"tm\">mnp</span>. Instead of forking the repo, I will create a new package so that its structure adheres to <em>NodeTools</em>' recommendations. My default organisation is <span class=\"tm\">artdecocode</span> on <em>GitHub</em> and I keep projects in the <span class=\"tm\">~/adc</span> folder. Additionally, I've made a number of other orgs, such as <span class=\"tm\">dpck</span>, <span class=\"tm\">a-la</span> for scopes of other projects. Organising the home dir by org is a convenient method that allows to maintain different settings for different organisations. For standard Node.JS package, I'll just use <span class=\"tm\">adc</span>.</p>\n\n<pre id=\"c414d\"><code class=\"bash hljs\">cd adc\n# mnp --init (if init was not done yet)\nmnp trapcss -n</code></pre>\n\n<p>I've already <a href=\"/nodetools/quick-start.html#configure-org\">configured mnp</a> prior to creating a package, therefore all settings are already recorded in the <span class=\"tm\">.mnprc</span> file. I pass the package name to the binary, together with the <span class=\"tm\">-n</span> flag, which means <span class=\"tm\">--no-scope</span>: because settings contain a scope (<span class=\"tm\">@artdeco</span>), I want to skip it in this particular case. <em>MNP</em> then asks me questions about the new package:</p>\n\n<pre id=\"c414d1\"><code class=\"bash hljs\"># trapcss\nDescription: Removes unused selectors from CSS files to achieve maximum optimisation. Can be used as an API function or with CLI.\nGenerating repository...\nStarring...\n⭐️ Created and starred a new repository\nhttps://github.com/artdecocode/trapcss\nCloning into '/Users/zavr/adc/trapcss'...\nSetting user Anton&lt;anton@adc.sh&gt;...\nWith binary [y/n]: [y]\nBuild or compile: [compile]\nLicense: [agpl-3.0]\nInit Github Wiki [y/n]: [y]\nHomepage: [https://github.com/artdecocode/trapcss#readme] https://art-deco.github.io/trapcss\nKeywords (e.g., artdecocode, trapcss): css, minifier, web, browser\nPlease go to https://github.com/artdecocode/trapcss/wiki/_new\nto create the first page and press enter when done. (y/n): [y]\nCloning into '/Users/zavr/adc/trapcss/wiki.git'...\nSetting topics...\nInitialised package structure, pushing...\nyarn install v1.13.0\n✨  Done in 2.67s.\nCreated a new package: trapcss.</code></pre>\n\n<p>I've answered questions in the following way:</p>\n\n<ul>\n  <li>With binary: <strong>true</strong>, because I'll want to create a node executable to run from the CLI to drop selectors from CSS files based on HTML files.</li>\n  <li>Build or compile: <strong>compile</strong>, because I want to create a library compatible with Closure so that it can be compiled into <em>Splendid</em> later.</li>\n  <li>License: <strong>agpl-3.0</strong>, my personal preference.</li>\n  <li>Init Github Wiki: <strong>y</strong>, we'll want to create wiki pages with discussion about certain use cases, such as using multiple HTML files to gather selectors list.</li>\n  <li>Homepage: <strong>https://art-deco.github.io/trapcss</strong>, I update the default homepage that points to the repo readme on GitHub, because I'll want to create a website for the package with a demo.</li>\n  <li>Keywords: <strong>css, minifier, web, browser</strong>, some tags for GitHub topics and NPM keywords.</li>\n</ul>\n\n<p>I'm then asked to navigate to GitHub to create the first Home wiki page. This needs to be done manually since GitHub does not provide API routes for automation of this procedure. Moreover, because I've configured <em>MNP</em> to use <strong>yarn</strong> as the package manager, the dependencies are also installed automatically. The template also supports <span class=\"tm\">npm</span> with <strong>package-lock.json</strong> file instead of <strong>yarn.lock</strong>. After this is done, the repo is cloned into local working dir, called <span class=\"tm\">trapcss</span> and <em>MNP</em> opens <em>VSCode</em> automatically. A new tag <span class=\"tm\">v0.0.0-pre</span> is added to the git tree.</p>\n\n<p class=\"SectionBreak\">\n  <a title=\"Back To Top\" href=\"#top\">\n    <img alt=\"section break\"\n      src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='13'/%3E\" data-io>\n    <noscript><img alt=\"section break\" src=\"/nodetools/section-breaks/1.svg\"></noscript></a>\n</p>\n</div>\n\n<div data-section id=\"source-code\">\n<h2 id=\"source-code\">Source Code</h2>\n\n<p>As the next step, I'll just download the ZIP archive from <em>DropCSS</em> as the source code, and open finder to copy all files from source into my new package.</p>\n\n<p>The original source is using <em>CommonJS</em> however <em>NodeTools</em> allow to program using ECMA modules with a 0-dependency regex transpiler, so we want to update the source code from <span class=\"tm\">require</span> into imports.</p>\n\n<pre id=\"ccdbf\"><code class=\"javascript hljs\">\"use strict\";\n\nconst { parse: parseHTML } = require('./html');\nconst { parse: parseCSS, generate: generateCSS, SELECTORS, stripEmptyAts } = require('./css');\nconst { some, matchesAttr } = require('./find');\nconst { postProc } = require('./postproc');\nconst { LOGGING } = require('./env');</code></pre>\n\n<p>This can be achieved easily by running the transpiler in <span class=\"tm\">-r</span> mode:</p>\n\n<pre id=\"c724c\"><code class=\"shell hljs\">MacBook:trapcss zavr$ yarn alamode src -r</code></pre>\n\n<p>It will scan the <strong>src</strong> dir recursively, updating all files in there. By using <span class=\"tm\">yarn &lt;alias&gt;</span> I can execute binaries from node_modules installed locally.</p>\n\n\n<p>When trying to simply check that all imports are updated correctly by running <span class=\"tm\">yarn alanode src/dropcss</span> that simply executes all require calls, without actually running the program, I see an error to do with the following:</p>\n\n<pre id=\"ccdbf1\"><code class=\"javascript hljs\">// src/find.js\nfunction some(nodes, m) {\n  return nodes.some(node =&gt; find(m, {\n    idx: m.length - 1,\n    node\n  }));\n}\n\nexport { matchesAttr };\n\nexport const some = (nodes, sel) =&gt; {\n  return some(nodes, Array.isArray(sel) ? sel : parseSel(sel));\n};</code></pre>\n\n<p>The error says:</p>\n\n<pre id=\"c724c1\"><code class=\"shell hljs\">MacBook:trapcss zavr$ yarn alanode src/dropcss.js\n/Users/zavr/adc/trapcss/src/find.js:205\n       const some = (nodes, sel) =&gt; {\n             ^\n\nSyntaxError: Identifier 'some' has already been declared</code></pre>\n\n<p>This is because after updating to imports, we acquired a name conflict. This is fixed simply by renaming the original function into <span class=\"tm\">_some</span> and calling it from the export:</p>\n\n<pre id=\"ccdbf2\"><code class=\"javascript hljs\">// src/find.js\nfunction _some(nodes, m) {\n  // ...\n}\n\nexport const some = (nodes, sel) =&gt; {\n  return _some(nodes, Array.isArray(sel) ? sel : parseSel(sel));\n};</code></pre>\n\n<p>In addition, I don't use semicolons therefore I'll quickly fix that with <em>ESLint</em>. <em>ESLint</em> should be installed globally on the system since it's a huge binary and there's no point in installing it for each single package. If you have your own eslint config, you need to fork the template from <span class=\"tm\">mnpjs/package</span>, define your config in there, and updates the <span class=\"tm\">.mnprc</span> settings to point to your forked template.</p>\n\n<pre id=\"c724c2\"><code class=\"shell hljs\">MacBook:trapcss zavr$ eslint --fix src</code></pre>\n\n<p>As the last step for styling, I want to get rid of all <span class=\"tm\">&quot;use strict&quot;</span> directives on top of each file, by a simple search and replace in <em>VSCode</em>: <span class=\"tm\">&quot;use strict&quot;\\n\\n</span> -> \"\". Finally, I want the entry to the library be located at <strong>src/index.js</strong> instead of <strong>src/dropcss.js</strong>, therefore I copy the typedef from <span class=\"tm\">index.js</span>, delete the file, and rename <span class=\"tm\">dropcss.js</span> into <span class=\"tm\">index.js</span>.</p>\n\n<pre id=\"ccdbf3\"><code class=\"javascript hljs\">// copy typedef\n/**\n * @suppress {nonStandardJsDocs}\n * @typedef {import('../types').trapcss} _trapcss.trapcss\n */</code></pre>\n\n<p>Now I can commit all new source code into git tree, and start testing/documenting the library.</p>\n\n<p class=\"SectionBreak\">\n  <a title=\"Back To Top\" href=\"#top\">\n    <img alt=\"section break\"\n      src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='13'/%3E\" data-io>\n    <noscript><img alt=\"section break\" src=\"/nodetools/section-breaks/2.svg\"></noscript></a>\n</p>\n</div>",
  "file": "trapcss",
  "postAjax": "(function imgPostAjax() {\n  /* eslint-env browser */\n  window['IO']()\n  window['WEBP']()\n})()"
}