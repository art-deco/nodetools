{
  "title": "TrapCSS: NodeTools Tutorial",
  "content": "\n\n<div data-section id=\"trapcss\">\n<h1 id=\"trapcss-nodetools-tutorial\">TrapCSS: NodeTools Tutorial</h1>\n\n<!-- <npm-badge package=\"trapcss\" /> -->\n\n<p>There are CSS frameworks such as <em>Bootstrap</em> that allow to create great layouts quickly, however their size might be quite large. This point is worth considering because CSS is loaded in a blocking fashion: the browser will have to wait before all CSS is loaded to render a web site, which slows page render, and affects usability and even search engine ranking negatively. In many cases, a lot of CSS can be \"dropped\" from frameworks' compiled code, and by leaving only those selectors that are present on a page, or multiple pages. This technique corresponds to the \"Defer unused CSS\" Lighthouse <a href=\"https://developers.google.com/web/tools/lighthouse/audits/unused-css\">warning</a>.</p>\n\n<p>\n  <img class=\"ImageHolder b-vk b-t\" sizes=\"(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px\" alt=\"trap css nodetools tutorial\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1000' height='674'/%3E\">\n  <noscript>\n    <picture>\n      <source\n        srcset=\"/nodetools/pages/trapcss/img/splash-768.webp 768w,/nodetools/pages/trapcss/img/splash-576.webp 576w,/nodetools/pages/trapcss/img/splash-319.webp 319w,/nodetools/pages/trapcss/img/splash-1000.webp 1000w\" sizes=\"(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px\"\n        type=\"image/webp\">\n      <img class=\"b-vk b-t\" onLoad=\"webploaded(this)\" alt=\"trap css nodetools tutorial\" src=\"/nodetools/pages/trapcss/img/splash-768.jpg\" srcset=\"/nodetools/pages/trapcss/img/splash-768.jpg 768w,/nodetools/pages/trapcss/img/splash-576.jpg 576w,/nodetools/pages/trapcss/img/splash-319.jpg 319w,/nodetools/pages/trapcss/img/splash-1000.jpg 1000w\" sizes=\"(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px\">\n    </picture>\n  </noscript>\n</p>\n\n<p>One of the packages that is able to do it quickly is called <a href=\"https://github.com/leeoniya/dropcss\">DropCSS</a>, developed by <a href=\"https://github.com/leeoniya\">Leon Sorokin</a>. It's notable for its speed, simplicity and the amount of bytes that can shaved off the CSS. However, for our use case it was not perfect: it strips comments and does not allow to keep arbitrary annotations, such as <span class=\"tm\">/* alternate */</span> which is needed for <a href=\"https://github.com/artdecocode/closure-stylesheets-java\">Closure Stylesheets</a>. Closure Stylesheets is an optimiser of CSS that can minify and put styles together. Art Deco uses it for Splendid, a static website generator. By collecting selectors across all pages on a generated website, we're able to drop unused Bootstrap rules, and then merge Bootstrap with other styles so that a single, small CSS file is served to visitors quickly.</p>\n\n<p>But Bootstrap contains rules that repeat the CSS properties, e.g.,:</p>\n\n<pre id=\"c1d47\"><code class=\"css hljs\">abbr[title],\nabbr[data-original-title] {\n  text-decoration: underline;\n  -webkit-text-decoration: underline dotted;\n  /* @alternate */\n  text-decoration: underline dotted;\n  /* ^ repeated use, need alternate */\n}</code></pre>\n\n<p>We needed to annotate Bootstrap with the <span class=\"tm\">/* alternate */</span> marker so that the CSS compiler doesn't throw an error. A simple proposed solution to prevent stripping such comments was suggested in form of a <a href=\"https://github.com/leeoniya/dropcss/pull/41\">PR</a> to <em>DropCSS</em> package owner, however was rejected as being too narrow of a use case. Therefore, we decided to fork his project and use its source code to create a professional Node.JS package that would also provide JSDoc annotations, could be tested with context testing, and is ready to be compiled into other packages, such as <em>Splendid</em> itself, so that it's linked statically instead of dynamically as permitted by the original MIT license.</p>\n\n<p>This tutorial walks through the process of upgrading a package to use <em>NodeTools</em> stack with explanation of advantages of using the tools from the stack in creating modern packages. You might want to read the <a href=\"/nodetools/quickGuide\">quick guide</a> first for some details about the standard routine.</p>\n\n<strong>TrapCSS</strong> on <em>GitHub</em>: <a\n   title=\"Removes unused selectors from CSS files to achieve maximum optimisation. Can be used as an API function or with CLI.\" class=\"GitHubBadge\" id=\"c1dbc\" href=\"https://github.com/artdecocode/trapcss\">\n   <span class=\"a\">GitHub</span><span class=\"b\" data-stargazers>‚≠êÔ∏è 1</span></a>\n\n<p class=\"SectionBreak\">\n  <a title=\"Back To Top\" href=\"#top\">\n    <img alt=\"section break\"\n      src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='15'/%3E\" data-io>\n    <noscript><img alt=\"section break\" src=\"/nodetools/section-breaks/0.svg\"></noscript></a>\n</p>\n</div>\n\n<div data-section id=\"mnp\">\n<h2 id=\"mnp\">MNP</h2>\n\n<p>The very first step is to spawn a new package using <span class=\"tm\">mnp</span>. Instead of forking the repo, I will create a new package so that its structure adheres to <em>NodeTools</em>' recommendations. My default organisation is <span class=\"tm\">artdecocode</span> on <em>GitHub</em> and I keep projects in the <span class=\"tm\">~/adc</span> folder. Additionally, I've made a number of other orgs, such as <span class=\"tm\">dpck</span>, <span class=\"tm\">a-la</span> for scopes of other projects. Organising the home dir by org is a convenient method that allows to maintain different settings for different organisations. For standard Node.JS package, I'll just use <span class=\"tm\">adc</span>.</p>\n\n<pre id=\"c414d\"><code class=\"bash hljs\">cd adc\n# mnp --init (if init was not done yet)\nmnp trapcss -n</code></pre>\n\n<p>I've already <a href=\"/nodetools/quick-start-to-nodetools.html#configure-org\">configured mnp</a> prior to creating a package, therefore all settings are already recorded in the <span class=\"tm\">.mnprc</span> file. I pass the package name to the binary, together with the <span class=\"tm\">-n</span> flag, which means <span class=\"tm\">--no-scope</span>: because settings contain a scope (<span class=\"tm\">@artdeco</span>), I want to skip it in this particular case. <em>MNP</em> then asks me questions about the new package:</p>\n\n<pre id=\"c414d1\"><code class=\"bash hljs\"># trapcss\nDescription: Removes unused selectors from CSS files to achieve maximum optimisation. Can be used as an API function or with CLI.\nGenerating repository...\nStarring...\n‚≠êÔ∏è Created and starred a new repository\nhttps://github.com/artdecocode/trapcss\nCloning into '/Users/zavr/adc/trapcss'...\nSetting user Anton&lt;anton@adc.sh&gt;...\nWith binary [y/n]: [y]\nBuild or compile: [compile]\nLicense: [agpl-3.0]\nInit Github Wiki [y/n]: [y]\nHomepage: [https://github.com/artdecocode/trapcss#readme] https://art-deco.github.io/trapcss\nKeywords (e.g., artdecocode, trapcss): css, minifier, web, browser\nPlease go to https://github.com/artdecocode/trapcss/wiki/_new\nto create the first page and press enter when done. (y/n): [y]\nCloning into '/Users/zavr/adc/trapcss/wiki.git'...\nSetting topics...\nInitialised package structure, pushing...\nyarn install v1.13.0\n‚ú®  Done in 2.67s.\nCreated a new package: trapcss.</code></pre>\n\n<p>I've answered questions in the following way:</p>\n\n<ul>\n  <li>With binary: <strong>true</strong>, because I'll want to create a node executable to run from the CLI to drop selectors from CSS files based on HTML files.</li>\n  <li>Build or compile: <strong>compile</strong>, because I want to create a library compatible with Closure so that it can be compiled into <em>Splendid</em> later.</li>\n  <li>License: <strong>agpl-3.0</strong>, my personal preference.</li>\n  <li>Init Github Wiki: <strong>y</strong>, we'll want to create wiki pages with discussion about certain use cases, such as using multiple HTML files to gather selectors list.</li>\n  <li>Homepage: <strong>https://art-deco.github.io/trapcss</strong>, I update the default homepage that points to the repo readme on GitHub, because I'll want to create a website for the package with a demo.</li>\n  <li>Keywords: <strong>css, minifier, web, browser</strong>, some tags for GitHub topics and NPM keywords.</li>\n</ul>\n\n<p>I'm then asked to navigate to GitHub to create the first Home wiki page. This needs to be done manually since GitHub does not provide API routes for automation of this procedure. Moreover, because I've configured <em>MNP</em> to use <strong>yarn</strong> as the package manager, the dependencies are also installed automatically. The template also supports <span class=\"tm\">npm</span> with <strong>package-lock.json</strong> file instead of <strong>yarn.lock</strong>. After this is done, the repo is cloned into local working dir, called <span class=\"tm\">trapcss</span> and <em>MNP</em> opens <em>VSCode</em> automatically. A new tag <span class=\"tm\">v0.0.0-pre</span> is added to the git tree.</p>\n\n<p class=\"SectionBreak\">\n  <a title=\"Back To Top\" href=\"#top\">\n    <img alt=\"section break\"\n      src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='13'/%3E\" data-io>\n    <noscript><img alt=\"section break\" src=\"/nodetools/section-breaks/1.svg\"></noscript></a>\n</p>\n</div>\n\n<div data-section id=\"upgrading-source-code\">\n<h2 id=\"upgrading-source-code\">Upgrading Source Code</h2>\n\n<p>As the next step, I'll just download the ZIP archive from <em>DropCSS</em> as the source code, and open finder to copy all files from source into my new package.</p>\n\n<p>The original source is using <em>CommonJS</em> however <em>NodeTools</em> allow to program using ECMA modules with a 0-dependency regex transpiler, so we want to update the source code from <span class=\"tm\">require</span> into imports.</p>\n\n<pre id=\"ccdbf\"><code class=\"javascript hljs\">\"use strict\";\n\nconst { parse: parseHTML } = require('./html');\nconst { parse: parseCSS, generate: generateCSS, SELECTORS, stripEmptyAts } = require('./css');\nconst { some, matchesAttr } = require('./find');\nconst { postProc } = require('./postproc');\nconst { LOGGING } = require('./env');</code></pre>\n\n<p>This can be achieved easily by running the transpiler in <span class=\"tm\">-r</span> mode:</p>\n\n<pre id=\"c724c\"><code class=\"shell hljs\">MacBook:trapcss zavr$ yarn alamode src -r</code></pre>\n\n<p>It will scan the <strong>src</strong> dir recursively, updating all files in there. By using <span class=\"tm\">yarn &lt;alias&gt;</span> I can execute binaries from node_modules installed locally.</p>\n\n\n<p>When trying to simply check that all imports are updated correctly by running <span class=\"tm\">yarn alanode src/dropcss</span> that simply executes all require calls, without actually running the program, I see an error to do with the following:</p>\n\n<pre id=\"ccdbf1\"><code class=\"javascript hljs\">// src/find.js\nfunction some(nodes, m) {\n  return nodes.some(node =&gt; find(m, {\n    idx: m.length - 1,\n    node\n  }));\n}\n\nexport { matchesAttr };\n\nexport const some = (nodes, sel) =&gt; {\n  return some(nodes, Array.isArray(sel) ? sel : parseSel(sel));\n};</code></pre>\n\n<p>The error says:</p>\n\n<pre id=\"c724c1\"><code class=\"shell hljs\">MacBook:trapcss zavr$ yarn alanode src/dropcss.js\n/Users/zavr/adc/trapcss/src/find.js:205\n       const some = (nodes, sel) =&gt; {\n             ^\n\nSyntaxError: Identifier 'some' has already been declared</code></pre>\n\n<p>This is because after updating to imports, we acquired a name conflict. This is fixed simply by renaming the original function into <span class=\"tm\">_some</span> and calling it from the export:</p>\n\n<pre id=\"ccdbf2\"><code class=\"javascript hljs\">// src/find.js\nfunction _some(nodes, m) {\n  // ...\n}\n\nexport const some = (nodes, sel) =&gt; {\n  return _some(nodes, Array.isArray(sel) ? sel : parseSel(sel));\n};</code></pre>\n\n<p>In addition, I don't use semicolons therefore I'll quickly fix that with <em>ESLint</em>. <em>ESLint</em> should be installed globally on the system since it's a huge binary and there's no point in installing it for each single package. If you have your own eslint config, you need to fork the template from <span class=\"tm\">mnpjs/package</span>, define your config in there, and updates the <span class=\"tm\">.mnprc</span> settings to point to your forked template.</p>\n\n<pre id=\"c724c2\"><code class=\"shell hljs\">MacBook:trapcss zavr$ eslint --fix src</code></pre>\n\n<p>As the last step for styling, I want to get rid of all <span class=\"tm\">&quot;use strict&quot;</span> directives on top of each file, by a simple search and replace in <em>VSCode</em>: <span class=\"tm\">&quot;use strict&quot;\\n\\n</span> -> \"\". Finally, I want the entry to the library be located at <strong>src/index.js</strong> instead of <strong>src/dropcss.js</strong>, therefore I copy the typedef from <span class=\"tm\">index.js</span>, delete the file, and rename <span class=\"tm\">dropcss.js</span> into <span class=\"tm\">index.js</span>.</p>\n\n<pre id=\"ccdbf3\"><code class=\"javascript hljs\">// copy typedef\n/**\n * @suppress {nonStandardJsDocs}\n * @typedef {import('../types').trapcss} _trapcss.trapcss\n */</code></pre>\n\n<p>Now I can commit all new source code into git tree, and start testing/documenting the library.</p>\n\n<p class=\"SectionBreak\">\n  <a title=\"Back To Top\" href=\"#top\">\n    <img alt=\"section break\"\n      src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='13'/%3E\" data-io>\n    <noscript><img alt=\"section break\" src=\"/nodetools/section-breaks/2.svg\"></noscript></a>\n</p>\n</div>\n\n<div data-section id=\"adding-types\">\n<h2 id=\"adding-types\">Adding Types</h2>\n\n<p>After we've copied the typedef, we'll want to make sure that the types are actually correct for our program. The main method accepts a hashmap config, so we'll document its structure in <span class=\"tm\">types/index.xml</span>.</p>\n\n<pre id=\"c16f7\"><code class=\"xml hljs\">&lt;types namespace=\"_trapcss\"&gt;\n  &lt;record name=\"Config\" desc=\"Options for the program.\"&gt;\n    &lt;prop string name=\"html\"&gt;\n      The input HTML.\n    &lt;/prop&gt;\n    &lt;prop string name=\"css\"&gt;\n      The CSS to drop selectors from.\n    &lt;/prop&gt;\n    &lt;prop boolean name=\"keepAlternate\" default=\"false\"&gt;\n      Whether to keep the `@alternate` comment for\n      Closure Stylesheets.\n    &lt;/prop&gt;\n    &lt;fn name=\"shouldDrop\" opt return=\"boolean\"&gt;\n      &lt;arg string name=\"sel\"&gt;The selector to check.&lt;/arg&gt;\n      Whether _TrapCSS_ should remove this selector.\n      The `shouldDrop` hook is called for every CSS selector\n      that could not be matched in the html. Return `false`\n      to retain the selector or `true` to drop it.\n    &lt;/fn&gt;\n  &lt;/record&gt;\n\n  &lt;type record name=\"Return\" desc=\"Return Type.\"&gt;\n    &lt;prop string name=\"css\"&gt;\n      The dropped CSS.\n    &lt;/prop&gt;\n    &lt;prop type=\"!Set&lt;string&gt;\" name=\"sels\"&gt;\n      The used selectors.\n    &lt;/prop&gt;\n  &lt;/type&gt;\n&lt;/types&gt;</code></pre>\n\n<p>We're using the <span class=\"tm\">_trapcss</span> namespace to be able to name our config as <span class=\"tm\">_trapcss.Config</span> and distinguish from other packages' configs that can be defined the same name. The namespace is the feature of <em>VSCode</em> that we use to our advantage, and it's not much different from standard typedefs, only that names of types are preceded with the <span class=\"tm\">_ns</span>. We also add <span class=\"tm\">_</span> underscore as the convention for namespaces' titles, otherwise there might be conflicts between the namespace and some functions in the source code.</p>\n\n<p>There are 3 main types of types: records, interfaces and constructors. Most of all, records are used for configs and simple objects passed around program, while interfaces used to describe methods on classes, which are then annotated with <span class=\"tm\">/* @implements {_ns.Type} */</span> in the source code. Unfortunately, <em>VSCode</em> doesn't understand the implements notation and will not allow to \"put meat\" or grow implementation on the interface defined like that, but this notation is used to enable Closure Compiler type checking. Some examples of <span class=\"tm\">@implements</span> can be found in the <a\n  href=\"https://github.com/idiocc/goa/blob/4b4534c304870ace80a42245ac0303f85b6eb6d3/src/application.js#L18\">\n  Idio web server</a>. The <span class=\"tm\">&lt;type record&gt;...&lt;/type&gt;</span> block can be simplified to <span class=\"tm\">&lt;record&gt;...&lt;/record&gt;</span>.</p>\n\n<p>If a type is defined without record/interface attribute, it's becomes the simplest type in the Closure type system, for example, <span class=\"tm\">{ prop: string, prop2: (number|undefined) }</span>. An object like that is not nullable &mdash; since Closure tries to make JavaScript similar to Java, type nullability is a thing. More complex types, such as records and interfaces are nullable, whereas the <strong>structural interfaces</strong> are not. Here's some more documentation on <a href=\"https://github.com/google/closure-compiler/wiki/Types-in-the-Closure-Type-System\">types</a>. Therefore, when we use a record that is not expected to be nullable, we'll want to add <span class=\"tm\">!</span> in front of it, as shown below.</p>\n\n<p>Not only we document the config type in XML, but also the actual API contract of the library, which is placed in the <strong>types/api.xml</strong> file and describes all available methods that can be imported from our Node.JS library.</p>\n\n<pre id=\"c16f71\"><code class=\"xml hljs\">&lt;types namespace=\"_trapcss\"&gt;\n  &lt;method name=\"trapcss\" return=\"!_trapcss.Return\"&gt;\n    &lt;arg name=\"opts\" type=\"!_trapcss.Config\"&gt;\n      The options for _TrapCSS_.\n    &lt;/arg&gt;\n    Parses the supplied HTML and CSS and removes\n    unused selectors. Also removes empty CSS rules.\n  &lt;/method&gt;\n&lt;/types&gt;</code></pre>\n\n<p>It's the core principle of <em>NodeTools</em> to use XML to store types. You can view it as the design stage that provides a language- and tool-agnostic way to document our software, whereas JS is used for implementation later. We can reuse types for any purpose, such as creating documentation as shown later.</p>\n\n<p>The next thing we want to do is to generate typedefs for <em>VSCode</em> so that we can get working on the source code implementation. The template we used with <em>MNP</em> already has the set up ready for that, we just call <span class=\"tm\">yarn d</span>. This command will update typedefs in <span class=\"tm\">types/index.js</span>, which are then imported in our source code.</p>\n\n<pre id=\"ccdbf4\"><code class=\"javascript hljs\">export {}\n\n/* typal types/api.xml namespace */\n/**\n * @typedef {_trapcss.trapcss} trapcss Parses the supplied HTML and CSS and removes\nunused selectors. Also removes empty CSS rules.\n * @typedef {(opts: _trapcss.Config) =&gt; _trapcss.Return} _trapcss.trapcss Parses the supplied HTML and CSS and removes\nunused selectors. Also removes empty CSS rules.\n */\n\n/**\n * @typedef {import('..').Config} _trapcss.Config\n */\n\n // 1) add the return import\n/**\n * @typedef {import('..').Return} _trapcss.Return\n */</code></pre>\n\n<p>The config is imported from the main JS of the package, which is kept in <span class=\"tm\">compile/index.js</span>. We'll come back to that later, but we also need to import <span class=\"tm2\">(1)</span> the return type manually, as the template's function simply returned a string before. To check that it's been imported correctly, we simply hover over the top declaration.</p>\n\n<p>\n  <img class=\"b-bk b-vk b-t\" alt=\"trapcss api method type\" data-io>\n  <noscript>\n    <img class=\"b-bk b-vk b-t\" alt=\"trapcss api method type\" src=\"/nodetools/pages/trapcss/img/trap.gif\">\n  </noscript>\n</p>\n\n<p>This <strong>types/index.js</strong> file is only used for development purposes, and it's real aim is to provide an annotated function type that is then imported in the source code. We come back to the source code, find our implementation and annotate it with the type:</p>\n\n<pre id=\"ccdbf5\"><code class=\"javascript hljs\">// src/index.js\n// adding @type\n\n/**\n * @type {_trapcss.trapcss}\n */\nfunction dropcss(opts) {\n  let log, START\n\n  if (LOGGING) {\n    START = +new Date()\n    log = [[0, 'Start']]\n  }\n  // ... implementation\n}</code></pre>\n\n<p>Make sure to remember to copy across that typedef with import:</p>\n\n<pre id=\"cb288\"><code class=\"undefined hljs\">/**\n * @suppress {nonStandardJsDocs}\n * @typedef {import('../types').trapcss} _trapcss.trapcss\n */</code></pre>\n\n<p>The <strong>@suppress</strong> is needed because Closure Compiler cannot parse imports in typedefs, so that we skip this warnings. However, this function type is also generated in externs which are fed to the Compiler when compiling packages, so that it will be aware of the type. When using namespaces, we need to be consistent with their namings: if we simply imported <span class=\"tm\">trapcss</span> instead of <span class=\"tm\">_trapcss.trapcss</span>, we'd receive access to <em>VSCode</em> <em>JSDoc</em>, but the compiler wouldn't know about the <span class=\"tm\">trapcss</span> type without the namespace.</p>\n\n<p>\n  <img class=\"b-bk b-vk b-t\" alt=\"importing the trapcss method in implementation for @type annotation\" data-io>\n  <noscript>\n    <img class=\"b-bk b-vk b-t\" alt=\"importing the trapcss method in implementation for @type annotation\" src=\"/nodetools/pages/trapcss/img/trap2.gif\">\n  </noscript>\n</p>\n\n<p>The advantage of such annotation is that the comments will be lost during compilation anyway, so we don't have to waste time maintaining them in the source code itself. If we need to update the API contract, we go to the XML file, make changes there, and generate new annotations and externs using <span class=\"tm\">yarn d</span> command. The externs look like the following:</p>\n\n<pre id=\"ccdbf7\"><code class=\"javascript hljs\">/**\n * @fileoverview\n * @externs\n */\n\n/* typal types/index.xml externs */\n/** @const */\nvar _trapcss = {}\n/**\n * Options for the program.\n * @record\n */\n_trapcss.Config\n/**\n * The input HTML.\n * @type {string}\n */\n_trapcss.Config.prototype.html\n/**\n * The CSS to drop selectors from.\n * @type {string}\n */\n_trapcss.Config.prototype.css\n/**\n * Whether to keep the `@alternate` comment for\n * Closure Stylesheets. Default `false`.\n * @type {boolean|undefined}\n */\n_trapcss.Config.prototype.keepAlternate\n/**\n * Whether _TrapCSS_ should remove this selector.\n * The `shouldDrop` hook is called for every CSS selector\n * that could not be matched in the html. Return `false`\n * to retain the selector or `true` to drop it.\n * @type {(function(string): boolean)|undefined}\n */\n_trapcss.Config.prototype.shouldDrop = function(sel) {}\n/**\n * Return Type.\n * @record\n */\n_trapcss.Return\n/**\n * The dropped CSS.\n * @type {string}\n */\n_trapcss.Return.prototype.css\n/**\n * The used selectors.\n * @type {!Set&lt;string&gt;}\n */\n_trapcss.Return.prototype.sels\n\n/* typal types/api.xml externs */\n/**\n * Parses the supplied HTML and CSS and removes\nunused selectors. Also removes empty CSS rules.\n * @typedef {function(_trapcss.Config): _trapcss.Return}\n */\n_trapcss.trapcss\n</code></pre>\n\n<p>The purpose of externs is to provide type information for Closure Compiler. When using advanced compilation, which we are, property names on objects will get renamed, which is not good when we publish the package with declared config type. By generating an extern, we're making sure that its properties are not renamed. <strong>package.json</strong> file also adds the <span class=\"tm\">&quot;externs&quot;: &quot;types/externs.js&quot;</span> field, so that 3rd party packages that want to compile our package into themselves, will receive access to its types for <em>Closure</em>. This is how <em>NodeTools</em> infrastructure works.</p>\n\n<p>Our standard is to use destructuring on the config to extract its properties for use in the program first thing. If the config was not compulsory, we'd also add <span class=\"tm\">function (config={})</span>, but it's not the case here. When doing this, we also receive the type of the property, so that we're able to receive hints if we need to perform operations on this new objects.</p>\n\n<p>\n  <img class=\"b-bk b-vk b-t\" alt=\"receiving access to property types\" data-io>\n  <noscript>\n    <img class=\"b-bk b-vk b-t\" alt=\"receiving access to property types\" src=\"/nodetools/pages/trapcss/img/trap3.gif\">\n  </noscript>\n</p>\n\n<p>On the screenshot above, you can see how the IDE provides me with autocompletion hint when I'm trying to get access to the <span class=\"tm\">.length</span> property, for example to check that HTML is not empty. This is essential for developer experience of the person who's coding the package, so by simply importing the type, we were able to achieve this productivity without full <em>JSDoc</em> with <span class=\"tm\">@param {Object}</span> comments. Sadly, <em>VSCode</em> does not show the description of the property, otherwise it'd be really perfect, but maybe they can do it in the next version.</p>\n\n<p>So we just update the source code to pass destructured properties, and the new <span class=\"tm\">keepAlternate</span> additional property to the <span class=\"tm2\">parseCSS</span> method. The <span class=\"tm\">keepText</span> second argument for <em>parseHTML</em> is not even accepted by this function, so we remove it.</p>\n\n<pre id=\"ccdbf6\"><code class=\"javascript hljs\">// const H = parseHTML(opts.html, !opts.keepText) =&gt;\n   const H = parseHTML(html)\n\n// const shouldDrop = opts.shouldDrop || drop =&gt;\n// default is now assigned via destructuing\n// above { shouldDrop = drop, ... } = opts\n\n// let tokens = parseCSS(opts.css) =&gt;\n   let tokens = parseCSS(css, keepAlternate)</code></pre>\n\n<p class=\"SectionBreak\">\n  <a title=\"Back To Top\" href=\"#top\">\n    <img alt=\"section break\"\n      src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='9'/%3E\" data-io>\n    <noscript><img alt=\"section break\" src=\"/nodetools/section-breaks/3.svg\"></noscript></a>\n</p>\n</div>\n\n<div data-section id=\"initial-documentation\">\n<h2 id=\"initial-documentation\">Initial Documentation</h2>\n\n<p>Before we continue to adding actual logic to allow to preserve <em>alternate</em> comments, let's add some documentation to <em>TrapCSS</em>. The docs are kept in the <strong>documentary</strong> folder and are split by files, which are put in order by documentation software. The <strong>index.md</strong> and <strong>footer.md</strong> files in each of the inner dirs always go first and last respectively. The root <strong>index.md</strong> already contains the description which was placed in there by <em>MNP</em>. It also has the installation snippet and table of contents. But we can add some more text from the forked package to describe what the software will do, and some additional links.</p>\n\n<pre id=\"c1953\"><code class=\"markdown hljs\">&lt;!-- documentary/index.md --&gt;\n```sh\nyarn add trapcss\nnpm install -D trapcss\n```\n\n## Introduction\n\n_TrapCSS_ takes your HTML and CSS as input and returns only\nthe used CSS as output. Its custom HTML and CSS parsers are\nhighly optimized for the 99% use case and thus avoid the\noverhead of handling malformed markup or stylesheets, ...\n\n&lt;kbd&gt;üìô [READ WIKI PAGES](../../wiki)&lt;/kbd&gt;\n\n%~%\n\n%TOC%\n\n%~%</code></pre>\n\n<p>We'll give a link to wiki which contains some more detailed information, which will be compiled later. We use section breaks like <span class=\"tm\">%~%</span> which insert visual separators between sections.</p>\n\n<p>The <strong>api/index.md</strong> also contains essential data for generation of the README file:</p>\n\n<pre id=\"c19531\"><code class=\"markdown hljs\">&lt;typedef method=\"trapcss\"&gt;types/api.xml&lt;/typedef&gt;\n\n&lt;typedef&gt;types/index.xml&lt;/typedef&gt;\n\n%EXAMPLE: example, ../src =&gt; trapcss%\n%FORK example%</code></pre>\n\n<p><em>Documentary</em> uses components and markers. The typedef component allows to place method headings (when <span class=\"tm\">method=</span> attribute is given) and markdown tables with record descriptions.</p>\n\n<p>The typedefs will result in the following generated text:</p>\n\n<pre id=\"c19532\"><code class=\"markdown hljs\">## &lt;code&gt;&lt;ins&gt;trapcss&lt;/ins&gt;(&lt;/code&gt;&lt;sub&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;`opts: Config,`&lt;br/&gt;&lt;/sub&gt;&lt;code&gt;): &lt;i&gt;Return&lt;/i&gt;&lt;/code&gt;\nParses the supplied HTML and CSS and removes\nunused selectors. Also removes empty CSS rules.\n\n - &lt;kbd&gt;&lt;strong&gt;opts*&lt;/strong&gt;&lt;/kbd&gt; &lt;em&gt;&lt;code&gt;&lt;a href=\"#type-config\" title=\"Options for the program.\"&gt;Config&lt;/a&gt;&lt;/code&gt;&lt;/em&gt;: The options for _TrapCSS_.\n\n__&lt;a name=\"type-config\"&gt;`Config`&lt;/a&gt;__: Options for the program.\n\n\n|     Name      |               Type                |                                                                                                     Description                                                                                                      | Default |\n| ------------- | --------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- |\n| __html*__     | &lt;em&gt;string&lt;/em&gt;                   | The input HTML.                                                                                                                                                                                                      | -       |\n| __css*__      | &lt;em&gt;string&lt;/em&gt;                   | The CSS to drop selectors from.                                                                                                                                                                                      | -       |\n| keepAlternate | &lt;em&gt;boolean&lt;/em&gt;                  | Whether to keep the `@alternate` comment for&lt;br/&gt;Closure Stylesheets.                                                                                                                                                | `false` |\n| shouldDrop    | &lt;em&gt;(sel: string) =&gt; boolean&lt;/em&gt; | Whether _TrapCSS_ should remove this selector.&lt;br/&gt;The `shouldDrop` hook is called for every CSS selector&lt;br/&gt;that could not be matched in the html. Return `false`&lt;br/&gt;to retain the selector or `true` to drop it. | -       |\n\n\n__&lt;a name=\"type-return\"&gt;`Return`&lt;/a&gt;__: Return Type.\n\n\n|   Name    |            Type             |     Description     |\n| --------- | --------------------------- | ------------------- |\n| __css*__  | &lt;em&gt;string&lt;/em&gt;             | The dropped CSS.    |\n| __sels*__ | &lt;em&gt;!Set&amp;lt;string&amp;gt;&lt;/em&gt; | The used selectors. |</code></pre>\n\n<p>which looks like on the screenshot below:</p>\n\n<p>\n  <img class=\"ImageHolder b-bk b-vk b-t\" sizes=\"(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px\" alt=\"generated method heading and types\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='777' height='622'/%3E\">\n  <noscript>\n    <picture>\n      <source\n        srcset=\"/nodetools/pages/trapcss/img/trap-768.webp 768w,/nodetools/pages/trapcss/img/trap-576.webp 576w,/nodetools/pages/trapcss/img/trap-319.webp 319w,/nodetools/pages/trapcss/img/trap-777.webp 777w\" sizes=\"(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px\"\n        type=\"image/webp\">\n      <img class=\"b-bk b-vk b-t\" onLoad=\"webploaded(this)\" alt=\"generated method heading and types\" src=\"/nodetools/pages/trapcss/img/trap-768.png\" srcset=\"/nodetools/pages/trapcss/img/trap-768.png 768w,/nodetools/pages/trapcss/img/trap-576.png 576w,/nodetools/pages/trapcss/img/trap-319.png 319w,/nodetools/pages/trapcss/img/trap-777.png 777w\" sizes=\"(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px\">\n    </picture>\n  </noscript>\n</p>\n\n<p>To generate README, we run the <span class=\"tm\">yarn doc</span> command that consists of: <span class=\"tm\">doc [documentary]</span></p>\n\n<ul>\n  <li><strong>-o README.md</strong>: the output file</li>\n  <li><strong>-n _trapcss</strong>: the root namespace</li>\n  <li><strong>-a</strong>: generate annotations into <span class=\"tm2\">typedefs.json</span></li>\n  <li><strong>-d</strong>: verbose debug logging</li>\n</ul>\n\n<p>The default location for input is <strong>documentary</strong> but it can be changed. Method headings can also be <a href=\"https://github.com/artdecocode/documentary/wiki/Custom-Methods\">customised</a> using your own <span class=\"tm\">&lt;method&gt;</span> component. Once again, the dev process for documentation is fully automated and provides customisation strategies so you can express your own creativity with custom method headings. Submit <a href=\"/nodetools/#getting-help\">an issue</a> if you run into difficulties during customisation.</p>\n\n<h3 id=\"examples-to-outputs\">Examples To Outputs</h3>\n\n<p>The second most useful feature of <em>NodeTools</em> after the compiler is the ability to automatically place examples into README, and compute their output which is also added to README. We use the <span class=\"tm\">%EXAMPLE%</span> marker to reference the example file that comes from the <strong>examples</strong> folder. Let's write an example for our program with some HTML and CSS to see if it works.</p>\n\n<pre id=\"c10fc\"><code class=\"md hljs\">%EXAMPLE: example, ../src =&gt; trapcss%</code></pre>\n\n<p>When placing examples, we can actually rename the local import into the package name so it looks professional to our users who can then just copy and paste the example into their own code.</p>\n\n<pre id=\"ccdbf8\"><code class=\"javascript hljs\">import trapcss from '../src'\n\nlet html = `\n    &lt;html&gt;\n        &lt;head&gt;&lt;/head&gt;\n        &lt;body&gt;\n            &lt;p&gt;Hello World!&lt;/p&gt;\n        &lt;/body&gt;\n    &lt;/html&gt;\n`\n\nlet css = `\n    html {\n      background: yellow;\n      /* @alternate */\n      background: green;\n    }\n    .card {\n      padding: 8px;\n    }\n    p:hover a:first-child {\n      color: red;\n    }\n`\n\nconst whitelist = /#foo|\\.bar/\n\nlet dropped = new Set()\n\nlet cleaned = trapcss({\n  html,\n  css,\n  shouldDrop(sel) {\n    if (whitelist.test(sel))\n      return false\n    else {\n      dropped.add(sel)\n      return true\n    }\n  },\n})\n\nconsole.log(cleaned.css)\n\nconsole.error(dropped)</code></pre>\n\n<p>To test example before actually compiling docs, we can call <span class=\"tm\">alanode</span> which is simple proxy to Node with require hook that transpiles imports.</p>\n\n<pre id=\"c414d2\"><code class=\"bash hljs\">MacBook:trapcss zavr$ alanode example/\nhtml{background: yellow;background: green;}\nSet { '.card', 'p:hover a:first-child' }</code></pre>\n\n<p>The example is working fine, so we can embed it. We're going to modify the markdown file in the following way:</p>\n\n<pre id=\"c19533\"><code class=\"markdown hljs\">&lt;!-- was --&gt;\n&lt;!-- %FORK example% --&gt;\n&lt;!-- now: --&gt;\n\n%FORK-css example%\n%FORKERR-js example%</code></pre>\n\n<p>It's possible to fork a single process and then output both stdout and stderr streams into the documentation. The language of the fork is also given after <span class=\"tm\">FORK-{lang}</span> which means that stdout will be printed as CSS and the stdout as JS code block. Forked JS files are also cached so that if the example and/or any of its dependencies changed, the data will be read from cache which saves a lot of time for more complex programs that might call external APIs or system IO. Specifying language enables syntax highlighting on <em>GitHub</em> so that docs will look neat.</p>\n\n<p>\n  <img class=\"ImageHolder b-vk b-t\" sizes=\"(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px\" alt=\"example with syntax highlighting on github\" src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='808' height='120'/%3E\">\n  <noscript>\n    <picture>\n      <source\n        srcset=\"/nodetools/pages/trapcss/img/trap2-768.webp 768w,/nodetools/pages/trapcss/img/trap2-576.webp 576w,/nodetools/pages/trapcss/img/trap2-319.webp 319w,/nodetools/pages/trapcss/img/trap2-808.webp 808w\" sizes=\"(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px\"\n        type=\"image/webp\">\n      <img class=\"b-vk b-t\" onLoad=\"webploaded(this)\" alt=\"example with syntax highlighting on github\" src=\"/nodetools/pages/trapcss/img/trap2-768.png\" srcset=\"/nodetools/pages/trapcss/img/trap2-768.png 768w,/nodetools/pages/trapcss/img/trap2-576.png 576w,/nodetools/pages/trapcss/img/trap2-319.png 319w,/nodetools/pages/trapcss/img/trap2-808.png 808w\" sizes=\"(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px\">\n    </picture>\n  </noscript>\n</p>\n\n<p>When documenting code, we can keep <em>Documentary</em> running with the <span class=\"tm\">yarn doc -p [commit message]</span> command. It will watch for changes in the source folder, as well as any assets such as examples, automatically replace the last commit when changes are detected, and force push the new git tree. So we can work on examples and styling of the docs, and immediately see updates on <em>GitHub</em>.</p>\n\n<p>At this point, without having written any tests, we already confirmed that our package is working correctly, because we managed to execute the example and place its output into the README file. This is called using documentation for quality assurance, as it lets us see the expected output. If the output was different from the one we wanted (or no output at all), we'd realise that by the time our documentation is placed on <em>GitHub</em> (in automatic mode) or in git diffs (when running single <span class=\"tm\">yarn doc</span> command).</p>\n\n<p class=\"SectionBreak\">\n  <a title=\"Back To Top\" href=\"#top\">\n    <img alt=\"section break\"\n      src=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='9'/%3E\" data-io>\n    <noscript><img alt=\"section break\" src=\"/nodetools/section-breaks/4.svg\"></noscript></a>\n</p>\n</div>",
  "file": "trapcss",
  "postAjax": "(function imgPostAjax() {\n  /* eslint-env browser */\n  window['IO']()\n  window['WEBP']()\n})()"
}