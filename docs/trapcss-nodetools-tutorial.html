<!doctype html>
<html class="no-js b-Op" lang="en">
  <head>
    <meta charset="utf-8">
    <title>TrapCSS: NodeTools Tutorial</title>
    <meta
      content="A use case of using NodeTools stack to upgrade an existing Node.JS package called DropCSS into a library and binary compiled with Closure Compiler." name="description">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link sizes="57x57" rel="apple-touch-icon" href="/nodetools/img/fav-57.png">
    <link sizes="76x76" rel="apple-touch-icon" href="/nodetools/img/fav-76.png">
    <link sizes="120x120" rel="apple-touch-icon" href="/nodetools/img/fav-120.png">
    <link sizes="152x152" rel="apple-touch-icon" href="/nodetools/img/fav-152.png">
    <link sizes="167x167" rel="apple-touch-icon" href="/nodetools/img/fav-167.png">
    <link sizes="180x180" rel="apple-touch-icon" href="/nodetools/img/fav-180.png">
    <link sizes="192x192" rel="icon" href="/nodetools/img/fav-192.png">
    <link sizes="128x128" rel="icon" href="/nodetools/img/fav-128.png">
    <link sizes="32x32" rel="icon" href="/nodetools/img/fav-32.png">
    <link
      href="https://fonts.googleapis.com/css?display=swap&amp;family=Ruda%3A400%2C700%7CMr%20De%20Haviland" rel="preload" as="fetch" crossOrigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin>
    <link href="https://fonts.googleapis.com/css?family=Source%20Code%20Pro%3A400%2C700" rel="preload"
      as="style">
    <script>
      (function(b){var a=document.createElement("link");a.href=b;a.rel="stylesheet";a.crossOrigin="crossorigin";document.head.appendChild(a)})('https://fonts.googleapis.com/css?family=Source%20Code%20Pro%3A400%2C700')
    </script>
    <style id="cpt">
      
        h1 { font-family: 'Mr De Haviland' }
    
      @font-face {
        font-family: 'Mr De Haviland';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: local('Mr De Haviland Regular'), local('MrDeHaviland-Regular'), url('data:application/font-woff2;base64,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') format('woff2');
      }
      
    </style>
    <script>
      (function(){var b=/url\('([\s\S]+?)'\)/.exec(document.head.querySelector("#cpt").textContent);if(b){var a=document.createElement("link");a.rel="preload";a.as="font";a.href=b[1];document.head.appendChild(a)}})()
    </script>
    <script>(function(h,r){var a=Object.keys(h),c=!0;"CSS"in window&&"supports"in CSS?(a=a.reduce(function(k,b){var l=h[b];b=b.split("|");for(var m=!1,d={},f=0;f<b.length;d={a:d.a},f++)if(d.a=b[f],l.map(function(n){return function(e){e=e.split("|");for(var p=!1,g=0;g<e.length;g++){var q=e[g];if(CSS.supports(n.a,q)){p=!0;break}else k.push(n.a+": "+q)}return p}}(d)).filter(Boolean).length==l.length){m=!0;break}m||(c=!1);return k},[]),a.length?c&&console.log("\ud83d\udcbf Browser does not support CSS properties: %s",
a.join("\n "),"but supports alternatives."):console.log("\ud83d\udcbd Browser supports all modern CSS properties.")):(c=!1,console.log("\ud83d\udce0 Browser does not support CSS checks."));c||(a=document.createElement("link"),a.rel="stylesheet",a.href=r,document.head.appendChild(a))})({"align-self":["center"],"flex-grow|-ms-flex-positive":["1"],"flex|-ms-flex":["0 0 25%"],"display":["flex|-ms-flexbox"],"box-sizing":["border-box"],"order|-ms-flex-order":["1"],"flex-direction|-ms-flex-direction":["column"],"border-radius":[".25rem"],"box-shadow":["none"],"flex-basis|-ms-flex-preferred-size":["0"],"hyphens|-webkit-hyphens|-ms-hyphens":["auto"],"justify-content":["center"],"flex-wrap|-ms-flex-wrap":["wrap"],"flex-shrink|-ms-flex-negative":["0"],"position":["sticky|-webkit-sticky"],"align-items":["center"]}, '/nodetools/css/combined-prefixes.css')</script>
    <script>
      (function(q,k){function x(a){for(var f=/url\((.+?)\).*?;\s+unicode-range: (.+?);/g,b={},d=[],h;h=f.exec(a);){var r=h[2];d.push({url:h[1],a:r});b[r]=1}b=Object.keys(b).reduce(function(c,e){var g=e.split(/,\s/).map(function(l){return l.replace("U+","\\u").replace("-","-\\u")}).join("").toLowerCase();c[e]=new RegExp("["+g+"]");return c},{});var t=document.body?document.body.textContent:"",y=t?Object.keys(b).reduce(function(c,e){b[e].test(t)&&(c[e]=!0);return c},{}):Object.keys(b).reduce(function(c,
      e){e in k&&(c[e]=!0);return c},{});m=d.filter(function(c){return c.a in y}).map(function(c){return c.url});if(!m.length)return u();var v=document.createDocumentFragment();m.forEach(function(c,e){var g=document.createElement("link");g.href=c;g.rel="preload";g.as="font";var l=e+1;;g.onload=function(){return u(l)};g.setAttribute("crossorigin",!0);v.appendChild(g)});document.head.appendChild(v)}k=void 0===k?{}:k;var n=document.createElement("link");if(function(a,
      f){if(!a||!a.supports)return!1;try{return a.supports(f)}catch(b){return!1}}(n.relList,"preload")){var z=function(a,f,b){b=void 0===b?"":b;;var d=new XMLHttpRequest;d.onreadystatechange=function(){4==d.readyState&&(200==d.status?(f(d.responseText)):console.error("Error loading webfont: server responded with code %s at %s",d.status,a))};d.open("GET",a);try{d.send(null)}catch(h){console.error(h)}};
      ;var p;(function(a,f){z(a.href,function(b){p=b;x(p)},"-"+(void 0===f?"link":f))})({href:q},"js");var m=[],w=0,u=function(a){w++;w>=m.length&&(a=document.createElement("style"),a.innerHTML=p,document.head.appendChild(a))}}else n.rel="stylesheet",n.href=q,document.head.appendChild(n)})('https://fonts.googleapis.com/css?display=swap&family=Ruda%3A400%2C700%7CMr%20De%20Haviland', {"U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD":true})
    </script>
    <link rel="stylesheet" href="/nodetools/css/combined.css">
    <link rel="preload" as="style" href="/nodetools/highlight.js/styles/default.css">
    <style>
      .no-js [data-io], .no-js .ImageHolder, .no-js [data-loading] { display: none!important }
      .List {
                          font-size:small;
                        }
                        .List > a {
                          display: block!important;
                        }
    </style>
    <noscript>
      <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?display=swap&amp;family=Mr%20De%20Haviland&amp;text=TrapCSS%3A%20NodeTools%20Use%20Case">
      <link rel="stylesheet" href="/nodetools/css/combined-prefixes.css">
      <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?display=swap&amp;family=Ruda%3A400%2C700%7CMr%20De%20Haviland">
      <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Source%20Code%20Pro%3A400%2C700">
    </noscript>
    <script defer src="/nodetools/js/polyfill/intersection-observer.js"></script>
    <script defer src="/nodetools/js/images.js"></script>
    <script crossorigin data-src="/nodetools/preact/dist/preact.min.js"></script>
    <script crossorigin data-src="/nodetools/comps/common.js"></script>
    <script crossorigin data-src="/nodetools/comps/trapcss.js"></script>
    <script>
      document.documentElement.classList.remove("no-js")
    </script>
  </head>
  <body class="b-Mk b-Ol b-Op">
    
    <main class="b-Xl" role="main">
      <div class="b-z">
        <div class="b-B">
          <div class="left-column b-hb">
            <div class="b-kC">
            
                <img class="ImageHolder b-t b-vk" sizes="(max-width: 575.8px) 100vw,(max-width: 767.8px) 510px,(max-width: 991.8px) 150px,(max-width: 1199.8px) 210px,255px" alt="@artdeco/nodetools logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='400'/%3E">
                <noscript>
                  <picture>
                    <source srcset="/nodetools/img/splash-576.webp 576w,/nodetools/img/splash-319.webp 319w,/nodetools/img/splash-600.webp 600w"
                      sizes="(max-width: 575.8px) 100vw,(max-width: 767.8px) 510px,(max-width: 991.8px) 150px,(max-width: 1199.8px) 210px,255px" type="image/webp">
                    <img class="b-t b-vk" onLoad="webploaded(this)" alt="@artdeco/nodetools logo" src="/nodetools/img/splash-576.jpg" srcset="/nodetools/img/splash-576.jpg 576w,/nodetools/img/splash-319.jpg 319w,/nodetools/img/splash-600.jpg 600w" sizes="(max-width: 575.8px) 100vw,(max-width: 767.8px) 510px,(max-width: 991.8px) 150px,(max-width: 1199.8px) 210px,255px">
                  </picture>
                </noscript>
              </div>
              <div class="b-kC">
                <a title="The NodeTools Stack Website." class="GitHubBadge" id="cacd9"
                  href="https://github.com/art-deco/nodetools">
                  <span class="a">GitHub</span><span class="b" data-stargazers>⭐️ 1</span></a>
                
                
                
              </div>
              <h3 id="pages">Pages</h3>
              <ul>
                <li class><a data-file="index" href="/nodetools/">NodeTools: Node.JS Stack</a></li>
                <li class>
                  <a data-file="quick-start" href="/nodetools/quick-start-to-nodetools.html">Quick Start To NodeTools</a>
                </li>
                <li class="Active">
                  <a data-file="trapcss" href="/nodetools/trapcss-nodetools-tutorial.html">TrapCSS: NodeTools Tutorial</a>
                </li>
                <li class>
                  <a data-file="babel" href="/nodetools/babel-when-open-source-is-not-free-sofware.html">
                    Babel: When Open Source Is Not Free Sofware</a>
                </li>
                <li class>
                  <a data-file="discussion" href="/nodetools/discussion-for-nodetools.html">Discussion for NodeTools</a>
                </li>
              </ul>
              <h3 id="stack">Stack</h3>
              <div class="List b-xq b-kC">
                <a
                  title="Create Packages From GitHub Templates. My New Package is an installer of new packages via GitHub templates: create a template and add an automated script to CLI questions, update files, access GitHub API and spawn commands during generation." class="NPMBadge" href="https://www.npmjs.com/package/mnp">
                  <span class="a"><em>MNP</em></span><span class="b">1.1.0</span></a>
                <a
                  title="Organises TypeDefs By Placing Them Into Types.Xml File To Be Embedded Into Source Code Compatible With VSCode And Google Closure Compiler, Generates Externs And Allows To Place Documentation In README Markdown." class="NPMBadge" href="https://www.npmjs.com/package/typal">
                  <span class="a"><em>Typal</em></span><span class="b">1.26.0</span></a>
                <a
                  title="Proper Node.JS Package Compiler (And Front-End Code Bundler) With Closure Compiler. Can create a single executable JS file and merge and optimise all dependencies." class="NPMBadge" href="https://www.npmjs.com/package/depack">
                  <span class="a"><em>Depack</em></span><span class="b">1.1.0</span></a>
                <a
                  title="A Regex-Based Transpiler Of Source Code To Allow Writing Import And Export Statements And JSX With 0 Dependencies." class="NPMBadge" href="https://www.npmjs.com/package/alamode">
                  <span class="a"><em>ÀLaMode</em></span><span class="b">3.3.1</span></a>
                <a
                  title="The 2019 Most Modern Testing Framework For Node.JS With Test Contexts (Reusable BeforeEach / AfterEach Via Separate Files); Masks (Inputs/Outputs In Non-Js Files) And Fork Testing; Interactive Snapshots." class="NPMBadge" href="https://www.npmjs.com/package/zoroaster">
                  <span class="a"><em>Zoroaster</em></span><span class="b">4.1.2</span></a>
                <a
                  title="Documentation Compiler To Generate The Table Of Contents, Embed Examples With Their Output, Make Markdown Tables, Maintain Typedefs For JavaScript And README, Watch Changes To Push, Use Macros And Prettify API Titles." class="NPMBadge" href="https://www.npmjs.com/package/documentary">
                  <span class="a"><em>Documentary</em></span><span class="b">1.35.9</span></a>
              </div>
              <h3 id="web-software">Web Software</h3>
              <div class="List b-xq b-kC">
                <a
                  title="2-Dependency Koa Web Server Compiled With Closure Compiler And Bundled With Essential Middleware: Static, Compress, Session, Cors, File Upload, Router And JSX Front End." class="NPMBadge" href="https://www.npmjs.com/package/@idio/idio">
                  <span class="a"><em>Idio</em></span><span class="b">1.2.3</span></a>
                <a
                  title="Static Web Site Compiler That Uses Closure Compiler For JS Bundling And Closure Stylesheets For CSS optimisations. Supports JSX Syntax To Write Static Elements And Dynamic Preact Components." class="NPMBadge" href="https://www.npmjs.com/package/splendid">
                  <span class="a"><em>Splendid</em></span><span class="b">1.16.13</span></a>
              </div>
              <h3 id="misc">Misc</h3>
              <ul>
                <li><a href="https://gitter.im/node_tools/community">Get Help In Gitter Chat</a></li>
                <li><a href="https://opencollective.com/nodetools">Fund Us On Open Collective</a></li>
              </ul>
              <div class="SideBarMenu sidebarshowing b-jr b-zp">
                <div class="a">
                  
                                  <h3 id="-on-this-page"> On This Page</h3>
                                  <ul id="OnThisPage"><li data-heading="trapcss"><a href="#trapcss">TrapCSS</a></li><li data-heading="mnp"><a href="#mnp">MNP</a></li><li data-heading="source-code"><a href="#source-code">Source Code</a></li><li data-heading="adding-types"><a href="#adding-types">Adding Types</a></li></ul>
                                  <h3 id="share-nodetools">Share NodeTools</h3>
                                  <span class="b-xq b-Hk" id="c485b"><span class="b-Hk" style="height:32px" data-loading>Loading sharing buttons...</span><noscript>Please enable JavaScript to Share</noscript></span>
                                  
                                  <div class="b-xq" id="updates-div">Loading web-push...</div>
                                  <details id="NewsletterDetails">
                                    <summary>
                                      <h3 id="newsletter">Newsletter</h3>
                                    </summary>
                                    <div id="emails-div">Loading widget...</div>
                                  </details>
                                
                </div>
                <a id="HideMenu" style="color:grey!important;" href="#">hide menu</a>
                <a id="ShowMenu" style="color:grey!important;" href="#">show menu</a>
              </div>
          </div>
          
          <div class="right-column b-xq b-nb" id="Content">
            
            
            <div data-section id="trapcss">
            <h1 id="trapcss-nodetools-use-case">TrapCSS: NodeTools Use Case</h1>
            
            <p>There are CSS frameworks such as <em>Bootstrap</em> that allow to create great layouts quickly, however their size might be quite large. This point is worth considering because CSS is loaded in a blocking fashion: the browser will have to wait before all CSS is loaded to render a web site, which slows page render, and affects usability and even search engine ranking negatively. In many cases, a lot of CSS can be "dropped" from frameworks' compiled code, and by leaving only those selectors that are present on a page, or multiple pages. This technique corresponds to the "Defer unused CSS" Lighthouse <a href="https://developers.google.com/web/tools/lighthouse/audits/unused-css">warning</a>.</p>
            
            <p>
              <img class="ImageHolder b-vk b-t" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px" alt="trap css nodetools tutorial" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1000' height='674'/%3E">
              <noscript>
                <picture>
                  <source
                    srcset="/nodetools/pages/trapcss/img/splash-768.webp 768w,/nodetools/pages/trapcss/img/splash-576.webp 576w,/nodetools/pages/trapcss/img/splash-319.webp 319w,/nodetools/pages/trapcss/img/splash-1000.webp 1000w" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px"
                    type="image/webp">
                  <img class="b-vk b-t" onLoad="webploaded(this)" alt="trap css nodetools tutorial" src="/nodetools/pages/trapcss/img/splash-768.jpg" srcset="/nodetools/pages/trapcss/img/splash-768.jpg 768w,/nodetools/pages/trapcss/img/splash-576.jpg 576w,/nodetools/pages/trapcss/img/splash-319.jpg 319w,/nodetools/pages/trapcss/img/splash-1000.jpg 1000w" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px">
                </picture>
              </noscript>
            </p>
            
            <p>One of the packages that is able to do it quickly is called <a href="https://github.com/leeoniya/dropcss">DropCSS</a>, developed by <a href="https://github.com/leeoniya">Leon Sorokin</a>. It's notable for its speed, simplicity and the amount of bytes that can shaved off the CSS. However, for our use case it was not perfect: it strips comments and does not allow to keep arbitrary annotations, such as <span class="tm">/* alternate */</span> which is needed for <a href="https://github.com/artdecocode/closure-stylesheets-java">Closure Stylesheets</a>. Closure Stylesheets is an optimiser of CSS that can minify and put styles together. Art Deco uses it for Splendid, a static website generator. By collecting selectors across all pages on a generated website, we're able to drop unused Bootstrap rules, and then merge Bootstrap with other styles so that a single, small CSS file is served to visitors quickly.</p>
            
            <p>But Bootstrap contains rules that repeat the CSS properties, e.g.,:</p>
            
            <pre id="c1d47"><code class="css hljs">abbr[title],
abbr[data-original-title] {
  text-decoration: underline;
  -webkit-text-decoration: underline dotted;
  /* @alternate */
  text-decoration: underline dotted;
  /* ^ repeated use, need alternate */
}</code></pre>
            
            <p>We needed to annotate Bootstrap with the <span class="tm">/* alternate */</span> marker so that the CSS compiler doesn't throw an error. A simple proposed solution to prevent stripping such comments was suggested in form of a <a href="https://github.com/leeoniya/dropcss/pull/41">PR</a> to <em>DropCSS</em> package owner, however was rejected as being too narrow of a use case. Therefore, we decided to fork his project and use its source code to create a professional Node.JS package that would also provide JSDoc annotations, could be tested with context testing, and is ready to be compiled into other packages, such as <em>Splendid</em> itself, so that it's linked statically instead of dynamically as permitted by the original MIT license.</p>
            
            <p>This tutorial walks through the process of upgrading a package to use <em>NodeTools</em> stack with explanation of advantages of using the tools from the stack in creating modern packages. You might want to read the <a href="/nodetools/quickGuide">quick guide</a> first for some details about the standard routine.</p>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='15'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/0.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="mnp">
            <h2 id="mnp">MNP</h2>
            
            <p>The very first step is to spawn a new package using <span class="tm">mnp</span>. Instead of forking the repo, I will create a new package so that its structure adheres to <em>NodeTools</em>' recommendations. My default organisation is <span class="tm">artdecocode</span> on <em>GitHub</em> and I keep projects in the <span class="tm">~/adc</span> folder. Additionally, I've made a number of other orgs, such as <span class="tm">dpck</span>, <span class="tm">a-la</span> for scopes of other projects. Organising the home dir by org is a convenient method that allows to maintain different settings for different organisations. For standard Node.JS package, I'll just use <span class="tm">adc</span>.</p>
            
            <pre id="c414d"><code class="bash hljs">cd adc
# mnp --init (if init was not done yet)
mnp trapcss -n</code></pre>
            
            <p>I've already <a href="/nodetools/quick-start-to-nodetools.html#configure-org">configured mnp</a> prior to creating a package, therefore all settings are already recorded in the <span class="tm">.mnprc</span> file. I pass the package name to the binary, together with the <span class="tm">-n</span> flag, which means <span class="tm">--no-scope</span>: because settings contain a scope (<span class="tm">@artdeco</span>), I want to skip it in this particular case. <em>MNP</em> then asks me questions about the new package:</p>
            
            <pre id="c414d1"><code class="bash hljs"># trapcss
Description: Removes unused selectors from CSS files to achieve maximum optimisation. Can be used as an API function or with CLI.
Generating repository...
Starring...
⭐️ Created and starred a new repository
https://github.com/artdecocode/trapcss
Cloning into '/Users/zavr/adc/trapcss'...
Setting user Anton&lt;anton@adc.sh&gt;...
With binary [y/n]: [y]
Build or compile: [compile]
License: [agpl-3.0]
Init Github Wiki [y/n]: [y]
Homepage: [https://github.com/artdecocode/trapcss#readme] https://art-deco.github.io/trapcss
Keywords (e.g., artdecocode, trapcss): css, minifier, web, browser
Please go to https://github.com/artdecocode/trapcss/wiki/_new
to create the first page and press enter when done. (y/n): [y]
Cloning into '/Users/zavr/adc/trapcss/wiki.git'...
Setting topics...
Initialised package structure, pushing...
yarn install v1.13.0
✨  Done in 2.67s.
Created a new package: trapcss.</code></pre>
            
            <p>I've answered questions in the following way:</p>
            
            <ul>
              <li>With binary: <strong>true</strong>, because I'll want to create a node executable to run from the CLI to drop selectors from CSS files based on HTML files.</li>
              <li>Build or compile: <strong>compile</strong>, because I want to create a library compatible with Closure so that it can be compiled into <em>Splendid</em> later.</li>
              <li>License: <strong>agpl-3.0</strong>, my personal preference.</li>
              <li>Init Github Wiki: <strong>y</strong>, we'll want to create wiki pages with discussion about certain use cases, such as using multiple HTML files to gather selectors list.</li>
              <li>Homepage: <strong>https://art-deco.github.io/trapcss</strong>, I update the default homepage that points to the repo readme on GitHub, because I'll want to create a website for the package with a demo.</li>
              <li>Keywords: <strong>css, minifier, web, browser</strong>, some tags for GitHub topics and NPM keywords.</li>
            </ul>
            
            <p>I'm then asked to navigate to GitHub to create the first Home wiki page. This needs to be done manually since GitHub does not provide API routes for automation of this procedure. Moreover, because I've configured <em>MNP</em> to use <strong>yarn</strong> as the package manager, the dependencies are also installed automatically. The template also supports <span class="tm">npm</span> with <strong>package-lock.json</strong> file instead of <strong>yarn.lock</strong>. After this is done, the repo is cloned into local working dir, called <span class="tm">trapcss</span> and <em>MNP</em> opens <em>VSCode</em> automatically. A new tag <span class="tm">v0.0.0-pre</span> is added to the git tree.</p>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='13'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/1.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="source-code">
            <h2 id="source-code">Source Code</h2>
            
            <p>As the next step, I'll just download the ZIP archive from <em>DropCSS</em> as the source code, and open finder to copy all files from source into my new package.</p>
            
            <p>The original source is using <em>CommonJS</em> however <em>NodeTools</em> allow to program using ECMA modules with a 0-dependency regex transpiler, so we want to update the source code from <span class="tm">require</span> into imports.</p>
            
            <pre id="ccdbf"><code class="javascript hljs">"use strict";

const { parse: parseHTML } = require('./html');
const { parse: parseCSS, generate: generateCSS, SELECTORS, stripEmptyAts } = require('./css');
const { some, matchesAttr } = require('./find');
const { postProc } = require('./postproc');
const { LOGGING } = require('./env');</code></pre>
            
            <p>This can be achieved easily by running the transpiler in <span class="tm">-r</span> mode:</p>
            
            <pre id="c724c"><code class="shell hljs">MacBook:trapcss zavr$ yarn alamode src -r</code></pre>
            
            <p>It will scan the <strong>src</strong> dir recursively, updating all files in there. By using <span class="tm">yarn &lt;alias&gt;</span> I can execute binaries from node_modules installed locally.</p>
            
            
            <p>When trying to simply check that all imports are updated correctly by running <span class="tm">yarn alanode src/dropcss</span> that simply executes all require calls, without actually running the program, I see an error to do with the following:</p>
            
            <pre id="ccdbf1"><code class="javascript hljs">// src/find.js
function some(nodes, m) {
  return nodes.some(node =&gt; find(m, {
    idx: m.length - 1,
    node
  }));
}

export { matchesAttr };

export const some = (nodes, sel) =&gt; {
  return some(nodes, Array.isArray(sel) ? sel : parseSel(sel));
};</code></pre>
            
            <p>The error says:</p>
            
            <pre id="c724c1"><code class="shell hljs">MacBook:trapcss zavr$ yarn alanode src/dropcss.js
/Users/zavr/adc/trapcss/src/find.js:205
       const some = (nodes, sel) =&gt; {
             ^

SyntaxError: Identifier 'some' has already been declared</code></pre>
            
            <p>This is because after updating to imports, we acquired a name conflict. This is fixed simply by renaming the original function into <span class="tm">_some</span> and calling it from the export:</p>
            
            <pre id="ccdbf2"><code class="javascript hljs">// src/find.js
function _some(nodes, m) {
  // ...
}

export const some = (nodes, sel) =&gt; {
  return _some(nodes, Array.isArray(sel) ? sel : parseSel(sel));
};</code></pre>
            
            <p>In addition, I don't use semicolons therefore I'll quickly fix that with <em>ESLint</em>. <em>ESLint</em> should be installed globally on the system since it's a huge binary and there's no point in installing it for each single package. If you have your own eslint config, you need to fork the template from <span class="tm">mnpjs/package</span>, define your config in there, and updates the <span class="tm">.mnprc</span> settings to point to your forked template.</p>
            
            <pre id="c724c2"><code class="shell hljs">MacBook:trapcss zavr$ eslint --fix src</code></pre>
            
            <p>As the last step for styling, I want to get rid of all <span class="tm">&quot;use strict&quot;</span> directives on top of each file, by a simple search and replace in <em>VSCode</em>: <span class="tm">&quot;use strict&quot;\n\n</span> -> "". Finally, I want the entry to the library be located at <strong>src/index.js</strong> instead of <strong>src/dropcss.js</strong>, therefore I copy the typedef from <span class="tm">index.js</span>, delete the file, and rename <span class="tm">dropcss.js</span> into <span class="tm">index.js</span>.</p>
            
            <pre id="ccdbf3"><code class="javascript hljs">// copy typedef
/**
 * @suppress {nonStandardJsDocs}
 * @typedef {import('../types').trapcss} _trapcss.trapcss
 */</code></pre>
            
            <p>Now I can commit all new source code into git tree, and start testing/documenting the library.</p>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='13'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/2.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="adding-types">
            <h2 id="adding-types">Adding Types</h2>
            
            <p>After we've copied the typedef, we'll want to make sure that the types are actually correct for our program. The main method accepts a hashmap config, so we'll document its structure in <span class="tm">types/index.xml</span>.</p>
            
            <pre id="c16f7"><code class="xml hljs">&lt;types namespace="_trapcss"&gt;
  &lt;record name="Config" desc="Options for the program."&gt;
    &lt;prop string name="html"&gt;
      The input HTML.
    &lt;/prop&gt;
    &lt;prop string name="css"&gt;
      The CSS to drop selectors from.
    &lt;/prop&gt;
    &lt;prop boolean name="keepAlternate" default="false"&gt;
      Whether to keep the `@alternate` comment for
      Closure Stylesheets.
    &lt;/prop&gt;
    &lt;fn name="shouldDrop" opt return="boolean"&gt;
      &lt;arg string name="sel"&gt;The selector to check.&lt;/arg&gt;
      Whether _TrapCSS_ should remove this selector.
      The `shouldDrop` hook is called for every CSS selector
      that could not be matched in the html. Return `false`
      to retain the selector or `true` to drop it.
    &lt;/fn&gt;
  &lt;/record&gt;

  &lt;type record name="Return" desc="Return Type."&gt;
    &lt;prop string name="css"&gt;
      The dropped CSS.
    &lt;/prop&gt;
    &lt;prop type="!Set&lt;string&gt;" name="sels"&gt;
      The used selectors.
    &lt;/prop&gt;
  &lt;/type&gt;
&lt;/types&gt;</code></pre>
            
            <p>We're using the <span class="tm">_trapcss</span> namespace to be able to name our config as <span class="tm">_trapcss.Config</span> and distinguish from other packages' configs that can be defined the same name. The namespace is the feature of <em>VSCode</em> that we use to our advantage, and it's not much different from standard typedefs, only that names of types are preceded with the <span class="tm">_ns</span>. We also add <span class="tm">_</span> underscore as the convention for namespaces' titles, otherwise there might be conflicts between the namespace and some functions in the source code.</p>
            
            <p>There are 3 main types of types: records, interfaces and constructors. Most of all, records are used for configs and simple objects passed around program, while interfaces used to describe methods on classes, which are then annotated with <span class="tm">/* @implements {_ns.Type} */</span> in the source code. Unfortunately, <em>VSCode</em> doesn't understand the implements notation and will not allow to "put meat" or grow implementation on the interface defined like that, but this notation is used to enable Closure Compiler type checking. Some examples of <span class="tm">@implements</span> can be found in the <a
              href="https://github.com/idiocc/goa/blob/4b4534c304870ace80a42245ac0303f85b6eb6d3/src/application.js#L18">
              Idio web server</a>. The <span class="tm">&lt;type record&gt;...&lt;/type&gt;</span> block can be simplified to <span class="tm">&lt;record&gt;...&lt;/record&gt;</span>.</p>
            
            <p>If a type is defined without record/interface attribute, it's becomes the simplest type in the Closure type system, for example, <span class="tm">{ prop: string, prop2: (number|undefined) }</span>. An object like that is not nullable &mdash; since Closure tries to make JavaScript similar to Java, type nullability is a thing. More complex types, such as records and interfaces are nullable, whereas the <strong>structural interfaces</strong> are not. Here's some more documentation on <a href="https://github.com/google/closure-compiler/wiki/Types-in-the-Closure-Type-System">types</a>. Therefore, when we use a record that is not expected to be nullable, we'll want to add <span class="tm">!</span> in front of it, as shown below.</p>
            
            <p>Not only we document the config type in XML, but also the actual API contract of the library, which is placed in the <strong>types/api.xml</strong> file and describes all available methods that can be imported from our Node.JS library.</p>
            
            <pre id="c16f71"><code class="xml hljs">&lt;types namespace="_trapcss"&gt;
  &lt;method name="trapcss" return="!_trapcss.Return"&gt;
    &lt;arg name="opts" type="!_trapcss.Config"&gt;
      The options for _TrapCSS_.
    &lt;/arg&gt;
    Parses the supplied HTML and CSS and removes
    unused selectors. Also removes empty CSS rules.
  &lt;/method&gt;
&lt;/types&gt;</code></pre>
            
            <p>It's the core principle of <em>NodeTools</em> to use XML to store types. You can view it as the design stage that provides a language- and tool-agnostic way to document our software, whereas JS is used for implementation later. We can reuse types for any purpose, such as creating documentation as shown later.</p>
            
            <p>The next thing we want to do is to generate typedefs for <em>VSCode</em> so that we can get working on the source code implementation. The template we used with <em>MNP</em> already has the set up ready for that, we just call <span class="tm">yarn d</span>. This command will update typedefs in <span class="tm">types/index.js</span>, which are then imported in our source code.</p>
            
            <pre id="ccdbf4"><code class="javascript hljs">export {}

/* typal types/api.xml namespace */
/**
 * @typedef {_trapcss.trapcss} trapcss Parses the supplied HTML and CSS and removes
unused selectors. Also removes empty CSS rules.
 * @typedef {(opts: _trapcss.Config) =&gt; _trapcss.Return} _trapcss.trapcss Parses the supplied HTML and CSS and removes
unused selectors. Also removes empty CSS rules.
 */

/**
 * @typedef {import('..').Config} _trapcss.Config
 */

 // 1) add the return import
/**
 * @typedef {import('..').Return} _trapcss.Return
 */</code></pre>
            
            <p>The config is imported from the main JS of the package, which is kept in <span class="tm">compile/index.js</span>. We'll come back to that later, but we also need to import <span class="tm2">(1)</span> the return type manually, as the template's function simply returned a string before. To check that it's been imported correctly, we simply hover over the top declaration.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="trapcss api method type" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="trapcss api method type" src="/nodetools/pages/trapcss/img/trap.gif">
              </noscript>
            </p>
            
            <p>This <strong>types/index.js</strong> file is only used for development purposes, and it's real aim is to provide an annotated function type that is then imported in the source code. We come back to the source code, find our implementation and annotate it with the type:</p>
            
            <pre id="ccdbf5"><code class="javascript hljs">// src/index.js
// adding @type

/**
 * @type {_trapcss.trapcss}
 */
function dropcss(opts) {
  let log, START

  if (LOGGING) {
    START = +new Date()
    log = [[0, 'Start']]
  }
  // ... implementation
}</code></pre>
            
            <p>Make sure to remember to copy across that typedef with import:</p>
            
            <pre id="cb288"><code class="undefined hljs">/**
 * @suppress {nonStandardJsDocs}
 * @typedef {import('../types').trapcss} _trapcss.trapcss
 */</code></pre>
            
            <p>The <strong>@suppress</strong> is needed because Closure Compiler cannot parse imports in typedefs, so that we skip this warnings. However, this function type is also generated in externs which are fed to the Compiler when compiling packages, so that it will be aware of the type. When using namespaces, we need to be consistent with their namings: if we simply imported <span class="tm">trapcss</span> instead of <span class="tm">_trapcss.trapcss</span>, we'd receive access to <em>VSCode</em> <em>JSDoc</em>, but the compiler wouldn't know about the <span class="tm">trapcss</span> type without the namespace.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="importing the trapcss method in implementation for @type annotation" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="importing the trapcss method in implementation for @type annotation" src="/nodetools/pages/trapcss/img/trap2.gif">
              </noscript>
            </p>
            
            <p>The advantage of such annotation is that the comments will be lost during compilation anyway, so we don't have to waste time maintaining them in the source code itself. If we need to update the API contract, we go to the XML file, make changes there, and generate new annotations and externs using <span class="tm">yarn d</span> command. The externs look like the following:</p>
            
            <pre id="ccdbf7"><code class="javascript hljs">/**
 * @fileoverview
 * @externs
 */

/* typal types/index.xml externs */
/** @const */
var _trapcss = {}
/**
 * Options for the program.
 * @record
 */
_trapcss.Config
/**
 * The input HTML.
 * @type {string}
 */
_trapcss.Config.prototype.html
/**
 * The CSS to drop selectors from.
 * @type {string}
 */
_trapcss.Config.prototype.css
/**
 * Whether to keep the `@alternate` comment for
 * Closure Stylesheets. Default `false`.
 * @type {boolean|undefined}
 */
_trapcss.Config.prototype.keepAlternate
/**
 * Whether _TrapCSS_ should remove this selector.
 * The `shouldDrop` hook is called for every CSS selector
 * that could not be matched in the html. Return `false`
 * to retain the selector or `true` to drop it.
 * @type {(function(string): boolean)|undefined}
 */
_trapcss.Config.prototype.shouldDrop = function(sel) {}
/**
 * Return Type.
 * @record
 */
_trapcss.Return
/**
 * The dropped CSS.
 * @type {string}
 */
_trapcss.Return.prototype.css
/**
 * The used selectors.
 * @type {!Set&lt;string&gt;}
 */
_trapcss.Return.prototype.sels

/* typal types/api.xml externs */
/**
 * Parses the supplied HTML and CSS and removes
unused selectors. Also removes empty CSS rules.
 * @typedef {function(_trapcss.Config): _trapcss.Return}
 */
_trapcss.trapcss
</code></pre>
            
            <p>The purpose of externs is to provide type information for Closure Compiler. When using advanced compilation, which we are, property names on objects will get renamed, which is not good when we publish the package with declared config type. By generating an extern, we're making sure that its properties are not renamed. <strong>package.json</strong> file also adds the <span class="tm">&quot;externs&quot;: &quot;types/externs.js&quot;</span> field, so that 3rd party packages that want to compile our package into themselves, will receive access to its types for <em>Closure</em>. This is how <em>NodeTools</em> infrastructure works.</p>
            
            <p>Our standard is to use destructuring on the config to extract its properties for use in the program first thing. If the config was not compulsory, we'd also add <span class="tm">function (config={})</span>, but it's not the case here. When doing this, we also receive the type of the property, so that we're able to receive hints if we need to perform operations on this new objects.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="receiving access to property types" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="receiving access to property types" src="/nodetools/pages/trapcss/img/trap3.gif">
              </noscript>
            </p>
            
            <p>On the screenshot above, you can see how the IDE provides me with autocompletion hint when I'm trying to get access to the <span class="tm">.length</span> property, for example to check that HTML is not empty. This is essential for developer experience of the person who's coding the package, so by simply importing the type, we were able to achieve this productivity without full <em>JSDoc</em> with <span class="tm">@param {Object}</span> comments. Sadly, <em>VSCode</em> does not show the description of the property, otherwise it'd be really perfect, but maybe they can do it in the next version.</p>
            
            <p>So we just update the source code to pass destructured properties, and the new <span class="tm">keepAlternate</span> additional property to the <span class="tm2">parseCSS</span> method. The <span class="tm">keepText</span> second argument for <em>parseHTML</em> is not even accepted by this function, so we remove it.</p>
            
            <pre id="ccdbf6"><code class="javascript hljs">// const H = parseHTML(opts.html, !opts.keepText) =&gt;
   const H = parseHTML(html)

// const shouldDrop = opts.shouldDrop || drop =&gt;
// default is now assigned via destructuing
// above { shouldDrop = drop, ... } = opts

// let tokens = parseCSS(opts.css) =&gt;
   let tokens = parseCSS(css, keepAlternate)</code></pre>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='9'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/3.svg"></noscript></a>
            </p>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="b-ns">
      &copy; <a href="https://www.artd.eco">Art Deco™</a>, 2020
    </footer>
    <script>(function(){function b(){if(0<c.length){var a=c.shift();a.src=a.getAttribute("data-src");a.removeAttribute("data-src");a.onload=b;a.onerror=function(){console.warn("Could not load script %s",a.src)}}}var c=Array.prototype.slice.call(document.querySelectorAll("script[data-src]"));b()})()</script>
  </body>
</html>