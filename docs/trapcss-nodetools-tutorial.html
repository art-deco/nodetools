<!doctype html>
<html class="no-js b-Op" lang="en">
  <head>
    <meta charset="utf-8">
    <title>TrapCSS: NodeTools Tutorial</title>
    <meta content="https://art-deco.github.io/nodetools/trapcss-nodetools-tutorial.html" property="og:url">
    <meta content="TrapCSS: NodeTools Tutorial" property="og:title">
    <meta content="website" property="og:type">
    <meta content="https://art-deco.github.io/nodetools/pages/trapcss/img/splash.jpg" property="og:image">
    <meta
      content="A use case of applying NodeTools stack to upgrade an existing Node.JS package called DropCSS into a library and binary compiled with Closure Compiler." name="description">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link sizes="57x57" rel="apple-touch-icon" href="/nodetools/img/fav-57.png">
    <link sizes="76x76" rel="apple-touch-icon" href="/nodetools/img/fav-76.png">
    <link sizes="120x120" rel="apple-touch-icon" href="/nodetools/img/fav-120.png">
    <link sizes="152x152" rel="apple-touch-icon" href="/nodetools/img/fav-152.png">
    <link sizes="167x167" rel="apple-touch-icon" href="/nodetools/img/fav-167.png">
    <link sizes="180x180" rel="apple-touch-icon" href="/nodetools/img/fav-180.png">
    <link sizes="192x192" rel="icon" href="/nodetools/img/fav-192.png">
    <link sizes="128x128" rel="icon" href="/nodetools/img/fav-128.png">
    <link sizes="32x32" rel="icon" href="/nodetools/img/fav-32.png">
    <link
      href="https://fonts.googleapis.com/css?display=swap&amp;family=Ruda%3A400%2C700%7CMr%20De%20Haviland" rel="preload" as="fetch" crossOrigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin>
    <link href="https://fonts.googleapis.com/css?family=Source%20Code%20Pro%3A400%2C700" rel="preload"
      as="style">
    <script>
      (function(b){var a=document.createElement("link");a.href=b;a.rel="stylesheet";a.crossOrigin="crossorigin";document.head.appendChild(a)})('https://fonts.googleapis.com/css?family=Source%20Code%20Pro%3A400%2C700')
    </script>
    <style id="cpt">
      
        h1 { font-family: 'Mr De Haviland' }
    
      @font-face {
        font-family: 'Mr De Haviland';
        font-style: normal;
        font-weight: 400;
        font-display: swap;
        src: local('Mr De Haviland Regular'), local('MrDeHaviland-Regular'), url('data:application/font-woff2;base64,d09GMgABAAAAAAlEAA4AAAAADxAAAAjuAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGhYbgTYcKgZgAIEEEQgKkWCOSQsmAAE2AiQDSAQgBYROByAbWgzIxACas2aTEDFsScCDFIKJJrCIaLDWd8vVktaRqoSaaLjciygnyt5zr2qyNQGcJAGLWf5l3r/sbWONbtACFmTQWItC1lcqVgvG63ntGX92fXtyeBNbLQgAUvhBDgiHrJurAGJ4IQycjKwCLeS9TSP9zAXeJsZPRUVPm64fwkFXhXngxCgE2W91nAB+CEEcclCGVnS7XMFufAghgRQyWO2BW73ZCNjfw5r9HFxIYAMZ7GAFJTiQgwNLcMCDCB4IukDukiW580VQgAs5uwBLdgHW7A+ENb2hFtuP5Ntz8B9iKywAzm2OHpaNXQXxK4Th+1VGK0kDPtyWP32EpjxDixSoPGy4PQtZLMftIW6qTl4G/IwTSKpdoeJykfSI8KQ8DL7OHlbgQggV4pCOImjRhDZ0oReDGKVnXMrV8FslA9Ddk/0d+5y9z15lL7LH2aPsIfYAu4/dq3RqXk2AYFlYcr4NeQmuB5cLcD9uvVR6ORi4we2ArhbEmYL4mVwQIlF4eopE6GYZ5CISqYUKB7GDjTBK6CdQCewDBf5mo3569wmJAabsIy0G0CaTWE8wZrPZLLEYf3tSbzKBlhjMZoIROwbv4S20wezvP0WTJrGeMVMUOdk6qWdOPTJvMwzaYA6fMdCmg4K98xda7Qz1l2TDMZr8omNRiNr9Mq0EPQfa/trqCqPXNKM8dQC/1/kd09QegvkcJRJD+SvDFLa9HGEyjdASA/XK7Omx4/rs6Wky9Ww6YaCNz8XNFHcxmKkZiYEmTaYDtPyhnNZ+oZ08it5f/EIxo/Sh9IQU2Gzdd/ckU6BP45TyBKOcNJ2DJH2b2mlnrxlAX1+qs1mKTHYX6C9qTjelNZtbs8KB4McmaqcO41GxXjF9glGQkhhO0JK+Jt5c7DNFk69NeqbGQBvFeuaUdsZgRxtNoO3OKruIG25GIWaSntq1wt2xW5r5Hk6gjGKx8bVYz6RPE8ynzV6SIjH4zBjoihkDTV5Xn4m8RzAn9ddpu1PanfJTyVcp88HKxfrjzD3DlJ+dNNKGV7csUmAKON83/QVlDp5UF0zqFeb0GeXMMdCnKynTF/v2UJN6RnlLc/XYNkq4Avr6fdBTl+y2526dYo57v6foyFOM/jZ1W6xnlCf8py/GleiEyclJcmrWbpY26Rlz9PTNQ8/ZVrcYRYX/KUasv00zooSSVseUl/a19nw58ynXZYwh/CqFgjFTl/UE08KI9VrJJ62enDxPvqOYRzNK2ZXUjOQYTZruiLcGz0iOYfL+afvT5E098Mg9T+WsoEGssM18Ovxf436PUGpZm7g9InHvmcqiC8v12/u2xkXrKtOWXDm3JisqPNV4N0HIL/BqKk3v8VL7hk8u6zXG5daGMFETHYNM1nHN/o25s0UYsBe7a7zn5wnpxNqaSMewpd8lDiUMvvnVzMs5WxsngXZPyoaIfWGaHO3NutGlgVFnd3b+kMl3CE7JTe8JDV+Vpy5qW1p1PLG4rql4TBZXH1cfWtXmnJYh6JYu+vd7fJjz8YgYril27t1fXu1WEhfWGEfGP0ixStRYN4XbUAdGhGHvrT2KXY5Y1vYPZegWBWSoYwxD9wtqLeOt/ZOuftaxenNmSptIO6T2IFc/uEmUjPaNqVziSltiJUWNf9fKTiauqI51tCW9u9tlmXYNhZg7l3LJVpiiUnmDJv6eOlVDNXj4Ln3YmZ5zksfhE87p5umnsf4Doxf6UaDJ4WYyd5uz1tb+ZC2ajTZGWFWZ1uH2GF/gbSW1tPIca/S28mtu5mwV8f4hE7trvOfnCenE2ppIR0dJfEeGKsoh/sjSGHdnq2GcqetOchTILTjSXXZ+MTJ+cWa5i/92OlUYM3L8VaBwq9D9oWifk5BvXT/Qcdo+u7Zp14f9ey2tnQrz3igkHR2IbkxwdNukjXWxEZvvcPikYrNNYEMSaenJ/5+4OVHhkEqnOpf4E9KJ9BUpbem4GGLpetda7vNV6US2zXrensRGK/HvSI33/DwhndDu8yJianEuMDR14/8v34+wdfLbeOfQsbtuEpe5E/imOf+3kLqtMIw+tM7cNjGxaha/yPy9r/TsU4VbydE4K8+HLolpARqpqt9DLGjvTeWLTqyMKXvZp1aag5e6qf/jlfu9u42V0/gzjB1I9arzifxMl8Z3cn4iWr2OnzHdLiJ/TE5TO7gEXCjfQlUcWHcxykZR+deI1fWtx3NPb1tbKubVxd0/xfEoFfHesiMlG3QVrzwyRfxk8NNCBUKPtdw34elJrqT9otxvLEmvOSf+EkeN9/w8IX08/3BHuzeBL4VMeLdyhLx2INhVh4TeH2Q8ocfyH/PlHpmJ9jKHVRG7Tntk7BwvTysNqYos9X9GiS7c9omeVSW6Vu3ZL+Nbh7jBLjcjFd3rfeSWIZnZ+cjnePBst94SyLLD8pcHKuPZkiBCOvFVeYnan2wQKD1qDiZp/lchtnVpt+ApizrDlmsqVQc3/q8yEstFEu6Zs2M9gQ52rq36bGE7v7J82EXsvJn+LkoUzjunGXzIFIvdNd7zt4aF2dC3MLewjFAQ602c7eFJ+tk0WCZ8JZRw/4oCXn6rvNO1LbxdyOJNc5fBKvyD4BB6M2HTPIuFtz895k1/r6U2OAfV834GNfEK4IjYEeIZ202I2DAimP0vYcv+Dn9kr73Gfo0H7L/xjv2BcFiYw1fsj3jC/gPP2L8TSew3Qgs2mIFA6eQ8JET7l9zJE3F86unHQQLOnh5gcFl/DxUXFfiviocAIktlAUdCp+JDTWycnRwRxGWkYwCDWAIdutCBToxABTVa4AsVwhCCEES5r0lFL9rQjSb0oxU6DECFEjRhFL3b4jDevxUj6MIgBjCMlLnnBKEFA+iDLwIgwzi6MIJOqFCGNp5ugw5jHFs5ZnHqp1BehCb0oc1Ke6AQOlDGFOaAxgwtPZV5rAHh1EFytSboTsLoYhzmLGIllbc07uIs2D5UcaLhYXSdYlaFUAQJ4IeAO9FVFwg3aPcRDCIOwQjGMFpuHA66cIlBaKgXQUboLuhAMIqRhQLTlgnWYq8gDDkAAAA=') format('woff2');
      }
      
    </style>
    <script>
      (function(){var b=/url\('([\s\S]+?)'\)/.exec(document.head.querySelector("#cpt").textContent);if(b){var a=document.createElement("link");a.rel="preload";a.as="font";a.href=b[1];document.head.appendChild(a)}})()
    </script>
    <script>(function(h,r){var a=Object.keys(h),c=!0;"CSS"in window&&"supports"in CSS?(a=a.reduce(function(k,b){var l=h[b];b=b.split("|");for(var m=!1,d={},f=0;f<b.length;d={a:d.a},f++)if(d.a=b[f],l.map(function(n){return function(e){e=e.split("|");for(var p=!1,g=0;g<e.length;g++){var q=e[g];if(CSS.supports(n.a,q)){p=!0;break}else k.push(n.a+": "+q)}return p}}(d)).filter(Boolean).length==l.length){m=!0;break}m||(c=!1);return k},[]),a.length?c&&console.log("\ud83d\udcbf Browser does not support CSS properties: %s",
a.join("\n "),"but supports alternatives."):console.log("\ud83d\udcbd Browser supports all modern CSS properties.")):(c=!1,console.log("\ud83d\udce0 Browser does not support CSS checks."));c||(a=document.createElement("link"),a.rel="stylesheet",a.href=r,document.head.appendChild(a))})({"align-self":["center"],"flex-grow|-ms-flex-positive":["1"],"flex|-ms-flex":["0 0 25%"],"display":["flex|-ms-flexbox"],"box-sizing":["border-box"],"order|-ms-flex-order":["1"],"transition":["none"],"flex-direction|-ms-flex-direction":["column"],"border-radius":["2px"],"box-shadow":["none"],"flex-basis|-ms-flex-preferred-size":["0"],"justify-content":["center"],"flex-wrap|-ms-flex-wrap":["wrap"],"flex-shrink|-ms-flex-negative":["0"],"position":["sticky|-webkit-sticky"],"align-items":["center"],"hyphens|-webkit-hyphens|-moz-hyphens|-ms-hyphens":["auto"]}, '/nodetools/css/combined-prefixes.css')</script>
    <script>
      (function(q,k){function x(a){for(var f=/url\((.+?)\).*?;\s+unicode-range: (.+?);/g,b={},d=[],h;h=f.exec(a);){var r=h[2];d.push({url:h[1],a:r});b[r]=1}b=Object.keys(b).reduce(function(c,e){var g=e.split(/,\s/).map(function(l){return l.replace("U+","\\u").replace("-","-\\u")}).join("").toLowerCase();c[e]=new RegExp("["+g+"]");return c},{});var t=document.body?document.body.textContent:"",y=t?Object.keys(b).reduce(function(c,e){b[e].test(t)&&(c[e]=!0);return c},{}):Object.keys(b).reduce(function(c,
      e){e in k&&(c[e]=!0);return c},{});m=d.filter(function(c){return c.a in y}).map(function(c){return c.url});if(!m.length)return u();var v=document.createDocumentFragment();m.forEach(function(c,e){var g=document.createElement("link");g.href=c;g.rel="preload";g.as="font";var l=e+1;;g.onload=function(){return u(l)};g.setAttribute("crossorigin",!0);v.appendChild(g)});document.head.appendChild(v)}k=void 0===k?{}:k;var n=document.createElement("link");if(function(a,
      f){if(!a||!a.supports)return!1;try{return a.supports(f)}catch(b){return!1}}(n.relList,"preload")){var z=function(a,f,b){b=void 0===b?"":b;;var d=new XMLHttpRequest;d.onreadystatechange=function(){4==d.readyState&&(200==d.status?(f(d.responseText)):console.error("Error loading webfont: server responded with code %s at %s",d.status,a))};d.open("GET",a);try{d.send(null)}catch(h){console.error(h)}};
      ;var p;(function(a,f){z(a.href,function(b){p=b;x(p)},"-"+(void 0===f?"link":f))})({href:q},"js");var m=[],w=0,u=function(a){w++;w>=m.length&&(a=document.createElement("style"),a.innerHTML=p,document.head.appendChild(a))}}else n.rel="stylesheet",n.href=q,document.head.appendChild(n)})('https://fonts.googleapis.com/css?display=swap&family=Ruda%3A400%2C700%7CMr%20De%20Haviland', {"U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD":true})
    </script>
    <link rel="stylesheet" href="/nodetools/css/combined.css">
    <link rel="preload" as="style" href="/nodetools/highlight.js/styles/default.css">
    <style>
      .no-js [data-io], .no-js .ImageHolder, .no-js [data-loading] { display: none!important }
      .ItWillRunYarn {
          display: none;
        }
        .yarn .ItWillRunYarn {
          display: inline;
        }
        .yarn .ItWillRunNpm {
          display: none;
        }
      .List {
                          font-size:small;
                        }
                        .List > a {
                          display: block!important;
                        }
    </style>
    <noscript>
      <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?display=swap&amp;family=Mr%20De%20Haviland&amp;text=TrapCSS%3A%20NodeTools%20Tutorial">
      <link rel="stylesheet" href="/nodetools/css/combined-prefixes.css">
      <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?display=swap&amp;family=Ruda%3A400%2C700%7CMr%20De%20Haviland">
      <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Source%20Code%20Pro%3A400%2C700">
    </noscript>
    <script defer src="/nodetools/js/polyfill/intersection-observer.js"></script>
    <script defer src="/nodetools/js/images.js"></script>
    <script crossorigin data-src="/nodetools/preact/dist/preact.min.js"></script>
    <script crossorigin data-src="/nodetools/comps/common.js"></script>
    <script crossorigin data-src="/nodetools/comps/trapcss.js"></script>
    <script>
      document.documentElement.classList.remove("no-js")
    </script>
  </head>
  <body class="b-Mk b-Ol b-Op">
    
    <main class="b-Xl" role="main">
      <div class="b-z">
        <div class="b-B">
          <div class="left-column b-hb">
            <div class="b-kC">
            
                <a title="NodeTools Node.JS Stack" href="/nodetools/">
                  <img class="ImageHolder b-t b-vk" sizes="(max-width: 575.8px) 100vw,(max-width: 767.8px) 510px,(max-width: 991.8px) 150px,(max-width: 1199.8px) 210px,255px" alt="NodeTools logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='400'/%3E">
                  <noscript>
                    <picture>
                      <source srcset="/nodetools/img/splash-576.webp 576w,/nodetools/img/splash-319.webp 319w,/nodetools/img/splash-600.webp 600w"
                        sizes="(max-width: 575.8px) 100vw,(max-width: 767.8px) 510px,(max-width: 991.8px) 150px,(max-width: 1199.8px) 210px,255px" type="image/webp">
                      <img class="b-t b-vk" onLoad="webploaded(this)" alt="NodeTools logo" src="/nodetools/img/splash-576.jpg" srcset="/nodetools/img/splash-576.jpg 576w,/nodetools/img/splash-319.jpg 319w,/nodetools/img/splash-600.jpg 600w" sizes="(max-width: 575.8px) 100vw,(max-width: 767.8px) 510px,(max-width: 991.8px) 150px,(max-width: 1199.8px) 210px,255px">
                    </picture>
                  </noscript></a>
              </div>
              <div class="b-kC">
                <a title="The NodeTools Stack Website." class="GitHubBadge" id="cacd9"
                  href="https://github.com/art-deco/nodetools">
                  <span class="a">GitHub</span><span class="b" data-stargazers>⭐️ 1</span></a>
                
                
                
              </div>
              <h3 id="pages">Pages</h3>
              <ul id="PagesMenu">
                <li class><a data-file="index" href="/nodetools/">NodeTools: Node.JS Stack</a></li>
                <li class>
                  <a data-file="quick-start" href="/nodetools/quick-start-to-nodetools.html">Quick Start To NodeTools</a>
                </li>
                <li class="Active">
                  <a data-file="trapcss" href="/nodetools/trapcss-nodetools-tutorial.html">TrapCSS: NodeTools Tutorial</a>
                </li>
                <li class>
                  <a data-file="trapcss2" href="/nodetools/trapcss-2-advanced-nodetools.html">
                    TrapCSS 2: Advanced NodeTools</a>
                </li>
                <li class>
                  <a data-file="web" href="/nodetools/web-development-with-nodetools.html">
                    Web Development With NodeTools</a>
                </li>
                <li class>
                  <a data-file="babel" href="/nodetools/babel-when-open-source-is-not-free-sofware.html">
                    Babel: When Open Source Is Not Free Sofware</a>
                </li>
                <li class>
                  <a data-file="discussion" href="/nodetools/discussion-for-nodetools.html">Discussion for NodeTools</a>
                </li>
              </ul>
              <h3 id="stack">Stack</h3>
              <div class="List b-xq b-kC">
                <a
                  title="Create Packages From GitHub Templates. My New Package is an installer of new packages via GitHub templates: create a template and add an automated script to CLI questions, update files, access GitHub API and spawn commands during generation." class="NPMBadge" href="https://www.npmjs.com/package/mnp">
                  <span class="a"><em>MNP</em></span><span class="b">1.1.7</span></a>
                <a
                  title="Organises TypeDefs By Placing Them Into Types.Xml File To Be Embedded Into Source Code Compatible With VSCode And Google Closure Compiler, Generates Externs And Allows To Place Documentation In README Markdown." class="NPMBadge" href="https://www.npmjs.com/package/typal">
                  <span class="a"><em>Typal</em></span><span class="b">1.26.2</span></a>
                <a
                  title="Proper Node.JS Package Compiler (And Front-End Code Bundler) With Closure Compiler. Can create a single executable JS file and merge and optimise all dependencies." class="NPMBadge" href="https://www.npmjs.com/package/depack">
                  <span class="a"><em>Depack</em></span><span class="b">1.1.1</span></a>
                <a
                  title="A Regex-Based Transpiler Of Source Code To Allow Writing Import And Export Statements And JSX With 0 Dependencies." class="NPMBadge" href="https://www.npmjs.com/package/alamode">
                  <span class="a"><em>ÀLaMode</em></span><span class="b">3.5.0</span></a>
                <a
                  title="The 2020 Most Modern Testing Framework For Node.JS With Test Contexts (Reusable BeforeEach / AfterEach Via Separate Files); Masks (Inputs/Outputs In Non-Js Files) And Fork Testing; Interactive Snapshots." class="NPMBadge" href="https://www.npmjs.com/package/zoroaster">
                  <span class="a"><em>Zoroaster</em></span><span class="b">4.3.0</span></a>
                <a
                  title="Documentation Compiler To Generate The Table Of Contents, Embed Examples With Their Output, Make Markdown Tables, Maintain Typedefs For JavaScript And README, Watch Changes To Push, Use Macros And Prettify API Titles." class="NPMBadge" href="https://www.npmjs.com/package/documentary">
                  <span class="a"><em>Documentary</em></span><span class="b">1.36.1</span></a>
              </div>
              <h3 id="web-software">Web Software</h3>
              <div class="List b-xq b-kC">
                <a
                  title="2-Dependency Koa Web Server Compiled With Closure Compiler And Bundled With Essential Middleware: Static, Compress, Session, Cors, File Upload, Router And JSX Front End." class="NPMBadge" href="https://www.npmjs.com/package/@idio/idio">
                  <span class="a"><em>Idio</em></span><span class="b">1.2.3</span></a>
                <a
                  title="Static Web Site Compiler That Uses Closure Compiler For JS Bundling And Closure Stylesheets For CSS optimisations. Supports JSX Syntax To Write Static Elements And Dynamic Preact Components." class="NPMBadge" href="https://www.npmjs.com/package/splendid">
                  <span class="a"><em>Splendid</em></span><span class="b">1.16.16</span></a>
              </div>
              <h3 id="misc">Misc</h3>
              <ul>
                <li><a href="https://gitter.im/node_tools/community">Join In Gitter Chat</a></li>
                <li><a href="https://opencollective.com/nodetools">Fund Via Open Collective</a></li>
                <li><a href="https://twitter.com/nodetools">Follow On Twitter</a></li>
              </ul>
              <div class="SideBarMenu sidebarshowing b-jr b-zp">
                <div class="a">
                  
                                  <h3 id="on-this-page">On This Page</h3>
                                  <ul class="OnThisPage">
                                    <li data-heading="trapcss"><a href="#trapcss">TrapCSS</a></li>
                                    <li data-heading="mnp"><a href="#mnp">MNP</a></li>
                                    <li data-heading="upgrading-source-code"><a href="#upgrading-source-code">Upgrading Source Code</a></li>
                                    <li data-heading="adding-types">
                                      <a href="#adding-types">Adding Types</a>
                                      <ul>
                                        <li data-heading="typedefs"><a href="#typedefs">Typedefs</a></li>
                                        <li data-heading="externs"><a href="#externs">Externs</a></li>
                                        <li data-heading="accessing-properties"><a href="#accessing-properties">Accessing Properties</a></li>
                                      </ul>
                                    </li>
                                    <li data-heading="initial-documentation">
                                      <a href="#initial-documentation">Initial Documentation</a>
                                      <ul>
                                        <li data-heading="examples-to-outputs"><a href="#examples-to-outputs">Examples To Outputs</a></li>
                                      </ul>
                                    </li>
                                    <li data-heading="creating-tests">
                                      <a href="#creating-tests">Creating Tests</a>
                                      <ul><li data-heading="mask-testing"><a href="#mask-testing">Mask Testing</a></li><li data-heading="focus-in-masks"><a href="#focus-in-masks">Focus In Masks</a></li><li data-heading="interactive-mode"><a href="#interactive-mode">Interactive Mode</a></li><li data-heading="more-masks"><a href="#more-masks">More Masks</a></li><li data-heading="error-stacks"><a href="#error-stacks">Error Stacks</a></li><li data-heading="context-testing"><a href="#context-testing">Context Testing</a></li></ul>
                                    </li>
                                    <li data-heading="advanced-concepts"><a href="#advanced-concepts">Advanced Concepts</a></li>
                                    <li data-heading="comments"><a href="#comments">Comments</a></li>
                                  </ul>
                                  <h3 id="share-nodetools">Share NodeTools</h3>
                                  <span class="b-xq b-Hk" id="c485b"><span class="b-Hk" style="height:32px" data-loading>Loading sharing buttons...</span><noscript>Please enable JavaScript to Share</noscript></span>
                                  
                                  <div class="b-xq" data-loading id="updates-div">Loading web-push...</div>
                                  <details id="NewsletterDetails" data-loading>
                                    <summary>
                                      <h3 id="newsletter">Newsletter</h3>
                                    </summary>
                                    <div id="emails-div">Loading widget...</div>
                                  </details>
                                  <div class="b-jq" data-loading>
                                    <h3 class="b-Gk" id="package-manager">Package Manager</h3>
                                    <form class="b-Gk" id="ca13e">
                                      <select><option value="yarn">yarn</option><option selected value="npm">npm</option></select>
                                    </form>
                                  </div>
                                
                </div>
                <a data-loading id="HideMenu" style="color:grey!important;" href="#">hide menu</a>
                <a data-loading id="ShowMenu" style="color:grey!important;" href="#">show menu</a>
              </div>
          </div>
          
          <div class="right-column b-xq b-nb" id="Content">
            
            
            <div data-section id="trapcss">
            <h1>TrapCSS: NodeTools Tutorial</h1>
            
            
            
            <p>There are CSS frameworks such as <em>Bootstrap</em> that allow to create great layouts quickly, however their size might be quite large. This point is worth considering because CSS is loaded in a blocking fashion: the browser will have to wait before all CSS is loaded to render a web site, so large external stylesheets actually slow down page render by postponing first meaningful paint. This affects usability and even search engine ranking negatively. In many cases, a lot of CSS can be "dropped" from frameworks' compiled code by leaving only those selectors that are present on a page, or multiple pages. This technique corresponds to the "Defer unused CSS" Lighthouse <a href="https://developers.google.com/web/tools/lighthouse/audits/unused-css">warning</a>.</p>
            
            <p>
              <img class="ImageHolder b-vk b-t" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px" alt="trapcss nodetools tutorial" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1000' height='674'/%3E">
              <noscript>
                <picture>
                  <source
                    srcset="/nodetools/pages/trapcss/img/splash-768.webp 768w,/nodetools/pages/trapcss/img/splash-576.webp 576w,/nodetools/pages/trapcss/img/splash-319.webp 319w,/nodetools/pages/trapcss/img/splash-1000.webp 1000w" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px"
                    type="image/webp">
                  <img class="b-vk b-t" onLoad="webploaded(this)" alt="trapcss nodetools tutorial" src="/nodetools/pages/trapcss/img/splash-768.jpg" srcset="/nodetools/pages/trapcss/img/splash-768.jpg 768w,/nodetools/pages/trapcss/img/splash-576.jpg 576w,/nodetools/pages/trapcss/img/splash-319.jpg 319w,/nodetools/pages/trapcss/img/splash-1000.jpg 1000w" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px">
                </picture>
              </noscript>
            </p>
            
            <p>One of the packages that is able to do it quickly is called <a href="https://github.com/leeoniya/dropcss">DropCSS</a>, developed by <a href="https://github.com/leeoniya">Leon Sorokin</a>. It's notable for its speed, simplicity and the amount of bytes that can shaved off the CSS. However, for our use case it was not perfect: it strips comments and does not allow to keep arbitrary annotations, such as <span class="tm">/* alternate */</span> which is needed for <a href="https://github.com/artdecocode/closure-stylesheets-java">Closure Stylesheets</a>. Closure Stylesheets is an optimiser of CSS that can minify and put styles together. Art Deco uses it for Splendid, a static website generator. By collecting selectors across all pages on a generated website, we're able to drop unused Bootstrap rules, and then merge Bootstrap with other styles so that a single, small CSS file is served to visitors quickly, with <em>Bootstrap</em> size reduction of around 95%.</p>
            
            <p>But Bootstrap contains rules that repeat the CSS properties, e.g.,:</p>
            
            <pre id="c1d47"><code class="css hljs">abbr[title],
abbr[data-original-title] {
  text-decoration: underline;
  -webkit-text-decoration: underline dotted;
  /* @alternate */
  text-decoration: underline dotted;
  /* ^ repeated use, need alternate */
}</code></pre>
            
            <p>We needed to annotate Bootstrap with the <span class="tm">/* alternate */</span> marker so that the CSS compiler doesn't throw an error. A simple proposed solution to prevent stripping such comments was suggested in form of a <a href="https://github.com/leeoniya/dropcss/pull/41">PR</a> to <em>DropCSS</em> package owner, however was rejected as being too narrow of a use case. Therefore, we decided to fork his project and use its source code to create a professional Node.JS package that would also provide JSDoc annotations, could be tested with context testing, and is ready to be compiled into other packages, such as <em>Splendid</em> itself, so that it's linked statically instead of dynamically as permitted by the original MIT license.</p>
            
            <p>This tutorial walks through the process of upgrading a package to use <em>NodeTools</em> stack with explanation of advantages of using the tools from the stack in creating modern packages. You might want to read the <a href="/nodetools/quick-start-to-nodetools.html">quick start</a> guide first for some details about the standard routine.</p>
            
            <strong>TrapCSS</strong> on <em>GitHub</em>: <a
               title="Removes unused selectors from CSS files to achieve maximum optimisation. Can be used as an API function or with CLI." class="GitHubBadge" id="c1dbc" href="https://github.com/artdecocode/trapcss">
               <span class="a">GitHub</span><span class="b" data-stargazers>⭐️ 1</span></a>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='15'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/0.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="mnp">
            <h2>MNP</h2>
            
            <p>The very first step is to spawn a new package using <span class="tm">mnp</span> binary. Instead of forking the repo, I will create a new package so that its structure adheres to <em>NodeTools</em>' recommendations. My default organisation is <span class="tm2">artdecocode</span> on <em>GitHub</em> and I keep projects in the <strong>~/adc</strong> folder. Additionally, I've made a number of other orgs, such as <span class="tm2">dpck</span>, <span class="tm2">a-la</span> for scopes of other projects that are made up of many packages &mdash; organising your <em>GitHub</em> workspace and the home dir by orgs is a convenient method that allows to maintain different settings for different organisations and keep them semantically grouped. When you're ready to grant permissions to other developers to maintain your packages, you can do it on per-org basis. For a standard <em>Node.JS</em> package, I'll just use <strong>adc</strong>.</p>
            
            <pre id="c414d"><code class="bash hljs">cd adc
# mnp --init (if init was not done yet)
mnp trapcss -n</code></pre>
            
            <p>I've already <a href="/nodetools/quick-start-to-nodetools.html#configure-org">configured mnp</a> prior to creating a package, therefore all settings are already recorded in the <span class="tm">.mnprc</span> file. I pass the package name to the binary, together with the <span class="tm">-n</span> flag, which means <span class="tm">--no-scope</span>: because settings contain a scope (<span class="tm">@artdeco</span>), I want to skip it in this particular case. <em>MNP</em> then asks me questions about the new package:</p>
            
            <pre id="c414d1"><code class="bash hljs"># trapcss
Description: Removes unused selectors from CSS files to achieve maximum optimisation. Can be used as an API function or with CLI.
Generating repository...
Starring...
⭐️ Created and starred a new repository
https://github.com/artdecocode/trapcss
Cloning into '/Users/zavr/adc/trapcss'...
Setting user Anton&lt;anton@adc.sh&gt;...
With binary [y/n]: [y]
Build or compile: [compile]
License: [agpl-3.0]
Init Github Wiki [y/n]: [y]
Homepage: [https://github.com/artdecocode/trapcss#readme] https://art-deco.github.io/trapcss
Keywords (e.g., artdecocode, trapcss): css, minifier, web, browser
Please go to https://github.com/artdecocode/trapcss/wiki/_new
to create the first page and press enter when done. (y/n): [y]
Cloning into '/Users/zavr/adc/trapcss/wiki.git'...
Setting topics...
Initialised package structure, pushing...
yarn install v1.13.0
✨  Done in 2.67s.
Created a new package: trapcss.</code></pre>
            
            <p>I've answered questions in the following way:</p>
            
            <ul>
              <li>With binary: <strong>true</strong>, because I'll want to create a node executable to run from the CLI to drop selectors from CSS files based on HTML files.</li>
              <li>Build or compile: <strong>compile</strong>, because I want to create a library compatible with Closure so that it can be compiled into <em>Splendid</em> later.</li>
              <li>License: <strong>agpl-3.0</strong>, my personal preference that prevents exploitation of my work. We'll keep the original MIT copyright notice in the source code.</li>
              <li>Init Github Wiki: <strong>y</strong>, we'll want to create wiki pages with discussion about certain use cases, such as using multiple HTML files to gather selectors list.</li>
              <li>Homepage: <strong>https://art-deco.github.io/trapcss</strong>, I update the default homepage that points to the repo readme on GitHub, because I'll want to create a website for the package with a demo.</li>
              <li>Keywords: <strong>css, minifier, web, browser</strong>, some tags for GitHub topics and NPM keywords.</li>
            </ul>
            
            <p>I'm then asked to navigate to GitHub to create the first Home wiki page. This needs to be done manually since GitHub does not provide API routes for automation of this procedure. After I've done this, MNP will install dependencies automatically, depending on your manager setting in MNP (either <span class="tm">yarn</span> or <span class="tm">npm</span>) and you'll have either <strong>package-lock.json</strong> or <strong>yarn.lock</strong> files. Now the template is fully populated with settings and personalised, a new tag <span class="tm2">v0.0.0-pre</span> is added to git tree and the initial commit is pushed. My package is found in <span class="tm">trapcss</span> folder and <em>MNP</em> opens <em>VSCode</em> automatically.</p>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='13'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/1.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="upgrading-source-code">
            <h2>Upgrading Source Code</h2>
            
            <p>As the next step, I'll just download the ZIP archive from <em>DropCSS</em> with the source code, and open finder to copy all files from source into <strong>m</strong>y <strong>n</strong>ew <strong>p</strong>ackage.</p>
            
            <p>The original source is using <em>CommonJS</em> however <em>NodeTools</em> allow to program using ECMA modules with a 0-dependency regex transpiler, so we want to update the source code from <span class="tm">require</span> into imports.</p>
            
            <pre id="ccdbf"><code class="javascript hljs">"use strict";

const { parse: parseHTML } = require('./html');
const { parse: parseCSS, generate: generateCSS,
  SELECTORS, stripEmptyAts } = require('./css');
const { some, matchesAttr } = require('./find');
const { postProc } = require('./postproc');
const { LOGGING } = require('./env');</code></pre>
            
            <p>This can be achieved easily by running the transpiler in <span class="tm">-r</span> mode:</p>
            
            <pre id="c724c"><code class="shell hljs">MacBook:trapcss zavr$ yarn alamode src -r</code></pre>
            
            <p>It will scan the <strong>src</strong> dir recursively, updating all files in there. Only <strong>yarn</strong> supports running binaries from local node&lowbar;modules with <span class="yarnManager"> <span>yarn bin-alias</span></span> to execute aliases installed in the project folder within <strong>node&lowbar;modules/.bin</strong> (which is why we prefer it), but for <strong>npm</strong>, the <span class="tm">alanode</span> script has also been defined, so you can call <span class="npmManager"> <span>npm run alanode</span></span> too if you want to execute any module that needs transpiling, such as examples.</p>
            
            <p>When trying to simply check that all imports are updated correctly by running <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>alanode</span> <span>src/dropcss</span></span></span> that only executes all require calls without actually running the program, I see an error to do with the following:</p>
            
            <pre id="ccdbf1"><code class="javascript hljs">// src/find.js
function some(nodes, m) {
  return nodes.some(node =&gt; find(m, {
    idx: m.length - 1,
    node
  }));
}

export { matchesAttr };

export const some = (nodes, sel) =&gt; {
  return some(nodes, Array.isArray(sel) ? sel : parseSel(sel));
};</code></pre>
            
            <p>The error says:</p>
            
            <pre id="c724c1"><code class="shell hljs">MacBook:trapcss zavr$ yarn alanode src/dropcss.js
/Users/zavr/adc/trapcss/src/find.js:205
       const some = (nodes, sel) =&gt; {
             ^

SyntaxError: Identifier 'some' has already been declared</code></pre>
            
            <p>This is because after updating to imports, we acquired a name conflict. This is fixed simply by renaming the original function into <span class="tm">_some</span> and calling it from the export:</p>
            
            <pre id="ccdbf2"><code class="javascript hljs">// src/find.js
function _some(nodes, m) {
  // ...
}

export const some = (nodes, sel) =&gt; {
  return _some(nodes, Array.isArray(sel) ? sel : parseSel(sel));
};</code></pre>
            
            <p>In addition, I don't use semicolons therefore I'll quickly fix that with <em>ESLint</em>. <em>ESLint</em> should be installed globally on the system since it's a huge binary and there's no point in installing it for each single package. If you have your own eslint config, you need to fork the template from <span class="tm">mnpjs/package</span>, define your config in there, and modify the <span class="tm">.mnprc</span> settings file to point to your forked template.</p>
            
            <pre id="c724c2"><code class="shell hljs">MacBook:trapcss zavr$ eslint --fix src</code></pre>
            
            <p>As the last step for styling, I want to get rid of all <span class="tm">&quot;use strict&quot;</span> directives on top of each file, by a simple search and replace in <em>VSCode</em>: <span class="tm">&quot;use strict&quot;\n\n</span> -> "". Finally, I want the entry to the library be located at <strong>src/index.js</strong> instead of <strong>src/dropcss.js</strong>, therefore I copy the typedef from <span class="tm">index.js</span>, delete the file, and rename <span class="tm">dropcss.js</span> into <span class="tm">index.js</span>.</p>
            
            <pre id="ccdbf3"><code class="javascript hljs">// copy typedef as needed for next step
/**
 * @suppress {nonStandardJsDocs}
 * @typedef {import('../types').trapcss} _trapcss.trapcss
 */</code></pre>
            
            <p>Now I can commit all new source code into the git tree, and start testing/documenting the library.</p>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='13'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/2.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="adding-types">
            <h2>Adding Types</h2>
            
            <p>After we've copied the typedef, we'll want to write types that are relevant for our program. The main method accepts a hashmap config, so we'll document its structure in <span class="tm">types/index.xml</span>.</p>
            
            <pre id="c16f7"><code class="xml hljs">&lt;types namespace="_trapcss"&gt;
  &lt;record name="Config" desc="Options for the program."&gt;
    &lt;prop string name="html"&gt;
      The input HTML.
    &lt;/prop&gt;
    &lt;prop string name="css"&gt;
      The CSS to drop selectors from.
    &lt;/prop&gt;
    &lt;prop boolean name="keepAlternate" default="false"&gt;
      Whether to keep the `@alternate` comment for
      Closure Stylesheets.
    &lt;/prop&gt;
    &lt;fn name="shouldDrop" opt return="boolean"&gt;
      &lt;arg string name="sel"&gt;The selector to check.&lt;/arg&gt;
      Whether _TrapCSS_ should remove this selector.
      The `shouldDrop` hook is called for every CSS selector
      that could not be matched in the html. Return `false`
      to retain the selector or `true` to drop it.
    &lt;/fn&gt;
  &lt;/record&gt;

  &lt;type record name="Return" desc="Return Type."&gt;
    &lt;prop string name="css"&gt;
      The dropped CSS.
    &lt;/prop&gt;
    &lt;prop type="!Set&lt;string&gt;" name="sels"&gt;
      The used selectors.
    &lt;/prop&gt;
  &lt;/type&gt;
&lt;/types&gt;</code></pre>
            
            <p>We're using the <span class="tm">_trapcss</span> namespace to be able to name our config as <span class="tm">_trapcss.Config</span> and distinguish it from other packages' configs that can be defined with the same name. The namespace is the feature of <em>VSCode</em> that we use to our advantage, and it's not much different from standard typedefs, only that names of types are preceded with the <span class="tm">_ns</span>. We also use <span class="tm2">_</span> underscore as the convention for namespaces' titles, otherwise there might be conflicts between them and some functions in the source code.</p>
            
            <p>There are 3 main types of types: records, interfaces and constructors. The key point to remember is that records are used for configs and other simple objects passed between programs, while interfaces are used to describe methods and properties on classes, which are then annotated with <span class="tm">/* @implements {_ns.Type} */</span> in the source code. Unfortunately, <em>VSCode</em> doesn't understand the implements notation and will not allow to "put meat" or grow implementation on the interface defined like that while providing hints during implementation process, but this notation is used to enable <em>Closure Compiler</em> type checking. Some examples of <span class="tm">@implements</span> can be found in the <a
              href="https://github.com/idiocc/goa/blob/4b4534c304870ace80a42245ac0303f85b6eb6d3/src/application.js#L18">
              Goa server</a>.</p>
            
            <pre id="ccdbf4"><code class="javascript hljs">/**
 * @implements {_goa.Application}
 */
export default class Application extends EventEmitter {
  /**
   * Initialize a new `Application`.
   * @param {!_goa.ApplicationOptions} options
   */
  constructor(options = {}) {}
  // if VSCode understood @implements, we wouldn't have to
  // specify the type of the argument in @param as it could
  // be deducted from the interface type ;)
}</code></pre>
            
            <p>The <span class="tm">&lt;type record&gt;...&lt;/type&gt;</span> block can be simplified to <span class="tm">&lt;record&gt;...&lt;/record&gt;</span>, same with <em>interface</em>. Constructors are used very rarely.</p>
            
            <p>If a type is defined without record/interface attribute, it becomes the simplest type in the <em>Closure</em> type system called a <strong>structural interface</strong>, for example, <span class="tm">{ prop: string, prop2: (number|undefined) }</span>. An object like that is not nullable &mdash; since Closure tries to make JavaScript similar to Java, type nullability is a thing. More complex types, such as records and interfaces are nullable, whereas structural interfaces are not. Here's some more documentation on <a href="https://github.com/google/closure-compiler/wiki/Types-in-the-Closure-Type-System">types</a>. Therefore, when we use a record that is not expected to be nullable, we'll want to add <span class="tm">!</span> in front of it, as shown below.</p>
            
            <p>Not only do we document config and return types in XML, but also the actual API contract of the library, which is placed in the <strong>types/api.xml</strong> file and describes all available methods that can be imported from our Node.JS library.</p>
            
            <pre id="c16f71"><code class="xml hljs">&lt;types namespace="_trapcss"&gt;
  &lt;method name="trapcss" return="!_trapcss.Return"&gt;
    &lt;arg name="config" type="!_trapcss.Config"&gt;
      The options for _TrapCSS_.
    &lt;/arg&gt;
    Parses the supplied HTML and CSS and removes
    unused selectors. Also removes empty CSS rules.
  &lt;/method&gt;
&lt;/types&gt;</code></pre>
            
            <p>It's the core principle of <em>NodeTools</em> to use XML to store types. You can view it as the design stage that provides a language- and tool-agnostic way to document our software, whereas JS is used for implementation later. We can reuse types for any purpose, such as creating documentation as shown later. Because types are not written in a complex proprietary format like .ts (TypeScript typings), anyone can make software that uses a simple XML parser to extract types, and build their own schema upon the existing one.</p>
            
            
            
            <div data-section id="typedefs">
            <h3>Typedefs</h3>
            
            
            <p>The next thing we want to do is to generate typedefs for <em>VSCode</em> so that we can get working on the source code implementation. The template we used with <em>MNP</em> already has the set up ready for that, we just call <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>d</span></span></span>. This command will update typedefs in <strong>types/index.js</strong>, which are then imported in our source code via the <span class="tm">@typedef {import('../types')}</span> <em>JSDoc</em>. <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>d</span></span></span> actually spawns multiple commands, including <span class="tm">template</span>, <span class="tm">d1</span> and <span class="tm">externs</span>. It will run <span class="ItWillRunYarn"><em>yarn-s</em></span><span class="ItWillRunNpm"><em>npm-s</em></span> for serial execution of all 3 of these commands in series.</p>
            
            <pre id="ccdbf5"><code class="javascript hljs">export {}

/* typal types/api.xml namespace */
/**
 * @typedef {_trapcss.trapcss} trapcss Parses the supplied HTML and CSS and removes
unused selectors. Also removes empty CSS rules.
 * @typedef {(opts: _trapcss.Config) =&gt; _trapcss.Return} _trapcss.trapcss Parses the supplied HTML and CSS and removes
unused selectors. Also removes empty CSS rules.
 */

/**
 * @typedef {import('..').Config} _trapcss.Config
 */

 // 1) add the return import
/**
 * @typedef {import('..').Return} _trapcss.Return
 */</code></pre>
            
            <p>The config is imported from the main JS of the package, which is kept in <span class="tm">compile/index.js</span>. We'll come back to that later, but we also need to import <span class="tm2">(1)</span> the return type manually, as the template's function simply returned a string before. To check that it's been imported correctly, we simply hover over the top declaration.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="trapcss api method type" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="trapcss api method type" src="/nodetools/pages/trapcss/3-types/img/trap.gif">
              </noscript>
            </p>
            
            <p>This <strong>types/index.js</strong> file is only used for development purposes, and it's real aim is to provide an annotated function type that is then imported in the source code. We come back to the source code, find our implementation and annotate it with the type:</p>
            
            <pre id="ccdbf6"><code class="javascript hljs">// src/index.js
// adding @type

/**
 * @type {_trapcss.trapcss}
 */
function dropcss(opts) {
  let log, START

  if (LOGGING) {
    START = +new Date()
    log = [[0, 'Start']]
  }
  // ... implementation
}</code></pre>
            
            <p>Make sure to remember to copy across that typedef with import:</p>
            
            <pre id="ccdbf7"><code class="javascript hljs">/**
 * @suppress {nonStandardJsDocs}
 * @typedef {import('../types').trapcss} _trapcss.trapcss
 */</code></pre>
            
            <p>The <strong>@suppress</strong> is needed because Closure Compiler cannot parse imports in typedefs, so that we skip this warnings. However, this function type is also generated in externs which are fed to the Compiler when compiling packages, so that it will be aware of the type. When using namespaces, we need to be consistent with their namings: if we simply imported <span class="tm">trapcss</span> instead of <span class="tm">_trapcss.trapcss</span>, we'd receive access to <em>VSCode</em> <em>JSDoc</em>, but the compiler wouldn't know about the <span class="tm">trapcss</span> type without the namespace.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="importing the trapcss method in implementation for @type annotation" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="importing the trapcss method in implementation for @type annotation" src="/nodetools/pages/trapcss/3-types/img/trap2.gif">
              </noscript>
            </p>
            
            <p>The advantage of such annotation is that the comments will be lost during compilation anyway, so we don't have to waste time maintaining them in the source code itself. If we need to update the API contract, we go to the XML file, make changes there, and generate new annotations and externs using <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>d</span></span></span> command.</p>
            
            
            </div>
            
            
            <div data-section id="externs">
            <h3>Externs</h3>
            
            <p>When compiling packages, we need to learn a new concept called <em>externs</em> &mdash; a separate JS file that includes typedefs in a special format understood by Closure Compiler that provide type information to it. Externs look like the following:</p>
            
            <pre id="ccdbf24"><code class="javascript hljs">/**
 * @fileoverview
 * @externs
 */

/* typal types/index.xml externs */
/** @const */
var _trapcss = {}
/**
 * Options for the program.
 * @record
 */
_trapcss.Config
/**
 * The input HTML.
 * @type {string}
 */
_trapcss.Config.prototype.html
/**
 * The CSS to drop selectors from.
 * @type {string}
 */
_trapcss.Config.prototype.css
/**
 * Whether to keep the `@alternate` comment for
 * Closure Stylesheets. Default `false`.
 * @type {boolean|undefined}
 */
_trapcss.Config.prototype.keepAlternate
/**
 * Whether _TrapCSS_ should remove this selector.
 * The `shouldDrop` hook is called for every CSS selector
 * that could not be matched in the html. Return `false`
 * to retain the selector or `true` to drop it.
 * @type {(function(string): boolean)|undefined}
 */
_trapcss.Config.prototype.shouldDrop = function(sel) {}
/**
 * Return Type.
 * @record
 */
_trapcss.Return
/**
 * The dropped CSS.
 * @type {string}
 */
_trapcss.Return.prototype.css
/**
 * The used selectors.
 * @type {!Set&lt;string&gt;}
 */
_trapcss.Return.prototype.sels

/* typal types/api.xml externs */
/**
 * Parses the supplied HTML and CSS and removes
unused selectors. Also removes empty CSS rules.
 * @typedef {function(_trapcss.Config): _trapcss.Return}
 */
_trapcss.trapcss
</code></pre>
            
            <p>The purpose of externs is to provide type information for Closure Compiler. When using advanced compilation, which we are, property names on objects will get renamed, which is not good when we publish the package with declared config type. By generating an extern, we're making sure that its properties are not renamed. <strong>package.json</strong> file also adds the <span class="tm">&quot;externs&quot;: &quot;types/externs.js&quot;</span> field, so that 3rd party packages that want to compile our package into themselves, will receive access to its types for <em>Closure</em>. This is how <em>NodeTools</em> infrastructure works.</p>
            
            <p><em>Depack</em> includes externs for <a href="https://github.com/externs/nodejs">Node 8 API</a>. We haven't upgraded them to newer versions, and some namespaces, like <span class="tm">tls</span> might still produce warnings during compilation. You can check out the repository by the link, modify externs, and submit a PR. On the other hand, for any additions to Node externs, you can simply type them in the <span class="tm">types/externs.js</span> file, e.g.,</p>
            
            <pre id="ccdbf8"><code class="javascript hljs">/* typal types/index.xml externs */
// auto-generated externs

// manual externs
/** @type {string} */
process.env.MY_ENV_VAR
/**
 * @constructor
 * @param {{ quantumLocation: boson }} options
 */
stream.SuperDuplexNode16 = function(options)
/**
 * @constructor
 * @param {!fs.Entanglement} ent
 */
stream.SuperDuplexNode16.prototype.open = function(ent)</code></pre>
            
            <p>There are also externs for 3rd party libraries, for example, for <a href="https://github.com/externs/preact">Preact</a> that we've created. Refer to it as an example for front-end externs. If you want to submit externs for some library, please open <a href="https://github.com/externs/prs">an issue</a> with a link to your externs and they'll get published on the <span class="tm2">@externs/your-extern</span> scope from within the <em>GitHub</em> <span class="tm2">externs</span> org. You might want to search online for existing externs first, or send PRs to packages that you use in your projects with generated externs and <span class="tm">externs</span> field in <strong>package.json</strong>. In other words, there are 2 strategies: to publish externs as separate packages, and import them in code, which looks pretty cool, or simply have them in the same package and import from <span class="tm">types/externs.js</span> file.</p>
            
            <blockquote class="b-r">
              The <span class="tm">/* typal types/index.xml */\n\n</span> marker always requires 2 new lines after it (even if it's at the end of the file). Please remember that.
            </blockquote>
            
            <pre id="ccdbf9"><code class="javascript hljs">/* typal types.xml */

// ^ make sure a new line always follows the typal marker.</code></pre>
            
            
            </div>
            
            
            <div data-section id="accessing-properties">
            <h3>Accessing Properties</h3>
            
            <p>Our standard is to use destructuring on the config to extract its properties for use in the program first thing. If the config was not compulsory, we'd also add the default value to the <strong>config</strong> argument: <span class="tm">function (config = {})</span>, but it's not the case here. When doing this, we also receive the type of the property, so that we're able to expand hints if we need to perform operations on these symbols.</p>
            
            <p>
              <img class="b-bk b-vk b-t" alt="receiving access to property types" data-io>
              <noscript>
                <img class="b-bk b-vk b-t" alt="receiving access to property types" src="/nodetools/pages/trapcss/3-types/img/trap3.gif">
              </noscript>
            </p>
            
            <p>On the screenshot above, you can see how the IDE provides me with autocompletion hint when I'm trying to get access to the <span class="tm">.length</span> property, for example to check that HTML is not empty. This is essential for developer experience of the person who's coding the package, so by simply importing the type, we were able to achieve this productivity without full <em>JSDoc</em> with <span class="tm">@param {Object}</span> comments. Sadly, <em>VSCode</em> does not show the description of the property, otherwise it'd be really perfect, but maybe they can do it in the next version.</p>
            
            <p>So we just update the source code to pass destructured properties, and the new <span class="tm">keepAlternate</span> additional property to the <span class="tm2">parseCSS</span> method. The <span class="tm">keepText</span> second argument for <em>parseHTML</em> is not even accepted by this function, but we'll remove it in the second part.</p>
            
            <pre id="ccdbf10"><code class="javascript hljs">// const H = parseHTML(opts.html, !opts.keepText) =&gt;
   const H = parseHTML(html, !keepText)

// const shouldDrop = opts.shouldDrop || drop =&gt;
// default is now assigned via destructuing
// above { shouldDrop = drop, ... } = opts

// let tokens = parseCSS(opts.css) =&gt;
   let tokens = parseCSS(css, keepAlternate)</code></pre>
            
            
            </div>
            
            
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='9'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/3.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="initial-documentation">
            <h2>Initial Documentation</h2>
            
            <p>Before we continue to adding actual logic to allow to preserve <em>alternate</em> comments, let's add some documentation to <em>TrapCSS</em>. The docs are kept in the <strong>documentary</strong> folder and are split by files, which are put in order by documentation software. The <strong>index.md</strong> and <strong>footer.md</strong> files in each of the inner dirs always go first and last respectively. The root <strong>index.md</strong> already contains the description which was placed in there by <em>MNP</em>. It also has the installation snippet and table of contents. But we can add some more text from the forked package to describe what the software will do, and some additional links.</p>
            
            <pre id="c1953"><code class="markdown hljs">&lt;!-- documentary/index.md --&gt;
```sh
yarn add trapcss
npm install -D trapcss
```

## Introduction

_TrapCSS_ takes your HTML and CSS as input and returns only
the used CSS as output. Its custom HTML and CSS parsers are
highly optimized for the 99% use case and thus avoid the
overhead of handling malformed markup or stylesheets, ...

&lt;kbd&gt;📙 [READ WIKI PAGES](../../wiki)&lt;/kbd&gt;

%~%

%TOC%

%~%</code></pre>
            
            <p>We'll give a link to wiki which contains some more detailed information, which will be compiled later. We use section breaks like <span class="tm">%~%</span> which insert visual separators between sections.</p>
            
            <p>The <strong>api/index.md</strong> also contains essential data for generation of the README file:</p>
            
            <pre id="c19531"><code class="markdown hljs">&lt;typedef method="trapcss"&gt;types/api.xml&lt;/typedef&gt;

&lt;typedef&gt;types/index.xml&lt;/typedef&gt;

%EXAMPLE: example, ../src =&gt; trapcss%
%FORK example%</code></pre>
            
            <p><em>Documentary</em> uses components and markers. The typedef component allows to place method headings (when the <span class="tm">method=</span> attribute is given) and markdown tables with record descriptions.</p>
            
            <p>The typedefs will result in the following generated text:</p>
            
            <pre id="c19532"><code class="markdown hljs">## &lt;code&gt;&lt;ins&gt;trapcss&lt;/ins&gt;(&lt;/code&gt;&lt;sub&gt;&lt;br/&gt;&amp;nbsp;&amp;nbsp;`opts: Config,`&lt;br/&gt;&lt;/sub&gt;&lt;code&gt;): &lt;i&gt;Return&lt;/i&gt;&lt;/code&gt;
Parses the supplied HTML and CSS and removes
unused selectors. Also removes empty CSS rules.

 - &lt;kbd&gt;&lt;strong&gt;opts*&lt;/strong&gt;&lt;/kbd&gt; &lt;em&gt;&lt;code&gt;&lt;a href="#type-config" title="Options for the program."&gt;Config&lt;/a&gt;&lt;/code&gt;&lt;/em&gt;: The options for _TrapCSS_.

__&lt;a name="type-config"&gt;`Config`&lt;/a&gt;__: Options for the program.


|     Name      |               Type                |                                                                                                     Description                                                                                                      | Default |
| ------------- | --------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- |
| __html*__     | &lt;em&gt;string&lt;/em&gt;                   | The input HTML.                                                                                                                                                                                                      | -       |
| __css*__      | &lt;em&gt;string&lt;/em&gt;                   | The CSS to drop selectors from.                                                                                                                                                                                      | -       |
| keepAlternate | &lt;em&gt;boolean&lt;/em&gt;                  | Whether to keep the `@alternate` comment for&lt;br/&gt;Closure Stylesheets.                                                                                                                                                | `false` |
| shouldDrop    | &lt;em&gt;(sel: string) =&gt; boolean&lt;/em&gt; | Whether _TrapCSS_ should remove this selector.&lt;br/&gt;The `shouldDrop` hook is called for every CSS selector&lt;br/&gt;that could not be matched in the html. Return `false`&lt;br/&gt;to retain the selector or `true` to drop it. | -       |


__&lt;a name="type-return"&gt;`Return`&lt;/a&gt;__: Return Type.


|   Name    |            Type             |     Description     |
| --------- | --------------------------- | ------------------- |
| __css*__  | &lt;em&gt;string&lt;/em&gt;             | The dropped CSS.    |
| __sels*__ | &lt;em&gt;!Set&amp;lt;string&amp;gt;&lt;/em&gt; | The used selectors. |</code></pre>
            
            <p>which looks like on the screenshot below:</p>
            
            <p>
              <img class="ImageHolder b-bk b-vk b-t" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px" alt="generated method heading and types" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='777' height='622'/%3E">
              <noscript>
                <picture>
                  <source
                    srcset="/nodetools/pages/trapcss/4-readme/img/trap-768.webp 768w,/nodetools/pages/trapcss/4-readme/img/trap-576.webp 576w,/nodetools/pages/trapcss/4-readme/img/trap-319.webp 319w,/nodetools/pages/trapcss/4-readme/img/trap-777.webp 777w" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px"
                    type="image/webp">
                  <img class="b-bk b-vk b-t" onLoad="webploaded(this)" alt="generated method heading and types" src="/nodetools/pages/trapcss/4-readme/img/trap-768.png" srcset="/nodetools/pages/trapcss/4-readme/img/trap-768.png 768w,/nodetools/pages/trapcss/4-readme/img/trap-576.png 576w,/nodetools/pages/trapcss/4-readme/img/trap-319.png 319w,/nodetools/pages/trapcss/4-readme/img/trap-777.png 777w" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px">
                </picture>
              </noscript>
            </p>
            
            <p>The heading is generated from the first <span class="tm2">typedef</span>, and type tables from the second one. Any types that are referenced on the page will be linked, such as the <em>Config</em> type of <strong>opts</strong> in the function's description. To generate README, we run the <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>doc</span></span></span> command, and the <strong>doc</strong> script consists of: <span class="tm">doc [documentary] ...</span></p>
            
            <ul>
              <li><strong>-o README.md</strong>: the output file</li>
              <li><strong>-n _trapcss</strong>: the root namespace</li>
              <li><strong>-a</strong>: generate annotations into <span class="tm2">typedefs.json</span></li>
              <li><strong>-d</strong>: verbose debug logging</li>
            </ul>
            
            <p>The default location for input is <strong>documentary</strong> but it can be changed. Method headings can also be <a href="https://github.com/artdecocode/documentary/wiki/Custom-Methods">customised</a> using your own <span class="tm">&lt;method&gt;</span> component put into <strong>.documentary</strong> folder. Once again, the dev process for documentation is fully automated and provides customisation strategies so you can express your own creativity with custom method headings. Custom type tables via JSX components will be supported in future versions also.  Submit <a href="/nodetools/#getting-help">an issue</a> if you run into difficulties during customisation.</p>
            
            <p><em>Documentary</em> is not a simple JSDoc to HTML generator. It's an advanced piece of software that allows to compile full, quality documentation from examples, markdown and type information. It's there to make you effective at writing READMEs and automate the process as much as possible, but you're in control of how your docs look like.</p>
            
            
            
            <div data-section id="examples-to-outputs">
            <h3>Examples To Outputs</h3>
            
            <p>The second most useful feature of <em>NodeTools</em> after the compiler is the ability to automatically place examples into README, and compute their output which is also added to README. We use the <span class="tm">%EXAMPLE%</span> marker to reference the example file that comes from the <strong>examples</strong> folder. All paths will be resolved in Node style conventions, i.e. by looking up the <strong>index.js</strong> file if a directory is passed, so we can simply reference <strong>example</strong> dir. Let's create a sample usage of our program with some HTML and CSS to see if it works.</p>
            
            <pre id="c19533"><code class="markdown hljs">%EXAMPLE: example, ../src =&gt; trapcss%</code></pre>
            
            <p>When placing examples, we can actually rename the local import into the package name so it looks professional to our users who can then just copy and paste the example into their own code.</p>
            
            <pre id="ccdbf25"><code class="javascript hljs">import trapcss from '../src'

let html = `
    &lt;html&gt;
        &lt;head&gt;&lt;/head&gt;
        &lt;body&gt;
            &lt;p&gt;Hello World!&lt;/p&gt;
        &lt;/body&gt;
    &lt;/html&gt;
`

let css = `
    html {
      background: yellow;
      /* @alternate */
      background: green;
    }
    .card {
      padding: 8px;
    }
    p:hover a:first-child {
      color: red;
    }
`

const whitelist = /#foo|\.bar/

let dropped = new Set()

let cleaned = trapcss({
  html,
  css,
  shouldDrop(sel) {
    if (whitelist.test(sel))
      return false
    else {
      dropped.add(sel)
      return true
    }
  },
})

console.log(cleaned.css)

console.error(dropped)</code></pre>
            
            <p>To test the example before actually compiling docs, we can call <span class="tm">alanode</span> which is a simple proxy process to Node with a require hook that transpiles imports. It's executed via the package manager: <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>alanode</span> <span>example/</span></span></span>.</p>
            
            <pre id="c414d2"><code class="bash hljs">MacBook:trapcss zavr$ yarn alanode example/
html{background: yellow;background: green;}
Set { '.card', 'p:hover a:first-child' }</code></pre>
            
            <p>The example is working fine, so we can embed it. If at any point you see blank code blocks in your READMEs, try executing examples with <span class="tm">alanode</span> to check for any errors. We're going to modify the markdown file in the following way:</p>
            
            <pre id="c19534"><code class="markdown hljs">&lt;!-- was: --&gt;
&lt;!-- %FORK example% --&gt;

&lt;!-- now: --&gt;

%FORK-css example%
%FORKERR-js example%</code></pre>
            
            <p>It's possible to fork a single process and then pipe both stdout and stderr streams into the documentation. The language of the fork is also given within <span class="tm">FORK-{lang}</span> which means that <em>stdout</em> will be printed as CSS and <em>stderr</em> as JS code blocks. Forked JS modules are also cached so that if the example and/or any of its dependencies (src files, or imported packages' versions) changed, data will be read from cache which saves a lot of time for more complex programs that might call external APIs or system IO. Specifying language enables syntax highlighting on <em>GitHub</em> so that docs will look neat.</p>
            
            <p>
              <img class="ImageHolder b-vk b-t" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px" alt="example with syntax highlighting on github" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='808' height='120'/%3E">
              <noscript>
                <picture>
                  <source
                    srcset="/nodetools/pages/trapcss/4-readme/img/trap2-768.webp 768w,/nodetools/pages/trapcss/4-readme/img/trap2-576.webp 576w,/nodetools/pages/trapcss/4-readme/img/trap2-319.webp 319w,/nodetools/pages/trapcss/4-readme/img/trap2-808.webp 808w" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px"
                    type="image/webp">
                  <img class="b-vk b-t" onLoad="webploaded(this)" alt="example with syntax highlighting on github" src="/nodetools/pages/trapcss/4-readme/img/trap2-768.png" srcset="/nodetools/pages/trapcss/4-readme/img/trap2-768.png 768w,/nodetools/pages/trapcss/4-readme/img/trap2-576.png 576w,/nodetools/pages/trapcss/4-readme/img/trap2-319.png 319w,/nodetools/pages/trapcss/4-readme/img/trap2-808.png 808w" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px">
                </picture>
              </noscript>
            </p>
            
            <p>When documenting code, we can keep <em>Documentary</em> running with the <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>doc</span> <span class="npm-cmd">--</span> <span>-p "commit message"</span></span></span> command. It will watch for changes in the source folder, as well as any assets such as examples, automatically replace the last commit when changes are detected, and force push the new git tree. So we can work on examples and styling of the docs, and immediately see updates on <em>GitHub</em> (after a page refresh).</p>
            
            <p>At this point, without having written any tests, we already confirmed that our package is working correctly, because we managed to execute an example and place its output into the README file. This is called using documentation for quality assurance, as it lets us see the expected output. If the output was different from the one we wanted (or there was no output at all), we'd realise that by the time our documentation is uploaded on <em>GitHub</em> (in automatic mode) or in git diffs (when running a single <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>doc</span></span></span> command).</p>
            
            
            </div>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='9'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/4.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="creating-tests">
            <h2>Creating Tests</h2>
            
            <p>Tests for the original packages were written for <em>Mocha</em> testing framework, but we need to update them into <em>Zoroaster</em> context-testing specs and masks. Let's take <a
              href="https://github.com/leeoniya/dropcss/blob/2a883e5107c68c2181d4c0e02b30e15cf4e7736c/test/src/0-context-free-unary-sel.js">
              the first test suite</a> and have a look at its structure:</p>
            
            <pre id="ccdbf26"><code class="javascript hljs">const dropcss = require('../../src/dropcss.js')
const assert = require('assert')

describe('Context-free, unary selector', () =&gt; {
  let html, css

  describe('*', () =&gt; {
    it('should retain present', function() {
      let { css: out } = dropcss({
        html:	'&lt;div&gt;&lt;/div&gt;',
        css:	'* {a:b;}',
      })
      assert.equal(out, '*{a:b;}')
    })
  })

  describe('&lt;tag&gt;', () =&gt; {
    it('should retain present', function() {
      let { css: out } = dropcss({
        html:	'&lt;div&gt;&lt;/div&gt;',
        css:	'div {a:b;}',
      })
      assert.equal(out, 'div{a:b;}')
    })

    it('should drop absent', function() {
      let { css: out } = dropcss({
        html:	'&lt;div&gt;&lt;/div&gt;',
        css:	'span {a:b;}',
      })
      assert.equal(out, '')
    })
  })

  describe('#id', () =&gt; {
    it('should retain present', function() {
      let { css: out } = dropcss({
        html:	'&lt;div id="a"&gt;&lt;/div&gt;',
        css:	'#a {a:b;}',
      })
      assert.equal(out, '#a{a:b;}')
    })

    it('should drop absent', function() {
      let { css: out } = dropcss({
        html:	'&lt;div id="a"&gt;&lt;/div&gt;',
        css:	'#b {a:b;}',
      })
      assert.equal(out, '')
    })
  })
})</code></pre>
            
            <p>We can see that each time the logic is pretty much the same: we use the <span class="tm">&lt;div&gt;&lt;/div&gt;</span> html as HTML string for first cases, but change it to <span class="tm">&lt;div id=&quot;a&quot;&gt;&lt;/div&gt;</span> for ID selector tests, then manipulate some CSS from test to test and expect the result to be equal to certain values. All tests are written within <strong>describe</strong> and <strong>it</strong> blocks for <em>Mocha</em> which has been in use for testing both back-end and front-end applications for a long time. In contrast, <em>NodeTools</em>, being an entirely new stack for professional web development, includes a brand new testing framework called <em>Zoroaster</em> that is really low-weight, yet contains more features out of the box than its main competitors and introduces new concepts in <em>Quality Assurance</em> such as mask- and context-testing.</p>
            
            <p>
              <img class="ImageHolder b-t" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px" alt="Zoroaster comparison with other testing frameworks table" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='739' height='269'/%3E">
              <noscript>
                <picture>
                  <source
                    srcset="/nodetools/pages/trapcss/5-testing/img/zoroaster-576.webp 576w,/nodetools/pages/trapcss/5-testing/img/zoroaster-319.webp 319w,/nodetools/pages/trapcss/5-testing/img/zoroaster-739.webp 739w" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px"
                    type="image/webp">
                  <img class="b-t" onLoad="webploaded(this)" alt="Zoroaster comparison with other testing frameworks table" src="/nodetools/pages/trapcss/5-testing/img/zoroaster-576.png" srcset="/nodetools/pages/trapcss/5-testing/img/zoroaster-576.png 576w,/nodetools/pages/trapcss/5-testing/img/zoroaster-319.png 319w,/nodetools/pages/trapcss/5-testing/img/zoroaster-739.png 739w" sizes="(max-width: 575.8px) 100vw,(max-width: 991.8px) 540px,(max-width: 1199.8px) 720px,855px">
                </picture>
              </noscript>
            </p>
            
            <div data-section id="mask-testing">
            <h3>Mask Testing</h3>
            
            <p>Tests like the ones shown above are perfect candidates for mask testing &mdash; a new type of tests where using a template called test mask we generate many specs at runtime based on multiple input-to-output mappings that come from a separate file called mask result. If you've ever used a loop to call <strong>describe</strong> and <strong>it</strong> methods by hand, you'll be familiar with the concept of dynamic test suite construction. <em>Zoroaster</em> provides an official standard way to do that, and coins the term <em>mask testing</em> to name this process.</p>
            
            <p>Each program or method is just a state machine that maps inputs to outputs on a problem space. While testing, we control inputs, and observe outputs, which are then asserted on for correctness of the algorithm. Therefore specs that we write, allow us to mask the problem space using inputs as variables.</p>
            
            <p>Consider the example below (move mouse over the black screen to discover the problem space): one way to interpret the graph is as of a function that accepts 2 variables (<strong>x1</strong> and <strong>x2</strong>) and outputs <strong>y</strong> according to inputs (in real life though, these are just data points in a 3D space). To know this Y position, we need to execute the function and see what output it produces. Such machine learning models as a regression model allow to <em>approximate</em> real-world functions using planes, but the point of this example is that a mask is a collection of specs, where each spec is a data point. The mask is that circle you see on a diagram, that envelops a number of crosses, i.e. exact data points (specs) that we collect by running tests. The more specs we generate, the fuller picture we get. Ideally, we want to test all possible inputs including edge cases, but practically we just want to meet our requirements.</p>
            
            <div data-loading style="position:relative;" id="ce1cb">
              <canvas style="max-width:100%;" class="Mask">Your browser doesn't support canvas.</canvas>
              <a style="display:block;" href="#">Lights on</a>
            </div>
            <noscript>
              <img style="max-width:100%" alt="Mask Testing Problem Space Graph" data-io>
              <noscript>
                <img style="max-width:100%" alt="Mask Testing Problem Space Graph"
                  src="/nodetools/pages/trapcss/5-testing/img/regression.jpg">
              </noscript>
            </noscript>
            
            <blockquote class="b-r">
              A spec is a single data point on the algorithm's problem space, whereas a mask is a collection of such points. Mask testing allows to generalise spec creation process and provides a broader strategy for quality assurance.
            </blockquote>
            
            <p>Pure functions will always produce the same result, so we want to program mostly in functional style to avoid side effects in script scopes that make mapping non-deterministic. But no need to worry as it's probably what you've been doing with JS anyway. However with <em>Mocha</em>, it's become almost an anti-pattern to keep certain variables in the <strong>describe</strong> scope, which is error-prone. This is why all such scoped variables that can be used in tests are moved into a context in <em>Zoroaster</em>, and test cases become pure, but more on context-testing later.</p>
            
            <p>So what are we controlling with these first <em>TrapCSS</em> tests? Basically, it's HTML and CSS, and we assert on the output. This means we need 2 input properties, and one output. Masks by default look like the following:</p>
            
            <pre id="c19535"><code class="markdown hljs">[Optional preamble to the whole mask]

## test name
input

/* expected */
output
/**/

## test name2
input

/* property */
optional additional prop with
some controlled value
/**/
/* expected */
output 2
/**/</code></pre>
            
            <p>This means we give spec names, can add any number of properties, and pass the expected output for comparison also. The testing framework will then execute the test logic that is written only once, and using string assertion (or deep equal for objects), compare the output to expected. In case of an error, it will be shown in the console and the framework will exit with the status code > 0.</p>
            
            <p>In this case, we can construct the following mask. It's a bit complex for the first ever example of a mask, but bear with me, it's not that complicated.</p>
            
            <pre id="ccdbf27"><code class="javascript hljs">import makeTestSuite from '@zoroaster/mask'
import trapcss from '../../src'

// todo: test [foo="val"], [foo='val'], :not([attr~=value])
const contextFreeUnarySel = makeTestSuite(
  'test/result/0-context-free-unary-sel', {
    getResults() {
      let html, css
      if (!this.preamble) {
        [html, ...css] = this.input.split('\n')
        css = css.join('\n')
      } else {
        html = this.preamble
        css = this.input
      }
      [,html] = /content: '(.+?)'/.exec(html)
      return trapcss({ html, css })
    },
    mapActual({ css }) {
      return css
    },
  })

export default {
  'Context-free, unary selector': contextFreeUnarySel,
}</code></pre>
            
            <p>To create a mask, we import the <strong>makeTestSuite</strong> method from <span class="tm2">@zoroaster/mask</span> that comes together with <em>Zoroaster</em>. The first argument to this function is a path to the mask result file, or directory with multiple such files, that will be scanned recursively. The second argument is the actual config to the mask, and will include either methods like <span class="tm">getResults</span> (most general use case), <span class="tm">getReadable</span>, <span class="tm">getTransform</span> (if our library returned streams) or <span class="tm">fork</span> configuration (to test Node processes). All properties from the mask are available via the <span class="tm">this</span> keyword: <strong>this.preamble</strong>, <strong>this.input</strong>. We'll organise tests by files, so that a preamble in each file can be used as HTML input, whereas the body of each test will be the CSS string. When we don't write preamble, we'll split the test input by new line to derive HTML and CSS.</p>
            
            <p>We want to extract HTML using the regex: <span class="tm">[,html] = /content: '(.+?)'/.exec(html)</span>, to be able to receive syntax highlighting in mask results, which will be saved as <span class="tm">.scss</span> files. After HTML and CSS strings are ready, we simply pass them to <span class="tm2">trapcss</span> and return results. Our function is synchronous, but it would also be possible to test async methods by writing <span class="tm">async getResults(){}</span>. Using the mapping function <span class="tm">mapActual</span> we then return the css property of the whole result, so that it can be compared against the expected one from the mask result. If we wanted to assert on other properties from the result too using JavaScript, we could implement another method called <span class="tm">assertResults</span> but we're only interested in testing produced CSS here. This is how our mask results look like:</p>
            
            <pre id="cf5417"><code class="scss hljs">// *: should retain present
html { content: '&lt;div&gt;&lt;/div&gt;' }
* {a:b;}

/* expected */
*{a:b;}
/**/</code></pre>
            
            <p>This is the default mask result for the very first test, without a preamble, but with HTML followed by new line and CSS in the test body. The reason to write html in CSS is to keep syntax highlighting in the whole file, for example if we only gave HTML as a string, we'd get red lines everywhere in the file, as shown below.</p>
            
            <p>
              <img class="ImageHolder b-t" sizes="252px" alt="syntax highlighting is broken in VSCode if not using SCSS" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='252' height='132'/%3E">
              <noscript>
                <picture>
                  <source srcset="/nodetools/pages/trapcss/5-testing/img/syntax-252.webp 252w" sizes="252px" type="image/webp">
                  <img class="b-t" onLoad="webploaded(this)" alt="syntax highlighting is broken in VSCode if not using SCSS" src="/nodetools/pages/trapcss/5-testing/img/syntax-252.png" srcset="/nodetools/pages/trapcss/5-testing/img/syntax-252.png 252w" sizes="252px">
                </picture>
              </noscript>
            </p>
            
            <p>Each new tests starts with the comment <span class="tm">//</span> characters &mdash; a default unless a markdown file is used, in which case it'd be <span class="tm">##</span>. This can also be controlled via the <span class="tm">splitRe</span> setting of the mask config.</p>
            
            <pre id="cf5418"><code class="scss hljs">html { content: '&lt;div&gt;&lt;/div&gt;' }

// should retain present
div {a:b;}

/* expected */
div{a:b;}
/**/

// should drop absent
span {a:b;}

/* expected */
/**/

// :not - should retain present
:not(span) {a:b;}

/* expected */
:not(span){a:b;}
/**/

// :not - should drop absent
:not(div) {a:b;}

/* expected */
/**/</code></pre>
            
            <p>This is the mask result for test suite with the tag testing, where HTML is given at the top of the file (called preamble) to be accessed by each test. We can also duplicate this file and change the div tag to self-closing tag in a single place (preamble), to increase test coverage easily. Where the output of the test is expected to be a 0-length string, we just leave the expected property empty.</p>
            
            <pre id="cf5419"><code class="scss hljs">html { content: '&lt;div id="a"&gt;&lt;/div&gt;' }

// should retain present
#a {a:b;}

/* expected */
#a{a:b;}
/**/

// should drop absent
#b {a:b;}

/* expected */
/**/

// :not - should retain present
:not(#b) {a:b;}

/* expected */
:not(#b){a:b;}
/**/

// :not - should drop absent
:not(#a) {a:b;}

/* expected */
/**/</code></pre>
            
            <p>These are tests for the ID selector, where we used preamble as HTML input for all tests. We write such html as the <span class="tm">content</span> property of the CSS rule, so that the IDE will provide syntax highlighting for the best pleasant developer experience while testing. There are more tests for attribute selectors which you can <a
              href="https://github.com/kumarikandam/trapcss/tree/master/test/result/0-context-free-unary-sel/attr">
              study in the repository</a> but they all follow the same logic so we skip talking about them here.</p>
            
            <p>To run our tests, there are a number of <strong>package.json</strong> scripts that can be used: <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>[spec|mask|test]</span></span></span> depending on whether we want to run specs (see later section), masks or all. We'll just run <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span class="npm-run">run </span><span>mask</span></span></span> after having constructed our first mask tests.</p>
            
            <pre id="c414d3"><code class="bash hljs">yarn run v1.13.0
$ yarn t test/mask
$ zoroaster -a test/mask
 test/mask
   bin
   unary
     Context-free, unary selector
      ✓  *: should retain present
       #id
        ✓  should retain present
        ✓  should drop absent
        ✓  :not - should retain present
        ✓  :not - should drop absent
       .class
        ✓  should retain present
        ✓  should drop absent
        ✓  :not - should retain present
        ✓  :not - should drop absent
       &lt;tag&gt;
        ✓  should retain present
        ✓  should drop absent
        ✓  :not - should retain present
        ✓  :not - should drop absent
       &lt;tag⁄&gt;
        ✓  should retain present
        ✓  should drop absent
        ✓  :not - should retain present
        ✓  :not - should drop absent
       attr
        ✓  [attr]: should retain present
        ✓  [attr]: should drop absent
        ✓  [attr=value]: should retain present
        ✓  [attr=value]: should drop absent
        ✓  [attr*=value]: should retain present
        ✓  [attr*=value]: should drop absent
        ✓  [attr^=value]: should retain present
        ✓  [attr^=value]: should drop absent
        ✓  [attr$=value]: should retain present
        ✓  [attr$=value]: should drop absent
        ✓  [attr~=value]: should retain present
        ✓  [attr~=value]: should retain present (multiple first)
        ✓  [attr~=value]: should retain present (multiple second)
        ✓  [attr~=value]: should drop absent
        ✓  [attr~=value]: should drop absent (reverse)
         :not
          ✓  [attr]: should retain present
          ✓  [attr]: should drop absent
          ✓  [attr=value]: should retain present
          ✓  [attr=value]: should drop absent
          ✓  [attr*=value]: should retain present
          ✓  [attr*=value]: should drop absent
          ✓  [attr^=value]: should retain present
          ✓  [attr^=value]: should drop absent
          ✓  [attr$=value]: should retain present
          ✓  [attr$=value]: should drop absent

🦅  Executed 42 tests.
Done in 1.85s.</code></pre>
            
            
            </div>
            
            <div data-section id="focus-in-masks">
            <h3>Focus In Masks</h3>
            
            <p>To focus on a particular test, we can prepend its name with <span class="tm">!</span> in the mask result like so:</p>
            
            <pre id="cf541"><code class="scss hljs">// !should retain present
#a {a:b;}

/* expected */
#a{a:b;}
/**/</code></pre>
            
            <p>It's also possible to focus on an entire mask, by adding <span class="tm">!</span> to the path of a mask result, or exporting the mask with <span class="tm">$</span> name:</p>
            
            <pre id="ccdbf11"><code class="javascript hljs">// use ! in mask result path
const contextFreeUnarySel = makeTestSuite(
  '!test/result/0-context-free-unary-sel', {
    getResults() {},
    // ...
  })

// named export with $
export const $contextFreeUnarySel = makeTestSuite(
  'test/result/0-context-free-unary-sel', {
    getResults() {},
    // ...
  })

// export with $ in object
export default {
  '$Context-free, unary selector': contextFreeUnarySel,
}</code></pre>
            
            <p>In <em>Zoroaster</em>, test suites are nested objects. For better reporting, we exported the default test suite as an object with the <span class="tm">Context-free, unary selector</span> property that contains the test suite generated by the mask. But we could also simply export a variable using a named export, it's just that we won't be able to report the test suite name as a sentence with whitespace and commas.</p>
            
            
            </div>
            
            <div data-section id="interactive-mode">
            <h3>Interactive Mode</h3>
            
            <p>If the test was failing, <em>Zoroaster</em> would use string comparison algorithm to present where the error was in color. Let's imagine we entered our expected value incorrectly:</p>
            
            <pre id="cf5411"><code class="scss hljs">// !should retain present
#a {a:b;}

/* expected */
.a{a:c;}
/**/</code></pre>
            
            <p>The error will be shown using color highlighting in the CLI. Moreover, it's possible to run <em>Zoroaster</em> in <strong>interactive</strong> mode with the <span class="tm">-i</span> flag that will tell the testing framework that we want to interact with it to update mask results in place if errors were found, as demonstrated below.</p>
            
            <p>
              <img class="b-vk b-bk b-t" alt="using testing framework zoroaster to update mask results in place" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='720' height='528'/%3E" data-io>
              <noscript>
                <img class="b-vk b-bk b-t" alt="using testing framework zoroaster to update mask results in place" src="/nodetools/pages/trapcss/5-testing/img/i.gif">
              </noscript>
            </p>
            
            <p>The default option is to update, but more info can be shown if <span class="tm">d</span> is pressed, or no updates are made if anything else is passed, in which case the test suite will fail. This is a useful method for quickly drafting new inputs with empty outputs, running interactive mode on them, and populating mask files with outputs, that can then be changed manually or kept as is for more robust regression testing.</p>
            
            </div>
            
            <div data-section id="more-masks">
            <h3>More Masks</h3>
            
            <p>Let's add some more mask testing.</p>
            
            <pre id="ccdbf12"><code class="javascript hljs">// test/mask/default.js

import makeTestSuite from '@zoroaster/mask'
import trapcss from '../../src'

const T = makeTestSuite([
  'test/result/@keyframes.scss',
  'test/result/@font-face.scss'], {
  getResults() {
    const css = this.preamble
    const prepend = this.input

    const { css: out } = trapcss({
      html: '&lt;div&gt;&lt;/div&gt;',
      css: prepend + css,
    })
    return out
  },
})</code></pre>
            
            <p>The <strong>makeTestSuite</strong> method accepts an array of paths in addition to paths to files and paths to directories. When passing an array, an object will be created where basenames of files from the array are test suite names within the exported object. Above, we just created a <span class="tm">T</span> variable, which will be exported as <strong>default</strong> later. When a test suite has the name "default", its properties are merged up with its parent test suite, so that <span class="tm">default</span> test suites' names are never shown during reporting.</p>
            
            <p>The tests for keyframes and font faces have the same structure: they include some page-wide CSS with <span class="tm">@keyframes</span> (or <span class="tm">@font-face</span>) rules that is placed in the preamble. The test input is a CSS rule that would reference this <span class="tm">@keyframes</span> (or <span class="tm">@font-face</span>)  declaration, so we don't want our library to drop those rules. Therefore, we take the test input and append it to those declarations which are then fed to our <span class="tm2">trapcss</span> method.</p>
            
            
            
            <pre id="cf5412"><code class="scss hljs">div{color: red;}
@keyframes pulse{0%{width:300%;}100%{width:100%;}}
@-webkit-keyframes pulse{0%{width:300%;}100%{width:100%;}}
@keyframes nudge{0%{width:300%;}100%{width:100%;}}
@-webkit-keyframes nudge{0%{width:300%;}100%{width:100%;}}
@keyframes bop{0%{width:300%;}100%{width:100%;}}
@-webkit-keyframes bop{0%{width:300%;}100%{width: 100%;}}
span{color: black;}

// drops all

/* expected */
div{color: red;}
/**/

// drops pulse, nudge
div{animation-name: bop;}

/* expected */
div{animation-name: bop;}div{color: red;}@keyframes bop{0%{width:300%;}100%{width:100%;}}@-webkit-keyframes bop{0%{width:300%;}100%{width: 100%;}}
/**/</code></pre>
            
            <p>We can skip adding inputs, if we want to pass an empty string to the test case. This is illustrated with the <em>drops all</em> test case. <em>DropCSS</em> also removes whitespace, therefore our output is placed on a single line. The font face mask results follow the same logic as keyframes. But we also have a special case for font faces:</p>
            
            <pre id="ccdbf13"><code class="javascript hljs">const fontfaceCustomProps = makeTestSuite(
  'test/result/fontface-custom-props.scss', {
    getResults() {
      const prepend = this.preamble
      const css = this.input

      const { css: out } = trapcss({
        html: '&lt;div&gt;&lt;/div&gt;',
        css: this.doPrepend === false ? css : (prepend + css),
      })
      return out.replace(css, '')
    },
    jsProps: ['doPrepend'],
  })

T['@font-face (custom props)'] = fontfaceCustomProps

export default T</code></pre>
            
            <p>Custom properties means that font faces can be declared with variables. Our root CSS is still taken from preamble, but we add a new property called <strong>doPrepend</strong> that controls whether it should actually be added to the CSS from input. It allows to put tests in the same result file, but tinker the test logic slightly from test cases themselves (by using properties). Properties could also be written as JSON or JS, in which case we'd need to pass another config item called <span class="tm">js[on]Props: ['doPrepend']</span> that would make the testing framework parse those properties into a JS object. By default, we do prepend the preamble to input CSS, and only when the <strong>doPrepend</strong> property is explicitly set to <span class="tm">false</span>, we don't do it.</p>
            
            <p>Because all test suites generated in this file should be on the same level, but the name of the custom-props test suite had to be written in English with spaces (hence it couldn't be exported as simple variable), we assigned a property to the default object <span class="tm">T</span> which is then exported. It's not proper ECMA modules standard since a named export is assigned to a default export which is a function, but behind the scenes exports are transpiled into simple <strong>module.exports</strong> assignments anyway, so there's no problem with hacks like this.</p>
            
            <pre id="ccdbf14"><code class="javascript hljs">// transpilation example
const T = makeTestSuite()
T['@font-face (custom props)'] = fontfaceCustomProps

// export default T
module.exports = T
// export const keyframes = makeTestSuite()
module.exports.keyframes = keyframes</code></pre>
            
            <p>We run <em>Zoroaster</em> with <span class="tm">-a</span> flag that enables <em>ÀLaMode</em> transpilation. <em>Zoroaster</em> is not yet compatible with Node 13's <span class="tm2">mjs</span> modules (sorry). We'll provide an <em>MNP</em> template setting for native mjs modules by the time Node 14 (LTS) is out, but the transpiler is a 0-dep package anyway.</p>
            
            <pre id="cf5413"><code class="scss hljs">div{color: red;}:root {--font-family: Foo, 'Bar Baz';}
@font-face {font-family: Foo}

// 1) drops if unused --font-family: should not be confused with font use
div{font-family: 'Open Sans', Fallback, sans-serif;}

/* expected */
div{color: red;}div{font-family: 'Open Sans', Fallback, sans-serif;}
/**/

// 2) retains if used in font-family
div{font-family: var(--font-family);}

/* expected */
div{color: red;}:root{--font-family: Foo, 'Bar Baz';}@font-face{font-family: Foo}div{font-family: var(--font-family);}
/**/

// 3) retains if used - deep resolve
:root {--font: var(--sty) var(--wgt) 1em/var(--lht) var(--fam1), var(--fam2); --sty: italic; --wgt: bold; --lht: var(--hgt)em; --fam1: 'Open Sans'; --fam2: Arial; --hgt: 1.6;}
@font-face {font-family: var(--fam1);}
div {font: var(--font);}

/* doPrepend */
false
/**/

/* expected */
:root{--font: var(--sty) var(--wgt) 1em/var(--lht) var(--fam1), var(--fam2); --sty: italic; --wgt: bold; --lht: var(--hgt)em; --fam1: 'Open Sans'; --fam2: Arial; --hgt: 1.6;}@font-face{font-family: var(--fam1);}div{font: var(--font);}
/**/</code></pre>
            
            <p>In the first test, we checked that if a font-face declared as a variable wasn't used, it's declaration and block with declaration of its variable that became empty were dropped. In the second test we verified that the variable block as well as the rule block that uses this variable are kept. Finally, the third test made sure that when the font property references a variable which in turn references another variable, the CSS is retained.</p>
            
            <p>The next test suite is pretty simply, but reads HTML from its own property rather than from the preamble as it will be changed from test to test.</p>
            
            <pre id="ccdbf15"><code class="javascript hljs">export const customProps = makeTestSuite(
  'test/result/custom-props.scss', {
    getResults() {
      const [,html] = /content: '(.+?)'/.exec(this.html)
      const { css } = trapcss({
        html,
        css: this.input,
      })
      return css
    },
  })</code></pre>
            
            <p>There's actually only one test in this test suite, but the point is that instead of repeating JS logic time and time again, we can simply be adding new test cases by specifying their inputs and outputs. It saves a lot of time and makes us very agile during development &mdash; if a bug needs to be fixed, or a feature added, we can go to the mask result, add the input, keep the output empty, generate current output using interactive mode, adjust it to how it should be, run tests, see them fail, then adjust source code to achieve desired behaviour.</p>
            
            <pre id="cf5414"><code class="scss hljs">// does not confuse BEM -- classes with custom props
:root{--red: #f00;}.a--b:hover{color: var(--red);}.--c{width: 10px;}

/* html */
html { content: '&lt;div class="a--b"&gt;&lt;/div&gt;&lt;div class="--c"&gt;&lt;/div&gt;' }
/**/

/* expected */
:root{--red: #f00;}.a--b:hover{color: var(--red);}.--c{width: 10px;}
/**/</code></pre>
            
            <p>The final test is for our new functionality that allows to preserve <strong>alternate</strong> comments. We could also write it as a spec, but masks are just as suitable for this task.</p>
            
            <pre id="ccdbf16"><code class="javascript hljs">export const alternate = makeTestSuite(
  'test/result/alternate.scss', {
    getResults() {
      const { css } = trapcss({
        html: '&lt;div/&gt;',
        css: this.input,
        keepAlternate: true,
      })
      return css
    },
  })</code></pre>
            
            <p>Original <em>DropCSS</em> also doesn't produce pretty output, which is another reason why I wanted to run it through <em>Stylesheets</em> after its pass. If we were to place output in specs, we'd have to define a string with multiple lines and complex formatting, and assert using string equality, which wouldn't show where strings were different, like masks do with red/green color diffs.</p>
            
            <pre id="cf5415"><code class="scss hljs">// keeps the alternate comment
div {
  text-decoration: underline;
  /* @alternate */
  text-decoration: underline dotted;
}
/* expected */
div{text-decoration: underline;
  /* @alternate */
  text-decoration: underline dotted;}
/**/</code></pre>
            
            </div>
            
            <div data-section id="error-stacks">
            <h3>Error Stacks</h3>
            
            <p>Please note that if there was a run-time error in algorithms, the report will only show the location in the mask result where the test failed. Imagine that we made an mistake when creating the mask, by referencing the <span class="tm">.css</span> mask result property instead of <span class="tm">.input</span>, which evaluated to undefined, but our source code expected a string:</p>
            
            <pre id="cf5416"><code class="scss hljs">export const alternate = makeTestSuite(
  'test/result/alternate.scss', {
    getResults() {
      const { css } = trapcss({
        html: '&lt;div/&gt;',
        css: this.css,
        keepAlternate: true,
      })
      return css
    },
  })</code></pre>
            
            <p>We'd get the following error in the CLI:</p>
            
            <pre id="c414d4"><code class="bash hljs">$ zoroaster -a test/mask
 test/mask
   alternate
    ✗  !keeps the alternate comment
    | Error: Cannot read property 'replace' of undefined
    |     at !keeps the alternate comment (test/result/alternate.scss:13:1)</code></pre>
            
            <p>The error stack has been modified to point to the location of the test in the mask result (<strong>alternate.scss:13:1</strong>), for convenience of navigation, but it's not a problem with inputs/outputs, but test logic. To fix this, we need to set <span class="tm">DEBUG=1</span> env variable when running tests:</p>
            
            <pre id="c414d5"><code class="bash hljs">bash-3.2$ DEBUG=1 yarn mask
yarn run v1.13.0
$ yarn t test/mask
$ zoroaster -a test/mask
 test/mask
   alternate
TypeError: Cannot read property 'replace' of undefined
    at parse (/Users/zavr/adc/trapcss/src/css.js:178:13)
    at dropcss (/Users/zavr/adc/trapcss/src/index.js:40:16)
    at Object.getResults (/Users/zavr/adc/trapcss/test/mask/default.js:53:23)
    at /Users/zavr/adc/trapcss/node_modules/@zoroaster/mask/compile/depack.js:688:27
    at t.(anonymous function) (/Users/zavr/adc/trapcss/node_modules/@zoroaster/mask/compile/depack.js:789:15)
    at bb (/Users/zavr/adc/trapcss/node_modules/zoroaster/depack/bin/zoroaster.js:409:66)
    at &lt;anonymous&gt;
    ✗  !keeps the alternate comment
    | Error: Cannot read property 'replace' of undefined
    |     at !keeps the alternate comment (test/result/alternate.scss:13:1)</code></pre>
            
            <p>Now we're given the full stack. As a rule of thumb, whenever you encounter an error that you don't understand in <em>NodeTools</em>, try rerunning the program with <span class="tm">DEBUG=1</span> env variable &mdash; our convention is to display full error stacks when the <span class="tm">DEBUG</span> is set. This can help fix unknown errors.</p>
            
            </div>
            
            <div data-section id="context-testing">
            <h3>Context Testing</h3>
            
            <p>Overall, when executing new tests, we get the following report:</p>
            
            <pre id="c414d6"><code class="bash hljs">$ zoroaster -a test/mask/default.js
 test/mask/default.js
   @keyframes
    ✓  drops all
    ✓  drops pulse, nudge
    ✓  drops bop
    ✓  retains nudge
   @font-face
    ✓  retains if used
    ✓  retains if used (shorthand)
    ✓  drop if unused
    ✓  drops if unused (multiple defs)
   @font-face (custom props)
    ✓  drops if unused --font-family: should not be confused with font use
    ✓  retains if used in font-family
    ✓  retains if used - deep resolve
    ✓  drop if unused - deep resolve
   customProps
    ✓  does not confuse BEM -- classes with custom props
   alternate
div{text-decoration: underline;⏎
  /* @alternate */⏎
  text-decoration: underline dotted;}
    ✗  keeps the alternate comment
    | Error: 'div{text-decoration: underline;text-decoration: underline dotted;}' == 'div{text-decoration: underline;\n  /* @alternate */\n  text-decoration: underline dotted;}'
    |     at keeps the alternate comment (test/result/alternate.scss:1:1)

test/mask/default.js &gt; alternate &gt; keeps the alternate comment
  Error: 'div{text-decoration: underline;text-decoration: underline dotted;}' == 'div{text-decoration: underline;\n  /* @alternate */\n  text-decoration: underline dotted;}'
      at keeps the alternate comment (test/result/alternate.scss:1:1)

🦅  Executed 14 tests: 1 error.</code></pre>
            
            <p>The last error is due to the fact that the new functionality has not been implemented. But it's OK since it's in spirit of test-driven development: we added a test first, before the source code. With mask testing, the TDD methodology is easily embraced as test cases are very easy to add by simply providing new data. Instead of wasting our time on setting up test routines in JS, we can try to come up with as many use cases via masks.</p>
            
            <p><em>DropCSS</em> contains more tests, but for the purposes of the tutorial we don't need to look at them further, except for the integration test.</p>
            
            <pre id="ccdbf17"><code class="javascript hljs">describe('Bulma-Bootstrap-Surveillance', () =&gt; {
  let html, css;

  describe('stress test', () =&gt; {
    it('should run', function() {
      let {css: out} = dropcss({
        html:  fs.readFileSync(__dirname + '/../bench/stress/input/surveillance.html', 'utf8'),
        css:  fs.readFileSync(__dirname + '/../bench/stress/input/bootstrap.min.css', 'utf8') +
          fs.readFileSync(__dirname + '/../bench/stress/input/bulma.min.css', 'utf8'),
      });

      assert.equal(vkbeautify(out), fs.readFileSync(__dirname + '/../bench/stress/output/dropcss.pretty.css', 'utf8'));
    });
  });
});</code></pre>
            
            <p>We're going to write it as a spec, that will <strong>return</strong> the result of the call to <span class="tm">trapcss</span> function, since <em>Zoroaster</em> supports snapshots automatically by recording returned values in the <span class="tm">test/snapshot</span> directory, and then comparing all future returned values with the saved one. This is what our spec looks like:</p>
            
            <div class="b-tp" id="spec">
            <pre id="ccdbf18"><code class="javascript hljs">// test/spec/default.js

import ServiceContext from 'zoroaster'
import Context from '../context'
import trapcss from '../../src'

/** @type {Object.&lt;string, (c: Context, z: ServiceContext)&gt;} */
const T = {
  context: [Context, ServiceContext],
  'bench stress test'({ bootstrap, readFile, fixture }, { snapshotExtension }) {
    snapshotExtension('css')
    const bt = readFile(bootstrap)
    const bulma = readFile(fixture`bulma.min.css`)
    const css = bt + bulma
    const res = trapcss({
      css,
      html: readFile(fixture`surveillance.html`),
    })
    return res.css
  },
}

export default T</code></pre>
            
              <div class="b-up" style="opacity: 0; top: 1rem; right: 1rem;" id="c5823">
                <a class="b-Af b-Lf" href="#">Go Back</a>
              </div>
            </div>
            
            <p><em>Zoroaster</em> is a <strong>context-testing</strong> framework. <em>Contexts</em> are a way to unload test utilities, such as methods for reading files, from tests suites, by putting them in a single place called a context, and make them accessible via destructuring from each test case. In addition, instances of test contexts can implement <span class="tm">_init</span> and <span class="tm">_destroy</span> methods so it's an alternative to <span class="tm">beforeEach</span> and <span class="tm">afterEach</span> hooks for functional style programming, since each test case is now a pure function that receives testing API from arguments rather than scope. This allows to organise test suites by files instead of cramming them all into the same file because we relied on some complex set up routine that we don't want to copy/paste in each test suite file. In <em>DropCSS</em> we only relied on simple methods like <span class="tm">readFileSync</span> but in more complex software we might have more sophisticated API, e.g., in <a href="https://github.com/koajs/session/blob/master/test/contextstore.test.js">koa/session</a>:</p>
            
            <pre id="ccdbf19"><code class="javascript hljs">/* 750 lines of tests */

function App(options) {
  const app = new Koa();
  app.keys = [ 'a', 'b' ];
  options = options || {};
  options.ContextStore = ContextStore;
  options.genid = ctx =&gt; {
    const sid = Date.now() + '_suffix';
    ctx.state.sid = sid;
    return sid;
  };
  app.use(session(options, app));
  return app;
}</code></pre>
            
            <p>The <em>App</em> function is used by each single test, the test suite file is large because they are all tied to this testing API. There could be a separate file that exported this function, like it's done in Koa (<span class="tm">test/helpers/context.js</span>):</p>
            
            <pre id="ccdbf28"><code class="javascript hljs">
'use strict';

const Stream = require('stream');
const Koa = require('../..');

module.exports = (req, res, app) =&gt; {
  const socket = new Stream.Duplex();
  req = Object.assign({ headers: {}, socket }, Stream.Readable.prototype, req);
  res = Object.assign({ _headers: {}, socket }, Stream.Writable.prototype, res);
  req.socket.remoteAddress = req.socket.remoteAddress || '127.0.0.1';
  app = app || new Koa();
  res.getHeader = k =&gt; res._headers[k.toLowerCase()];
  res.setHeader = (k, v) =&gt; res._headers[k.toLowerCase()] = v;
  res.removeHeader = (k, v) =&gt; delete res._headers[k.toLowerCase()];
  return app.createContext(req, res);
};

module.exports.request = (req, res, app) =&gt; module.exports(req, res, app).request;

module.exports.response = (req, res, app) =&gt; module.exports(req, res, app).response;</code></pre>
            
            <p><em>Koa</em> then requires those helpers whenever it needs to in <a
              href="https://github.com/koajs/koa/blob/54e8fab3e3d907bbb264caf3e28a24773d0d6fdb/test/response/redirect.js">
              test suites</a>:</p>
            
            <pre id="ccdbf29"><code class="javascript hljs">const context = require('../helpers/context');
const Koa = require('../..');

describe('ctx.redirect(url)', () =&gt; {
  it('should redirect to the given url', () =&gt; {
    const ctx = context();
    ctx.redirect('http://google.com');
    assert.equal(ctx.response.header.location, 'http://google.com');
    assert.equal(ctx.status, 302);
  });

  it('should escape the url', () =&gt; {
    const ctx = context();
    let url = '&lt;script&gt;';
    ctx.header.accept = 'text/html';
    ctx.redirect(url);
    url = escape(url);
    assert.equal(ctx.response.header['content-type'], 'text/html; charset=utf-8');
    assert.equal(ctx.body, `Redirecting to &lt;a href="${url}"&gt;${url}&lt;/a&gt;.`);
  });
})

function escape(html){
  return String(html)
    .replace(/&amp;/g, '&amp;amp;')
    .replace(/"/g, '&amp;quot;')
    .replace(/&lt;/g, '&amp;lt;')
    .replace(/&gt;/g, '&amp;gt;');
}</code></pre>
            
            <p>Again, those are the simplest examples when the helpers don't take part in set up routines, for example starting a mock server. If they were, each test would be tied up to the test suite file's scope which would force us to place all test in the same file which is not very convenient for navigation and developer freedom. The previous example also adds the <span class="tm">escape</span> function at the bottom of the file, to be used by specs in there. But what if it was needed in other test suites, too? It would have to be put in the <span class="tm">helpers/context</span>, and that's exactly what <strong>Contexts</strong> are in <em>Zoroaster</em> &mdash; an official place for your testing utilities (we didn't see Koa's code before coming up with the name, it's an accident that their context is called in the same fashion as a testing context).</p>
            
            <p>This is a snippet from Goa's (our compiled Koa fork) context:</p>
            
            <pre id="ccdbf30"><code class="javascript hljs">import Cookies from '@contexts/http/cookies'
import { Duplex, Readable, Writable } from 'stream'
import Koa from '../../src'

export default class Context extends Cookies {
  /**
   * A mock context.
   * @param {http.IncomingMessage} [req]
   * @param {http.ServerResponse} [res]
   * @param {Koa} [app]
   */
  makeContext(req, res, app = new Koa()) {
    const socket = new Duplex()
    req = Object.assign({ headers: {}, socket }, Readable.prototype, req)
    res = Object.assign({ socket }, Writable.prototype, res)
    const _headers = {}
    req.socket.remoteAddress = req.socket.remoteAddress || '127.0.0.1'
    res.getHeader = k =&gt; _headers[k.toLowerCase()]
    res.getHeaders = () =&gt; _headers
    res.setHeader = (k, v) =&gt; _headers[k.toLowerCase()] = v
    res.removeHeader = (k) =&gt; delete _headers[k.toLowerCase()]
    return app.createContext(req, res)
  }
  /**
   * Returns an instance of a mock context.
   */
  get ctx() {
    return this.makeContext()
  }
  /**
   * Escapes HTML entities for &amp;, ", &lt; and &gt;.
   * @param {string} html
   */
  escape(html){
    return `${html}`
      .replace(/&amp;/g, '&amp;amp;')
      .replace(/"/g, '&amp;quot;')
      .replace(/&lt;/g, '&amp;lt;')
      .replace(/&gt;/g, '&amp;gt;')
  }
  /**
   * Pause runtime.
   * @param {number} time
   */
  sleep(time){
    return new Promise(resolve =&gt; setTimeout(resolve, time))
  }
}</code></pre>
            
            <p>Our context extends the <span class="tm">@contexts/http/cookies</span> class, that initialises a web-server when <span class="tm">startPlain</span> method is called and returns a tester instance for making requests to it and asserting on the results, <span class="tm">supertest</span> style. There's also a possibility set <em>PersistentContexts</em> that act as global <span class="tm2">before</span> and <span class="tm2">after</span> hooks, but practice shows that it takes only a few ms to start a server therefore it's OK to use a normal context. When <a
              href="https://github.com/art-deco/akashic.page/blob/3995c1be755de1ff6de665ee5afc7d1b7cce0c53/test/context/index.js#L7">
              integration-testing</a> larger apps and needing to run <a
              href="https://github.com/dpck/form/blob/aa9d5137ca5535e46d8c71056c03e81ab2ff4da7/test/context/RemoteChrome.js#L4">
              background processes</a>, like headless Chrome, we would definitely be able to use a persistent context. Persistent contexts are actually the best feature to illustrate advantages of context-testing, as they allow to move the setup and teardown logic into separate files, instead of rewriting it over and over again in the <span class="tm2">before</span> and <span class="tm2">after</span> hooks, or cramming all test suites in the same file.</p>
            
            <pre id="ccdbf20"><code class="javascript hljs">{
  context: Context,
  async 'sets status code'({ app, startPlain }) {
    app.use((ctx) =&gt; {
      ctx.status = 204
    })
    await startPlain(app.callback())
      .get('/')
      .assert(204)
  },
}</code></pre>
            
            <p>The additional advantage lies in the fact that we implement our own testing API on top of existing one. It is then from the context that specs access testing utilities, and what is more, we receive full <em>JSDoc</em> support for our context's API. Any number of contexts can be passed to test suites.</p>
            
            <p>
              <img class="b-vk b-bk b-t" alt="accessing goa context from tests" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='382'/%3E" data-io>
              <noscript>
                <img class="b-vk b-bk b-t" alt="accessing goa context from tests" src="/nodetools/pages/trapcss/5-testing/img/context.gif">
              </noscript>
            </p>
            
            <blockquote class="b-r">
              Context-testing decouples test cases from the testing infrastructure and allows to treat each test as a pure function that receives its inputs from arguments instead of file scope.
            </blockquote>
            
            <p>Of course, test cases are not 100% pure as we're still importing src within the test suite, but it's OK since we still want to be practical. It would be possible to import src from context, and make it available for access by test cases, in which case they <em>will</em> be 100% pure. This could let us to do cool stuff like hosting spec functions completely independently from the source code (e.g., as lambdas for longer integration testing routines that could then be run in parallel to complete a test suite in a matter of seconds), and even plugging in different versions of source code into tests. But these are more advanced concepts from Quality Assurance theory. For now it's enough to say that context-testing from <em>NodeTools</em> formalises the helper pattern and enables <em>JSDoc</em> access to testing API.</p>
            
            <p>This is our context for that spec:</p>
            
            <pre id="ccdbf21"><code class="javascript hljs">import { join } from 'path'
import { readFileSync } from 'fs'

/**
 * A testing context for the package.
 */
export default class Context {
  /**
   * A tagged template that returns the relative path
   * to the fixture.
   * @param {string} file
   * @example
   * fixture`input.txt` // -&gt; test/fixture/input.txt
   */
  fixture(file) {
    const f = file.raw[0]
    return join('test/fixture', f)
  }
  /**
   * Path to bootstrap.
   */
  get bootstrap() {
    return this.fixture`bootstrap.min.css`
  }
  /**
   * Read the file from the fs.
   * @param {string} path The path to read.
   */
  readFile(path) {
    return readFileSync(path, 'utf8')
  }
}</code></pre>
            
            <p>The testing interface and its implementation provide a method for synchronously reading files, a method to resolve paths to fixtures from the <strong>fixture</strong> directory, as well as the <strong>bootstrap</strong> property that resolves to the bootstrap path. We'll need to place some fixtures, such as <strong>bulma.min.css</strong> and <strong>surveillance.html</strong> into the <strong>fixtures</strong> folder so that they can be used in test. If we ever wanted to reuse bootstrap fixture, we'd simply destructure its path from the context, and read it if necessary. But if our package could, for example, accept a path to a CSS file instead of CSS as string, we'd already have everything we needed to test such feature. This makes us extremely productive and our QA experience very pleasant.</p>
            
            <p>The <a data-smooth href="#spec">
               spec <img alt="hand cursor" data-io>
             <noscript><img alt="hand cursor" src="/nodetools/pages/trapcss/img/hand.svg"></noscript></a> will read bulma and bootstrap, put them together, and use HTML from the prepared html file to pass to <em>TrapCSS</em>. The result is returned by the test, and when run for the first time, <em>Zoroaster</em> asks us if we want to save the snapshot. After it was saved, all further executions of the test will compare the output to the recorded one.</p>
            
            <p>
              <img class="b-vk b-bk b-t" alt="saving snapshot" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='643' height='666'/%3E" data-io>
              <noscript>
                <img class="b-vk b-bk b-t" alt="saving snapshot" src="/nodetools/pages/trapcss/5-testing/img/snapshot.gif">
              </noscript>
            </p>
            
            <p>We also used a service context from <em>Zoroaster</em> as our second context to change the format of the saved file to CSS. Instead of recording snapshots in JSON files, we write them to files with the extensions of the data format that they contain. This allows us to visually inspect our snapshots with syntax highlighting, which improves our <em>DevX</em> too.</p>
            
            <p>
              <img class="b-vk b-bk b-t" alt="error in snapshot recording" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='643' height='666'/%3E" data-io>
              <noscript>
                <img class="b-vk b-bk b-t" alt="error in snapshot recording" src="/nodetools/pages/trapcss/5-testing/img/snapshot-error.gif">
              </noscript>
            </p>
            
            <p>If at some point we changed our source code, and the output of the program changed, we'd be notified of it by <em>Zoroaster</em> with green/red highlighting on string differences too. We could then run tests in interactive mode as <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span>test</span> <span class="npm-cmd">--</span> <span>-i</span></span></span> (same as forks) to update snapshots from the CLI.</p>
            
            <p>In sum, there are following folders found in the <strong>test</strong> dir:</p>
            
            <ul>
              <li><strong>context</strong>: our helper methods implemented as a class for <em>JSDoc</em> access to methods.</li>
              <li><strong>fixture</strong>: any external files required for testing.</li>
              <li><strong>mask</strong>: test suites created with <em>makeTestSuite</em> from <span class="tm2">@zoroaster/mask</span> package that are constructed dynamically from input-output pairs.</li>
              <li><strong>result</strong>: test cases for masks that provide inputs and expected outputs, stored in any convenient file format that provides appropriate syntax highlighting.</li>
              <li><strong>snapshot</strong>: results returned by specs are saved here.</li>
              <li><strong>spec</strong>: atomic test cases nested within folders and thus organised by tests suites that make use of contexts.</li>
            </ul>
            
            </div>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='10'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/5.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="advanced-concepts">
            <h2>Advanced Concepts</h2>
            
            <p>Now that we've transferred the source code rewritten as ECMA modules, documented it with initial examples, designed the API via types in XML, and unit-tested our library with masks and snapshots, we can move on to discussing more serious concepts such as compilation, wikis and binary functionality in the next part of this tutorial. But first, let's <strike>take a selfie</strike> actually implement the logic that we needed for our package, that is, the comment preservation feature.</p>
            
            <p>In <em>DropCSS</em> all comments are stripped prior to parsing of the CSS file.</p>
            
            <pre id="ccdbf22"><code class="javascript hljs">// src/css.js
function parse(css) {
  // strip comments (for now)
  css = css.replace(COMMENTS, '');
  return tokenize(css);
}</code></pre>
            
            <p>We make a very simple change that allows to preserve the <strong>keepAlternate</strong> comment. After the change is made, we run <span class="Manager"> <span><span class="yarn-cmd">yarn </span><span class="npm-cmd">npm </span><span>test</span></span></span> to validate that all tests now pass, since we've already created a test case for <span class="tm">/* @alternate */</span> in masks in <abbr title="Test Driven Development"><em>TDD</em></abbr> fashion.</p>
            
            <pre id="ccdbf23"><code class="javascript hljs">export function parse(css, keepAlternate) {
  // strip comments (for now)
  css = css.replace(COMMENTS, keepAlternate ? (m) =&gt; {
    if (/^\s*\/\* @alternate \*\/\s*$/.test(m)) return m
    return ''
  } : '')
  return tokenize(css)
}</code></pre>
            
            <p>Whenever the second new attribute, <span class="tm">keepAlternate</span> is passed, instead of stripping all comments that it finds, our method will test if the comment is the <strong>alternate</strong> block comment using a regex, and keep it if required. Although this could potentially break the parser in places, because we had tests, we don't need to be afraid of side effects introduced by this change. The author of the original package mentioned that he doesn't like the fact that such feature would have negative impact on speed, however there's no impact at all if the second argument is actually not truthy. If my advice can be of any value, please don't concern yourself with micro-optimisations and imaginary split millisecond gains at times when humanity is starting to use quantum computers.</p>
            
            <p>If you need a feature, implement it regardless in what way without bothering with performance because our machines are made for computation so give them something to do. A new feature can branch out in unexpected ways and help you explore new ideas. But it's also true for when trying to overcome somebody's resistance to change, or bugs. Keep positive and treat any obstacle as a personal opportunity to create something amazing. Focus on yourself first and foremost, as you're programming for your own pleasure/business goals and don't need anyone else to tell you what is acceptable and not. You're in charge of your programs. <em>NodeTools</em> helps you remain the master of your work.</p>
            
            <a class="b-Af b-If" btn-large href="/nodetools/trapcss-2-advanced-nodetools.html">
              TrapCSS 2: Advanced NodeTools</a>
            
            <p class="SectionBreak">
              <a title="Back To Top" href="#top">
                <img alt="section break"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='10'/%3E" data-io>
                <noscript><img alt="section break" src="/nodetools/section-breaks/6.svg"></noscript></a>
            </p>
            </div>
            
            <div data-section id="comments">
            <h2>Comments</h2>
            
            <div id="c8b27">Loading comments...</div>
            
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="b-ns">
      &copy; <a href="https://www.artd.eco">Art Deco™</a>, 2020
    </footer>
    <script>(function(){function b(){if(0<c.length){var a=c.shift();a.src=a.getAttribute("data-src");a.removeAttribute("data-src");a.onload=b;a.onerror=function(){console.warn("Could not load script %s",a.src)}}}var c=Array.prototype.slice.call(document.querySelectorAll("script[data-src]"));b()})()</script>
  </body>
</html>